<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Clojure,Clojure For The Branve And True," />





  <link rel="alternate" href="/atom.xml" title="胡军的网络日志" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="&amp;#x672C;&amp;#x6587;&amp;#x662F;&amp;#x6211;&amp;#x5BF9;Clojure&amp;#x4E66;&amp;#x7C4D; CLOJURE FOR THE BRAVE AND TRUE&amp;#x7B2C;&amp;#x4E5D;&amp;#x7AE0;The Sacred Art of Concurrent and Parallel Programming &amp;#x505A;&amp;#x7684;&amp;#x7FFB;&amp;#x8">
<meta property="og:type" content="article">
<meta property="og:title" content="【译】第九章:并发与并行编程">
<meta property="og:url" content="http://yoursite.com/2016/07/15/braveclojure-concurrency/index.html">
<meta property="og:site_name" content="胡军的网络日志">
<meta property="og:description" content="&amp;#x672C;&amp;#x6587;&amp;#x662F;&amp;#x6211;&amp;#x5BF9;Clojure&amp;#x4E66;&amp;#x7C4D; CLOJURE FOR THE BRAVE AND TRUE&amp;#x7B2C;&amp;#x4E5D;&amp;#x7AE0;The Sacred Art of Concurrent and Parallel Programming &amp;#x505A;&amp;#x7684;&amp;#x7FFB;&amp;#x8">
<meta property="og:image" content="http://yoursite.com/2016/07/15/braveclojure-concurrency/9-1.png">
<meta property="og:image" content="http://yoursite.com/2016/07/15/braveclojure-concurrency/9-2.png">
<meta property="og:image" content="http://yoursite.com/2016/07/15/braveclojure-concurrency/9-3.png">
<meta property="og:image" content="http://yoursite.com/2016/07/15/braveclojure-concurrency/9-4.png">
<meta property="og:image" content="http://yoursite.com/2016/07/15/braveclojure-concurrency/9-5.png">
<meta property="og:image" content="http://yoursite.com/2016/07/15/braveclojure-concurrency/9-6.png">
<meta property="og:updated_time" content="2016-08-02T06:31:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【译】第九章:并发与并行编程">
<meta name="twitter:description" content="&amp;#x672C;&amp;#x6587;&amp;#x662F;&amp;#x6211;&amp;#x5BF9;Clojure&amp;#x4E66;&amp;#x7C4D; CLOJURE FOR THE BRAVE AND TRUE&amp;#x7B2C;&amp;#x4E5D;&amp;#x7AE0;The Sacred Art of Concurrent and Parallel Programming &amp;#x505A;&amp;#x7684;&amp;#x7FFB;&amp;#x8">
<meta name="twitter:image" content="http://yoursite.com/2016/07/15/braveclojure-concurrency/9-1.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 【译】第九章:并发与并行编程 | 胡军的网络日志 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">胡军的网络日志</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'wmG9FieA3KCB8x2CXpVc','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                【译】第九章:并发与并行编程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-15T22:37:55+08:00" content="2016-07-15">
              2016-07-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/15/braveclojure-concurrency/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/15/braveclojure-concurrency/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&#x672C;&#x6587;&#x662F;&#x6211;&#x5BF9;Clojure&#x4E66;&#x7C4D; <a href="http://www.braveclojure.com/clojure-for-the-brave-and-true/" target="_blank" rel="external">CLOJURE FOR THE BRAVE AND TRUE</a>&#x7B2C;&#x4E5D;&#x7AE0;<a href="http://www.braveclojure.com/concurrency/" target="_blank" rel="external">The Sacred Art of Concurrent and Parallel Programming</a> &#x505A;&#x7684;&#x7FFB;&#x8BD1;&#x3002;&#x7FFB;&#x8BD1;&#x5F62;&#x5F0F;&#xFF0C;&#x4E2D;&#x82F1;&#x5BF9;&#x7167;&#xFF0C;&#x82F1;&#x6587;&#x5F15;&#x7528;&#x8DDF;&#x7740;&#x4E2D;&#x6587;&#x7FFB;&#x8BD1;&#x3002;&#x5982;&#x6709;&#x9519;&#x8BEF;&#xFF0C;&#x5728;&#x6240;&#x96BE;&#x514D;&#xFF0C;&#x6B22;&#x8FCE;&#x6307;&#x6B63;&#x3002;</p>
<p><a href="https://morrxy.github.io/tags/Clojure-For-The-Branve-And-True/" target="_blank" rel="external">&#x5176;&#x4ED6;&#x7AE0;&#x7684;&#x7FFB;&#x8BD1;&#x5728;&#x8FD9;&#x91CC;</a></p>
<p>&#x8BD1;&#x6587;&#x5F00;&#x59CB;&#x3002;</p>
<hr>
<blockquote>
<p>If I were the lord of a manor and you were my heir, I would sit you down on your 13th name day and tell you, &#x201C;The world of computing is changing, lass, and ye must be prepared for the new world of multi-core processors lest ye be trampled by it.</p>
<p>&#x201C;Listen well: In recent years, CPU clock speeds have barely increased, but dual-core and quad-core computers have become common. The laws of physics are cruel and absolute, and they demand that increasing clock speed requires exponentially more power. The realm&#x2019;s best engineers are unlikely to overcome this limitation anytime soon, if ever. Therefore, you can expect the trend of increasing cores on a single machine to continue&#x2014;as will the expectation that you as a programmer will know how to make the most of modern hardware.</p>
<p>&#x201C;Learning to program in this new paradigm will be fun and fascinating, verily. But beware: it is also fraught with peril. You must learn <em>concurrent and parallel programming</em>, which is the sacred art of structuring your application to safely manage multiple, simultaneously executing tasks.</p>
<p>&#x201C;You begin your instruction in this art with an overview of concurrency and parallelism concepts. You&#x2019;ll then study the three goblins that harry every practitioner: reference cells, mutual exclusion, and dwarven berserkers. And you&#x2019;ll learn three tools that will aid you: futures, promises, and delays.&#x201D;</p>
<p>And then I&#x2019;d tap you on the shoulder with a keyboard, signaling that you were ready to begin.</p>
</blockquote>
<p>&#x8FD9;&#x7AE0;&#x5148;&#x8BB2;&#x5E76;&#x53D1;&#x4E0E;&#x5E76;&#x884C;&#x7684;&#x6982;&#x5FF5;&#x3002;&#x7136;&#x540E;&#x5B66;&#x4E60;&#x6BCF;&#x4E2A;&#x4ECE;&#x4E1A;&#x8005;&#x90FD;&#x4F1A;&#x9047;&#x5230;&#x7684;&#x4E09;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x5F15;&#x7528;&#x5355;&#x5143;(reference cells),&#x4E92;&#x65A5;(mutual exclusion),&#x77EE;&#x4EBA;&#x72C2;&#x66B4;&#x8005;&#x95EE;&#x9898;(dwarven berserkers)&#x3002;&#x7136;&#x540E;&#x5B66;&#x4E60;&#x4E09;&#x4E2A;&#x8F85;&#x52A9;&#x5DE5;&#x5177;&#xFF1A;&#x672A;&#x6765;(futures),&#x627F;&#x8BFA;(promises),&#x5EF6;&#x671F;(delays)&#x3002;</p>
<blockquote>
<p>Concurrency and Parallelism Concepts</p>
</blockquote>
<h2 id="&#x5E76;&#x53D1;&#x4E0E;&#x5E76;&#x884C;&#x6982;&#x5FF5;"><a href="#&#x5E76;&#x53D1;&#x4E0E;&#x5E76;&#x884C;&#x6982;&#x5FF5;" class="headerlink" title="&#x5E76;&#x53D1;&#x4E0E;&#x5E76;&#x884C;&#x6982;&#x5FF5;"></a>&#x5E76;&#x53D1;&#x4E0E;&#x5E76;&#x884C;&#x6982;&#x5FF5;</h2><blockquote>
<p>Concurrent and parallel programming involves a lot of messy details at all levels of program execution, from the hardware to the operating system to programming language libraries to the code that springs from your heart and lands in your editor. But before you worry your head with any of those details, in this section I&#x2019;ll walk through the high-level concepts that surround concurrency and parallelism.</p>
</blockquote>
<p>&#x5E76;&#x53D1;&#x4E0E;&#x5E76;&#x884C;&#x7F16;&#x7A0B;&#x5728;&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x7684;&#x6240;&#x6709;&#x5C42;&#x6B21;&#x4E0A;&#x90FD;&#x6D89;&#x53CA;&#x5927;&#x91CF;&#x4E71;&#x4E03;&#x516B;&#x7CDF;&#x7684;&#x7EC6;&#x8282;&#xFF1A;&#x4ECE;&#x786C;&#x4EF6;&#x5230;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#xFF0C;&#x5230;&#x7F16;&#x7A0B;&#x8BED;&#x8A00;&#x5E93;&#xFF0C;&#x5230;&#x4F60;&#x7F16;&#x5199;&#x4EE3;&#x7801;&#x3002;&#x5728;&#x8003;&#x8651;&#x8FD9;&#x4E9B;&#x7EC6;&#x8282;&#x524D;&#xFF0C;&#x5148;&#x9886;&#x7565;&#x4E00;&#x4E0B;&#x5E76;&#x53D1;&#x4E0E;&#x5E76;&#x884C;&#x7684;&#x9AD8;&#x5C42;&#x6B21;&#x6982;&#x5FF5;&#x3002;</p>
<blockquote>
<p>Managing Multiple Tasks vs. Executing Tasks Simultaneously</p>
</blockquote>
<h3 id="&#x7BA1;&#x7406;&#x591A;&#x4EFB;&#x52A1;&#x4E0E;&#x540C;&#x65F6;&#x6267;&#x884C;&#x591A;&#x4EFB;&#x52A1;"><a href="#&#x7BA1;&#x7406;&#x591A;&#x4EFB;&#x52A1;&#x4E0E;&#x540C;&#x65F6;&#x6267;&#x884C;&#x591A;&#x4EFB;&#x52A1;" class="headerlink" title="&#x7BA1;&#x7406;&#x591A;&#x4EFB;&#x52A1;&#x4E0E;&#x540C;&#x65F6;&#x6267;&#x884C;&#x591A;&#x4EFB;&#x52A1;"></a>&#x7BA1;&#x7406;&#x591A;&#x4EFB;&#x52A1;&#x4E0E;&#x540C;&#x65F6;&#x6267;&#x884C;&#x591A;&#x4EFB;&#x52A1;</h3><blockquote>
<p><em>Concurrency</em> refers to managing more than one task at the same time. <em>Task</em> just means &#x201C;something that needs to get done,&#x201D; and it doesn&#x2019;t imply anything regarding implementation in your hardware or software. We can illustrate concurrency with the song &#x201C;Telephone&#x201D; by Lady Gaga. Gaga sings,<br>I will put down this drink to text you, then put my phone away and continue drinking, eh</p>
</blockquote>
<p><em>&#x5E76;&#x53D1;</em> &#x6307;&#x540C;&#x65F6;&#x7BA1;&#x7406;&#x8D85;&#x8FC7;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#x3002;<em>&#x4EFB;&#x52A1;</em> &#x6307;&#x201C;&#x9700;&#x8981;&#x5B8C;&#x6210;&#x7684;&#x4E8B;&#x60C5;&#x201D;&#xFF0C;&#x5B83;&#x4E0D;&#x610F;&#x5473;&#x7740;&#x4EFB;&#x4F55;&#x8F6F;&#x4EF6;&#x6216;&#x786C;&#x4EF6;&#x7684;&#x76F8;&#x5173;&#x5B9E;&#x73B0;&#x3002;&#x6211;&#x4EEC;&#x7528;Lady Gaga&#x7684;&#x6B4C;&#x201C;Telephone&#x201D;&#x6F14;&#x793A;&#x5E76;&#x53D1;&#x3002;&#x5979;&#x5531;&#x5230;&#xFF1A;</p>
<p>&#x6211;&#x5C06;&#x653E;&#x4E0B;&#x996E;&#x6599;&#xFF0C;&#x7ED9;&#x4F60;&#x53D1;&#x77ED;&#x4FE1;&#xFF0C;&#x7136;&#x540E;&#x653E;&#x4E0B;&#x7535;&#x8BDD;&#xFF0C;&#x7EE7;&#x7EED;&#x559D;&#x996E;&#x6599;&#x3002;</p>
<blockquote>
<p>In this hypothetical universe, Lady Gaga is managing two tasks: drinking and texting. However, she is not executing both tasks at the same time. Instead, she&#x2019;s switching between the two, or <em>interleaving</em>. Note that, while interleaving, you don&#x2019;t have to fully complete a task before switching: Gaga could type one word, put down her phone, pick up her drink and take a sip, and then switch back to her phone and type another word.</p>
</blockquote>
<p>&#x5728;&#x8FD9;&#x4E2A;&#x5047;&#x60F3;&#x7684;&#x4E16;&#x754C;&#x91CC;&#xFF0C;Lady Gaga&#x6B63;&#x5728;&#x7BA1;&#x7406;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#xFF1A;&#x559D;&#x996E;&#x6599;&#x548C;&#x53D1;&#x77ED;&#x4FE1;&#x3002;&#x4F46;&#x5979;&#x4E0D;&#x662F;&#x540C;&#x65F6;&#x6267;&#x884C;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#x3002;&#x800C;&#x662F;&#x5728;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#x95F4;&#x5207;&#x6362;&#x6216; <em>&#x4EA4;&#x66FF;</em>&#x3002;&#x6CE8;&#x610F;&#xFF0C;&#x4EA4;&#x66FF;&#x8FDB;&#x884C;&#x65F6;&#xFF0C;&#x5207;&#x6362;&#x524D;&#x4E0D;&#x5FC5;&#x5B8C;&#x5168;&#x5B8C;&#x6210;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#xFF1A;Gaga&#x53EF;&#x4EE5;&#x8F93;&#x5165;&#x4E00;&#x4E2A;&#x5355;&#x8BCD;&#xFF0C;&#x653E;&#x4E0B;&#x7535;&#x8BDD;&#xFF0C;&#x62FF;&#x8D77;&#x996E;&#x6599;&#x559D;&#x4E00;&#x53E3;&#xFF0C;&#x7136;&#x540E;&#x62FF;&#x8D77;&#x7535;&#x8BDD;&#x8F93;&#x5165;&#x53E6;&#x4E00;&#x4E2A;&#x5355;&#x8BCD;&#x3002;</p>
<blockquote>
<p><em>Parallelism</em> refers to executing more than one task at the same time. If Madame Gaga were to execute her two tasks in parallel, she would sing,</p>
<p>I can text you with one hand while I use the other to drink, eh</p>
</blockquote>
<p><em>&#x5E76;&#x884C;</em> &#x6307;&#x540C;&#x65F6;&#x6267;&#x884C;&#x8D85;&#x8FC7;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#x3002;&#x5982;&#x679C;Gaga&#x5E76;&#x884C;&#x6267;&#x884C;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#xFF0C;&#x5979;&#x5C06;&#x5531;&#x5230;&#xFF1A;</p>
<p>&#x6211;&#x80FD;&#x7528;&#x4E00;&#x53EA;&#x624B;&#x53D1;&#x77ED;&#x4FE1;&#xFF0C;&#x540C;&#x65F6;&#x7528;&#x53E6;&#x4E00;&#x53EA;&#x624B;&#x559D;&#x996E;&#x6599;&#x3002;</p>
<blockquote>
<p>Parallelism is a subclass of concurrency: before you execute multiple tasks simultaneously, you first have to manage multiple tasks.</p>
</blockquote>
<p>&#x5E76;&#x884C;&#x662F;&#x5E76;&#x53D1;&#x7684;&#x4E00;&#x4E2A;&#x5B50;&#x7C7B;&#xFF1A;&#x540C;&#x65F6;&#x6267;&#x884C;&#x591A;&#x4E2A;&#x4EFB;&#x52A1;&#x4E4B;&#x524D;&#xFF0C;&#x5FC5;&#x987B;&#x7BA1;&#x7406;&#x591A;&#x4E2A;&#x4EFB;&#x52A1;&#x3002;</p>
<blockquote>
<p>Clojure has many features that allow you to achieve parallelism easily. While the Lady Gaga system achieves parallelism by simultaneously executing tasks on multiple hands, computer systems generally achieve parallelism by simultaneously executing tasks on multiple processors.</p>
</blockquote>
<p>Clojure&#x6709;&#x5F88;&#x591A;&#x7279;&#x6027;&#xFF0C;&#x8BA9;&#x4F60;&#x5BB9;&#x6613;&#x5730;&#x5B9E;&#x73B0;&#x5E76;&#x884C;&#x3002;Lady Gaga&#x5728;&#x4E24;&#x53EA;&#x624B;&#x4E0A;&#x540C;&#x65F6;&#x6267;&#x884C;&#x4E24;&#x4E2A;&#x4EFB;&#x52A1;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x4E86;&#x5E76;&#x884C;&#x3002;&#x4E0E;&#x6B64;&#x76F8;&#x6BD4;&#xFF0C;&#x8BA1;&#x7B97;&#x673A;&#x7CFB;&#x7EDF;&#x5B9E;&#x73B0;&#x5E76;&#x884C;&#x7684;&#x65B9;&#x6CD5;&#x901A;&#x5E38;&#x662F;&#xFF1A;&#x5728;&#x591A;&#x4E2A;&#x5904;&#x7406;&#x5668;&#x540C;&#x65F6;&#x6267;&#x884C;&#x591A;&#x4E2A;&#x4EFB;&#x52A1;&#x3002;</p>
<blockquote>
<p>It&#x2019;s important to distinguish parallelism from distribution. Distributed computing is a special version of parallel computing where the processors are in different computers and tasks are distributed to computers over a network. It&#x2019;d be like Lady Gaga asking Beyonc&#xE9;, &#x201C;Please text this guy while I drink.&#x201D; Although you can do distributed programming in Clojure with the aid of libraries, this book covers only parallel programming, and here I&#x2019;ll use <em>parallel</em> to refer only to cohabiting processors. If you&#x2019;re interested in distributed programming, check out Kyle Kingsbury&#x2019;s Call Me Maybe series at <a href="https://aphyr.com/" target="_blank" rel="external">https://aphyr.com/</a>.</p>
</blockquote>
<p>&#x533A;&#x5206;&#x5E76;&#x884C;&#x4E0E;&#x5206;&#x5E03;&#x5F0F;&#x8BA1;&#x7B97;&#x5F88;&#x91CD;&#x8981;&#x3002;&#x5206;&#x5E03;&#x5F0F;&#x8BA1;&#x7B97;&#x662F;&#x5E76;&#x884C;&#x8BA1;&#x7B97;&#x7684;&#x7279;&#x6B8A;&#x7248;&#x672C;&#xFF0C;&#x5206;&#x5E03;&#x5F0F;&#x8BA1;&#x7B97;&#x7684;&#x5904;&#x7406;&#x5668;&#x5904;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#x4E2D;&#xFF0C;&#x5E76;&#x4E14;&#x4EFB;&#x52A1;&#x88AB;&#x5206;&#x914D;&#x5230;&#x7F51;&#x7EDC;&#x4E0A;&#x4E0D;&#x540C;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#x4E0A;&#x3002;&#x5C31;&#x50CF;Lady Gaga&#x8BF7;&#x6C42;Beyonc&#xE9;&#xFF0C;&#x201C;&#x6211;&#x559D;&#x996E;&#x6599;&#x65F6;&#x5019;&#xFF0C;&#x8BF7;&#x7ED9;&#x8FD9;&#x4E2A;&#x4EBA;&#x53D1;&#x77ED;&#x4FE1;&#x201D;&#x3002;&#x867D;&#x7136;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5E93;&#x5728;Clojure&#x4E2D;&#x8FDB;&#x884C;&#x5206;&#x5E03;&#x5F0F;&#x7F16;&#x7A0B;&#xFF0C;&#x672C;&#x4E66;&#x53EA;&#x8986;&#x76D6;&#x5E76;&#x884C;&#x7F16;&#x7A0B;&#xFF0C;&#x5E76;&#x4E14; <em>&#x5E76;&#x884C;</em> &#x53EA;&#x7528;&#x6765;&#x6307;&#x540C;&#x4E00;&#x53F0;&#x8BA1;&#x7B97;&#x673A;&#x5185;&#x7684;&#x5904;&#x7406;&#x5668;&#x3002;&#x5982;&#x679C;&#x4F60;&#x5BF9;&#x5206;&#x5E03;&#x5F0F;&#x7F16;&#x7A0B;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x53EF;&#x4EE5;&#x53BB;&#x770B; <a href="https://aphyr.com/" target="_blank" rel="external">https://aphyr.com/</a> &#x3002;</p>
<blockquote>
<p>Blocking and Asynchronous Tasks</p>
</blockquote>
<h3 id="&#x963B;&#x585E;&#x4E0E;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;"><a href="#&#x963B;&#x585E;&#x4E0E;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;" class="headerlink" title="&#x963B;&#x585E;&#x4E0E;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;"></a>&#x963B;&#x585E;&#x4E0E;&#x5F02;&#x6B65;&#x4EFB;&#x52A1;</h3><blockquote>
<p>One of the major use cases for concurrent programming is for blocking operations. Blocking really just means waiting for an operation to finish. You&#x2019;ll most often hear it used in relation to I/O operations, like reading a file or waiting for an HTTP request to finish. Let&#x2019;s examine this using the concurrent Lady Gaga example.</p>
</blockquote>
<p>&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x7684;&#x4E00;&#x4E2A;&#x4E3B;&#x8981;&#x4F7F;&#x7528;&#x573A;&#x5408;&#x662F;&#x7528;&#x4E8E;&#x963B;&#x585E;&#x64CD;&#x4F5C;&#x3002;&#x963B;&#x585E;&#x7684;&#x610F;&#x601D;&#x662F;&#x7B49;&#x5F85;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x5B8C;&#x6210;&#x3002;&#x5728;I/O&#x76F8;&#x5173;&#x64CD;&#x4F5C;&#x4E2D;&#xFF0C;&#x6BD4;&#x5982;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;&#x6216;&#x7B49;&#x5F85;HTTP&#x8BF7;&#x6C42;&#x5B8C;&#x6210;&#xFF0C;&#x7ECF;&#x5E38;&#x542C;&#x8BF4;&#x963B;&#x585E;&#x64CD;&#x4F5C;&#x3002;&#x7528;&#x5E76;&#x884C;Lady Gaga&#x4E3E;&#x4F8B;&#x3002;</p>
<blockquote>
<p>If Lady Gaga texts her interlocutor and then stands there with her phone in her hand, staring at the screen for a response and not drinking, then you would say that the <em>read next text message</em> operation is blocking and that these tasks are executing <em>synchronously</em>.</p>
</blockquote>
<p>&#x5982;&#x679C;Lady Gaga&#x53D1;&#x77ED;&#x4FE1;&#x7ED9;&#x5BF9;&#x8BDD;&#x8005;&#xFF0C;&#x7136;&#x540E;&#x7AD9;&#x5728;&#x90A3;&#xFF0C;&#x624B;&#x91CC;&#x62FF;&#x7740;&#x624B;&#x673A;&#xFF0C;&#x76EF;&#x7740;&#x5C4F;&#x5E55;&#x7B49;&#x54CD;&#x5E94;&#xFF0C;&#x4E0D;&#x559D;&#x996E;&#x6599;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x5E94;&#x8BE5;&#x8BF4; <em>&#x8BFB;&#x4E0B;&#x4E00;&#x6761;&#x77ED;&#x4FE1;</em> &#x64CD;&#x4F5C;&#x662F;&#x963B;&#x585E;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x8FD9;&#x4E2A;&#x4EFB;&#x52A1;&#x662F; <em>&#x540C;&#x6B65;</em> &#x6267;&#x884C;&#x7684;&#x3002;</p>
<blockquote>
<p>If, instead, she tucks her phone away so she can drink until it alerts her by beeping or vibrating, then the <em>read next text message</em> task is not blocking and you would say she&#x2019;s handling the task <em>asynchronously</em>.</p>
</blockquote>
<p>&#x76F8;&#x53CD;&#xFF0C;&#x5982;&#x679C;&#x4E3A;&#x4E86;&#x80FD;&#x559D;&#x996E;&#x6599;&#xFF0C;&#x5979;&#x628A;&#x624B;&#x673A;&#x653E;&#x5728;&#x4E00;&#x8FB9;&#xFF0C;&#x76F4;&#x5230;&#x624B;&#x673A;&#x54CD;&#x94C3;&#x6216;&#x9707;&#x52A8;&#x63D0;&#x9192;&#x5979;&#x3002;&#x90A3;&#x4E48; <em>&#x8BFB;&#x4E0B;&#x4E00;&#x6761;&#x77ED;&#x4FE1;</em> &#x4EFB;&#x52A1;&#x662F;&#x975E;&#x963B;&#x585E;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x8FD9;&#x4E2A;&#x4EFB;&#x52A1;&#x662F; <em>&#x5F02;&#x6B65;</em> &#x5904;&#x7406;&#x7684;&#x3002;</p>
<blockquote>
<p>Concurrent Programming and Parallel Programming</p>
</blockquote>
<h3 id="&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x4E0E;&#x5E76;&#x884C;&#x7F16;&#x7A0B;"><a href="#&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x4E0E;&#x5E76;&#x884C;&#x7F16;&#x7A0B;" class="headerlink" title="&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x4E0E;&#x5E76;&#x884C;&#x7F16;&#x7A0B;"></a>&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x4E0E;&#x5E76;&#x884C;&#x7F16;&#x7A0B;</h3><blockquote>
<p>Concurrent programming and parallel programming refer to techniques for decomposing a task into subtasks that can execute in parallel and managing the risks that arise when your program executes more than one task at the same time. For the rest of the chapter, I&#x2019;ll use the two terms interchangeably because the risks are pretty much the same for both.</p>
</blockquote>
<p>&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x4E0E;&#x5E76;&#x884C;&#x7F16;&#x7A0B;&#x6307;&#x4EFB;&#x52A1;&#x5206;&#x89E3;&#x6280;&#x672F;(&#x628A;&#x4EFB;&#x52A1;&#x5206;&#x89E3;&#x6210;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x6267;&#x884C;&#x7684;&#x5B50;&#x4EFB;&#x52A1;)&#xFF0C;&#x548C;&#x7BA1;&#x7406;&#x98CE;&#x9669;&#x6280;&#x672F;(&#x540C;&#x65F6;&#x6267;&#x884C;&#x591A;&#x4E2A;&#x4EFB;&#x52A1;&#x65F6;&#x51FA;&#x73B0;&#x7684;&#x98CE;&#x9669;)&#x3002;&#x672C;&#x7AE0;&#x7684;&#x5269;&#x4F59;&#x90E8;&#x5206;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x5C5E;&#x4E8E;&#x53EF;&#x4EE5;&#x4EA4;&#x6362;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x4F7F;&#x7528;&#x4ED6;&#x4EEC;&#x7684;&#x98CE;&#x9669;&#x51E0;&#x4E4E;&#x4E00;&#x6837;&#x3002;</p>
<blockquote>
<p>To better understand those risks and how Clojure helps you avoid them, let&#x2019;s examine how concurrency and parallelism are implemented in Clojure.</p>
</blockquote>
<p>&#x4E3A;&#x4E86;&#x66F4;&#x597D;&#x7406;&#x89E3;&#x8FD9;&#x4E9B;&#x98CE;&#x9669;&#x548C;Clojure&#x5982;&#x4F55;&#x5E2E;&#x52A9;&#x4F60;&#x907F;&#x514D;&#x8FD9;&#x4E9B;&#x98CE;&#x9669;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x770B;&#x770B;Clojure&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x5E76;&#x53D1;&#x4E0E;&#x5E76;&#x884C;&#x3002;</p>
<blockquote>
<p>Clojure Implementation: JVM Threads</p>
</blockquote>
<h2 id="Clojure&#x5B9E;&#x73B0;&#xFF1A;JVM&#x7EBF;&#x7A0B;"><a href="#Clojure&#x5B9E;&#x73B0;&#xFF1A;JVM&#x7EBF;&#x7A0B;" class="headerlink" title="Clojure&#x5B9E;&#x73B0;&#xFF1A;JVM&#x7EBF;&#x7A0B;"></a>Clojure&#x5B9E;&#x73B0;&#xFF1A;JVM&#x7EBF;&#x7A0B;</h2><blockquote>
<p>I&#x2019;ve been using the term task in an abstract sense to refer to a series of related operations without regard for how a computer might implement the task concept. For example, texting is a task that consists of a series of related operations that are totally separate from the operations involved in pouring a drink into your face.</p>
</blockquote>
<p>&#x5230;&#x73B0;&#x5728;&#x4E3A;&#x6B62;&#xFF0C;&#x6211;&#x4E00;&#x76F4;&#x5728;&#x4EE5;&#x4E00;&#x79CD;&#x62BD;&#x8C61;&#x7684;&#x65B9;&#x5F0F;&#x4F7F;&#x7528;&#x4EFB;&#x52A1;&#x8FD9;&#x4E2A;&#x8BCD;&#xFF0C;&#x4EFB;&#x52A1;&#x662F;&#x6307;&#x4E00;&#x7CFB;&#x5217;&#x76F8;&#x5173;&#x64CD;&#x4F5C;&#xFF0C;&#x4E0E;&#x8BA1;&#x7B97;&#x673A;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x4EFB;&#x52A1;&#x65E0;&#x5173;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x53D1;&#x77ED;&#x4FE1;&#x662F;&#x4E00;&#x4E2A;&#x7531;&#x4E00;&#x7CFB;&#x5217;&#x76F8;&#x5173;&#x64CD;&#x4F5C;&#x6784;&#x6210;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x8FD9;&#x4E9B;&#x64CD;&#x4F5C;&#x4E0E;&#x559D;&#x996E;&#x6599;&#x7684;&#x90A3;&#x4E9B;&#x64CD;&#x4F5C;&#x5B8C;&#x5168;&#x5206;&#x5F00;&#x3002;</p>
<blockquote>
<p>In Clojure, you can think of your normal, <em>serial</em> code as a sequence of tasks. You indicate that tasks can be performed concurrently by placing them on JVM <em>threads</em>.</p>
</blockquote>
<p>&#x5728;Clojure&#x91CC;&#xFF0C;&#x53EF;&#x4EE5;&#x628A;&#x8FDE;&#x7EED;&#x7684;&#x4EE3;&#x7801;&#x5F53;&#x6210;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x4EFB;&#x52A1;&#x3002;&#x901A;&#x8FC7;&#x628A;&#x4ED6;&#x4EEC;&#x653E;&#x5728;JVM&#x7EBF;&#x7A0B;&#x91CC;&#xFF0C;&#x8868;&#x660E;&#x8FD9;&#x4E9B;&#x4EFB;&#x52A1;&#x53EF;&#x4EE5;&#x5E76;&#x53D1;&#x6267;&#x884C;&#x3002;</p>
<blockquote>
<p>What&#x2019;s a Thread?</p>
</blockquote>
<h3 id="&#x4EC0;&#x4E48;&#x662F;&#x7EBF;&#x7A0B;&#xFF1F;"><a href="#&#x4EC0;&#x4E48;&#x662F;&#x7EBF;&#x7A0B;&#xFF1F;" class="headerlink" title="&#x4EC0;&#x4E48;&#x662F;&#x7EBF;&#x7A0B;&#xFF1F;"></a>&#x4EC0;&#x4E48;&#x662F;&#x7EBF;&#x7A0B;&#xFF1F;</h3><blockquote>
<p>I&#x2019;m glad you asked! A thread is a subprogram. A program can have many threads, and each thread executes its own set of instructions while enjoying shared access to the program&#x2019;s state.</p>
</blockquote>
<p>&#x5F88;&#x9AD8;&#x5174;&#x4F60;&#x95EE;&#x8FD9;&#x4E2A;&#xFF01;&#x7EBF;&#x7A0B;&#x662F;&#x5B50;&#x7A0B;&#x5E8F;&#x3002;&#x4E00;&#x4E2A;&#x7A0B;&#x5E8F;&#x80FD;&#x6709;&#x5F88;&#x591A;&#x7EBF;&#x7A0B;&#xFF0C;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x81EA;&#x5DF1;&#x7684;&#x6307;&#x4EE4;&#x96C6;&#xFF0C;&#x540C;&#x65F6;&#x62E5;&#x6709;&#x5BF9;&#x7A0B;&#x5E8F;&#x72B6;&#x6001;&#x5171;&#x540C;&#x7684;&#x8BBF;&#x95EE;&#x6743;&#x3002;</p>
<blockquote>
<p>Thread management functionality can exist at multiple levels in a computer. For example, the operating system kernel typically provides system calls to create and manage threads. The JVM provides its own platform-independent thread management functionality, and since Clojure programs run in the JVM, they use JVM threads. You&#x2019;ll learn more about the JVM in Chapter 12.</p>
</blockquote>
<p>&#x8BA1;&#x7B97;&#x673A;&#x7684;&#x5F88;&#x591A;&#x5C42;&#x6B21;&#x90FD;&#x6709;&#x7EBF;&#x7A0B;&#x7BA1;&#x7406;&#x529F;&#x80FD;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5185;&#x6838;&#x901A;&#x5E38;&#x63D0;&#x4F9B;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7528;&#x6765;&#x521B;&#x5EFA;&#x548C;&#x7BA1;&#x7406;&#x7EBF;&#x7A0B;&#x3002;JVM&#x63D0;&#x4F9B;&#x81EA;&#x5DF1;&#x7684;&#x72EC;&#x7ACB;&#x4E8E;&#x5E73;&#x53F0;&#x7684;&#x7EBF;&#x7A0B;&#x7BA1;&#x7406;&#x529F;&#x80FD;&#xFF0C;&#x7531;&#x4E8E;Clojure&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x5728;JVM&#x91CC;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;&#x7EBF;&#x7A0B;&#x3002;</p>
<blockquote>
<p>You can think of a thread as an actual, physical piece of thread that strings together a sequence of instructions. In my mind, the instructions are marshmallows, because marshmallows are delicious. The processor executes these instructions in order. I picture this as an alligator consuming the instructions, because alligators love marsh&#xAD;mallows (true fact!). So executing a program looks like a bunch of marshmallows strung out on a line with an alligator traveling down the line and eating them one by one. Figure 9-1 shows this model for a single-core processor executing a single-threaded program.</p>
</blockquote>
<p>&#x53EF;&#x4EE5;&#x628A;&#x7EBF;&#x7A0B;&#x60F3;&#x8C61;&#x6210;&#x4E00;&#x6839;&#x771F;&#x6B63;&#x7684;&#x7EBF;&#xFF0C;&#x628A;&#x4E00;&#x7CFB;&#x5217;&#x6307;&#x4EE4;&#x4E32;&#x4E86;&#x8D77;&#x6765;&#x3002;&#x5728;&#x6211;&#x7684;&#x8111;&#x6D77;&#x91CC;&#xFF0C;&#x8FD9;&#x4E9B;&#x6307;&#x4EE4;&#x662F;&#x8F6F;&#x7CD6;&#xFF0C;&#x56E0;&#x4E3A;&#x8F6F;&#x7CD6;&#x5F88;&#x7F8E;&#x5473;&#x3002;&#x5904;&#x7406;&#x5668;&#x6309;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x8FD9;&#x4E9B;&#x6307;&#x4EE4;&#x3002;&#x5C31;&#x50CF;&#x4E00;&#x4E2A;&#x9CC4;&#x9C7C;&#x6328;&#x4E2A;&#x5403;&#x6389;&#x4E32;&#x6210;&#x4E00;&#x4E32;&#x7684;&#x8F6F;&#x7CD6;&#x4E00;&#x6837;&#x3002;&#x56FE;9-1&#x663E;&#x793A;&#x4E86;&#x8FD9;&#x4E2A;&#x5355;&#x6838;&#x5904;&#x7406;&#x5668;&#x6267;&#x884C;&#x5355;&#x4E00;&#x7EBF;&#x7A0B;&#x7684;&#x7A0B;&#x5E8F;&#x7684;&#x6A21;&#x578B;&#x3002;</p>
<p>&#x56FE;9-1<br><img src="/2016/07/15/braveclojure-concurrency/9-1.png" alt="9-1"></p>
<blockquote>
<p>A thread can <em>spawn</em> a new thread to execute tasks concurrently. In a single-processor system, the processor switches back and forth between the threads (interleaving). Here&#x2019;s where potential concurrency issues get introduced. Although the processor executes the instructions on each thread in order, it makes no guarantees about when it will switch back and forth between threads.</p>
</blockquote>
<p>&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x80FD; <em>&#x751F;&#x4EA7;</em> &#x4E00;&#x4E2A;&#x65B0;&#x7EBF;&#x7A0B;&#x7528;&#x4E8E;&#x5E76;&#x884C;&#x6267;&#x884C;&#x4EFB;&#x52A1;&#x3002;&#x5728;&#x5355;&#x5904;&#x7406;&#x5668;&#x7684;&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x5904;&#x7406;&#x5668;&#x5728;&#x7EBF;&#x7A0B;&#x4E2D;&#x6765;&#x56DE;&#x5207;&#x6362;&#x3002;&#x6F5C;&#x5728;&#x7684;&#x5E76;&#x884C;&#x95EE;&#x9898;&#x7531;&#x6B64;&#x4EA7;&#x751F;&#x3002;&#x5C3D;&#x7BA1;&#x5904;&#x7406;&#x5668;&#x6309;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x4E0A;&#x7684;&#x6307;&#x4EE4;&#xFF0C;&#x4F46;&#x4E0D;&#x4FDD;&#x8BC1;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x8FDB;&#x884C;&#x5207;&#x6362;&#x3002;</p>
<blockquote>
<p>Figure 9-2 shows an illustration of two threads, A and B, and a timeline of how their instructions could be executed. I&#x2019;ve shaded the instructions on thread B to help distinguish them from the instructions on thread A.</p>
</blockquote>
<p>&#x56FE;9-2&#x6F14;&#x793A;&#x4E86;&#x4E24;&#x4E2A;&#x8FDB;&#x7A0B;&#xFF0C;A&#x548C;B&#xFF0C;&#x548C;&#x4E00;&#x4E2A;&#x53EF;&#x80FD;&#x7684;&#x6307;&#x4EE4;&#x6267;&#x884C;&#x65F6;&#x95F4;&#x7EBF;&#x3002;&#x7EBF;&#x7A0B;B&#x7684;&#x6307;&#x4EE4;&#x753B;&#x4E0A;&#x4E86;&#x9634;&#x5F71;&#x4EE5;&#x4FBF;&#x4E0E;A&#x533A;&#x5206;&#x3002;</p>
<p>&#x56FE;9-2<br><img src="/2016/07/15/braveclojure-concurrency/9-2.png" alt="&#x56FE;9-2"></p>
<blockquote>
<p>Note that this is just one possible order of instruction execution. The processor could also have executed the instructions in the order A1, A2, A3, B1, A4, B2, B3 for example. This makes the program <em>nondeterministic</em>. You can&#x2019;t know beforehand what the result will be because you can&#x2019;t know the execution order, and different execution orders can yield different results.</p>
</blockquote>
<p>&#x6CE8;&#x610F;&#xFF0C;&#x8FD9;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x53EF;&#x80FD;&#x7684;&#x6307;&#x4EE4;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5904;&#x7406;&#x5668;&#x4E5F;&#x53EF;&#x80FD;&#x6309;&#x7167;&#xFF0C;A1, A2, A3, B1, A4, B2, B3&#xFF0C;&#x7684;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x8FD9;&#x4E9B;&#x6307;&#x4EE4;&#x3002;&#x8FD9;&#x4F7F;&#x7A0B;&#x5E8F;&#x53D8;&#x5F97; <em>&#x4E0D;&#x786E;&#x5B9A;</em> &#x3002;&#x56E0;&#x4E3A;&#x4E0D;&#x80FD;&#x786E;&#x5B9A;&#x6267;&#x884C;&#x987A;&#x5E8F;&#xFF0C;&#x6240;&#x4EE5;&#x65E0;&#x6CD5;&#x9884;&#x5148;&#x77E5;&#x9053;&#x7ED3;&#x679C;&#xFF0C;&#x5E76;&#x4E14;&#x4E0D;&#x540C;&#x7684;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x53EF;&#x80FD;&#x4EA7;&#x751F;&#x4E0D;&#x540C;&#x7684;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x3002;</p>
<blockquote>
<p>This example shows concurrent execution on a single processor through interleaving, whereas a multi-core system assigns a thread to each core, allowing the computer to execute more than one thread simultaneously. Each core executes its thread&#x2019;s instructions in order, as shown in Figure 9-3.</p>
</blockquote>
<p>&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x6F14;&#x793A;&#x4E86;&#x5355;&#x6838;&#x7CFB;&#x7EDF;&#x901A;&#x8FC7;&#x7A7F;&#x63D2;&#x5B9E;&#x73B0;&#x5E76;&#x53D1;&#x6267;&#x884C;&#x3002;&#x800C;&#x591A;&#x6838;&#x7CFB;&#x7EDF;&#x628A;&#x7EBF;&#x7A0B;&#x5206;&#x914D;&#x5230;&#x6BCF;&#x4E2A;&#x5904;&#x7406;&#x5668;&#x4E0A;&#x4F7F;&#x8BA1;&#x7B97;&#x673A;&#x80FD;&#x540C;&#x65F6;&#x6267;&#x884C;&#x591A;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x6BCF;&#x4E2A;&#x5904;&#x7406;&#x5668;&#x6309;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x7EBF;&#x7A0B;&#x6307;&#x4EE4;&#x3002;&#x5982;&#x56FE;9-3</p>
<p>&#x56FE;9-3<br><img src="/2016/07/15/braveclojure-concurrency/9-3.png" alt="9-3"></p>
<blockquote>
<p>As with interleaving on a single core, there are no guarantees for the overall execution order, so the program is nondeterministic. When you add a second thread to a program, it becomes nondeterministic, and this makes it possible for your program to fall prey to three kinds of problems.</p>
</blockquote>
<p>&#x540C;&#x5355;&#x6838;&#x4E0A;&#x7A7F;&#x63D2;&#x6267;&#x884C;&#x4E00;&#x6837;&#xFF0C;&#x6574;&#x4F53;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x4E0D;&#x80FD;&#x786E;&#x5B9A;&#xFF0C;&#x6240;&#x4EE5;&#x7A0B;&#x5E8F;&#x662F;&#x4E0D;&#x786E;&#x5B9A;&#x7684;&#x3002;&#x5F53;&#x5F80;&#x7A0B;&#x5E8F;&#x91CC;&#x52A0;&#x5165;&#x7B2C;&#x4E8C;&#x4E2A;&#x7EBF;&#x7A0B;&#x65F6;&#x5019;&#xFF0C;&#x7A0B;&#x5E8F;&#x53D8;&#x7684;&#x4E0D;&#x786E;&#x5B9A;&#x4E86;&#xFF0C;&#x4F7F;&#x7A0B;&#x5E8F;&#x5BB9;&#x6613;&#x53D7;&#x5230;&#x4E09;&#x7C7B;&#x95EE;&#x9898;&#x7684;&#x5F71;&#x54CD;&#x3002;</p>
<blockquote>
<p>The Three Goblins: Reference Cells, Mutual Exclusion, and Dwarven Berserkers</p>
</blockquote>
<h3 id="&#x4E09;&#x53EA;&#x54E5;&#x5E03;&#x6797;&#xFF1A;&#x5F15;&#x7528;&#x5355;&#x5143;&#xFF0C;&#x4E92;&#x65A5;&#xFF0C;&#x77EE;&#x4EBA;&#x72C2;&#x66B4;&#x8005;"><a href="#&#x4E09;&#x53EA;&#x54E5;&#x5E03;&#x6797;&#xFF1A;&#x5F15;&#x7528;&#x5355;&#x5143;&#xFF0C;&#x4E92;&#x65A5;&#xFF0C;&#x77EE;&#x4EBA;&#x72C2;&#x66B4;&#x8005;" class="headerlink" title="&#x4E09;&#x53EA;&#x54E5;&#x5E03;&#x6797;&#xFF1A;&#x5F15;&#x7528;&#x5355;&#x5143;&#xFF0C;&#x4E92;&#x65A5;&#xFF0C;&#x77EE;&#x4EBA;&#x72C2;&#x66B4;&#x8005;"></a>&#x4E09;&#x53EA;&#x54E5;&#x5E03;&#x6797;&#xFF1A;&#x5F15;&#x7528;&#x5355;&#x5143;&#xFF0C;&#x4E92;&#x65A5;&#xFF0C;&#x77EE;&#x4EBA;&#x72C2;&#x66B4;&#x8005;</h3><blockquote>
<p>There are three central challenges in concurrent programming, also known as the <em>The Three Concurrency Goblins</em>. To see why these are scary, imagine that the program in the image in Figure 9-3 includes the pseudo&#xAD;instructions in Table 9-1.</p>
</blockquote>
<p>&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x4E2D;&#x6709;&#x4E09;&#x4E2A;&#x4E3B;&#x8981;&#x6311;&#x6218;&#xFF0C;&#x4E5F;&#x53EB; <em>&#x4E09;&#x53EA;&#x5E76;&#x53D1;&#x54E5;&#x5E03;&#x6797;</em> &#x3002;&#x4E3A;&#x4E86;&#x8BF4;&#x660E;&#x5176;&#x4EE4;&#x4EBA;&#x56F0;&#x6270;&#x4E4B;&#x5904;&#xFF0C;&#x5047;&#x8BBE;&#x56FE;9-3&#x5305;&#x542B;&#x8868;9-1&#x7684;&#x4F2A;&#x6307;&#x4EE4;&#xFF1A;</p>
<p>&#x8868;9-1</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>instruction</th>
</tr>
</thead>
<tbody>
<tr>
<td>A1</td>
<td>WRITE X = 0</td>
</tr>
<tr>
<td>A2</td>
<td>READ X</td>
</tr>
<tr>
<td>A3</td>
<td>WRITE X = X + 1</td>
</tr>
<tr>
<td>B1</td>
<td>READ X</td>
</tr>
<tr>
<td>B2</td>
<td>WRITE X = X + 1</td>
</tr>
</tbody>
</table>
<blockquote>
<p>If the processor follows the order A1, A2, A3, B1, B2, then <code>X</code> will have a value of <code>2</code>, as you&#x2019;d expect. But if it follows the order A1, A2, B1, A3, B2, <code>X</code>&#x2019;s value will be <code>1</code>, as you can see in Figure 9-4.</p>
</blockquote>
<p>&#x5982;&#x679C;&#x5904;&#x7406;&#x7684;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x662F;:A1, A2, A3, B1, B2,&#x90A3;&#x4E48;<code>x</code>&#x7684;&#x503C;&#x5C06;&#x662F;<code>2</code>,&#x5982;&#x4F60;&#x6240;&#x613F;&#x3002;&#x4F46;&#x5982;&#x679C;&#x987A;&#x5E8F;&#x662F;:A1, A2, B1, A3, B2,<code>x</code>&#x7684;&#x503C;&#x5C06;&#x662F;<code>1</code>,&#x5982;&#x56FE;9-4&#x6240;&#x793A;&#x3002;</p>
<p>&#x56FE;9-4 &#x4E24;&#x4E2A;&#x8FDB;&#x7A0B;&#x4E0E;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x5355;&#x5143;&#x4EA4;&#x4E92;<br><img src="/2016/07/15/braveclojure-concurrency/9-4.png" alt="9-4"></p>
<blockquote>
<p>We&#x2019;ll call this the <em>reference cell</em> problem (the first Concurrency Goblin). The reference cell problem occurs when two threads can read and write to the same location, and the value at the location depends on the order of the reads and writes.</p>
</blockquote>
<p>&#x6211;&#x4EEC;&#x7BA1;&#x8FD9;&#x4E2A;&#x53EB; <em>&#x5F15;&#x7528;&#x5355;&#x5143;</em> &#x95EE;&#x9898;(&#x7B2C;&#x4E00;&#x4E2A;&#x5E76;&#x53D1;&#x54E5;&#x5E03;&#x6797;)&#x3002;&#x5F15;&#x7528;&#x5355;&#x5143;&#x95EE;&#x9898;&#x53D1;&#x751F;&#x5728;&#xFF1A;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#x80FD;&#x8BFB;&#x5199;&#x540C;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;&#xFF0C;&#x90A3;&#x4E2A;&#x4F4D;&#x7F6E;&#x7684;&#x503C;&#x53D6;&#x51B3;&#x4E8E;&#x8BFB;&#x5199;&#x987A;&#x5E8F;&#x3002;</p>
<blockquote>
<p>The second Concurrency Goblin is mutual exclusion. Imagine two threads, each trying to write a spell to a file. Without any way to claim exclusive write access to the file, the spell will end up garbled because the write instructions will be interleaved. Consider the following two spells:</p>
</blockquote>
<p>&#x7B2C;&#x4E8C;&#x4E2A;&#x5E76;&#x53D1;&#x54E5;&#x5E03;&#x6797;&#x662F;&#x4E92;&#x65A5;&#x3002;&#x5047;&#x8BBE;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#x90FD;&#x5C1D;&#x8BD5;&#x5411;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5199;&#x5165;&#x5185;&#x5BB9;&#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x6587;&#x4EF6;&#x7684;&#x72EC;&#x5360;&#x5199;&#x6743;&#x9650;&#xFF0C;&#x7531;&#x4E8E;&#x5199;&#x6307;&#x4EE4;&#x7A7F;&#x63D2;&#x6267;&#x884C;&#xFF0C;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x5C06;&#x662F;&#x6DF7;&#x4E71;&#x7684;&#x3002;&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x4E24;&#x6BB5;&#x6587;&#x5B57;&#xFF1A;</p>
<blockquote>
<p>By the power invested in me<br>by the state of California,<br>I now pronounce you man and wife</p>
<p>Thunder, lightning, wind, and rain,<br>a delicious sandwich, I summon again</p>
<p>If you write these to a file without mutual exclusion, you could end up with this:</p>
</blockquote>
<p>&#x5982;&#x679C;&#x4E0D;&#x5E26;&#x4E92;&#x65A5;&#x5730;&#x5199;&#x5165;&#xFF0C;&#x6700;&#x7EC8;&#x53EF;&#x80FD;&#x5F97;&#x5230;&#x8FD9;&#x4E2A;&#xFF1A;</p>
<blockquote>
<p>By the power invested in me<br>by Thunder, lightning, wind, and rain,<br>the state of California,<br>I now pronounce you a delicious man sandwich, and wife<br>I summon again</p>
<p>The third Concurrency Goblin is what I&#x2019;ll call the dwarven berserker problem (aka deadlock). Imagine four berserkers sitting around a rough-hewn, circular wooden table comforting each other. &#x201C;I know I&#x2019;m distant toward my children, but I just don&#x2019;t know how to communicate with them,&#x201D; one growls. The rest sip their coffee and nod knowingly, care lines creasing their eye places.</p>
</blockquote>
<p>&#x7B2C;&#x4E09;&#x4E2A;&#x5E76;&#x53D1;&#x54E5;&#x5E03;&#x6797;&#x662F;&#x77EE;&#x4EBA;&#x72C2;&#x66B4;&#x8005;&#x95EE;&#x9898;(&#x5373;&#x6B7B;&#x9501;)&#x3002;&#x60F3;&#x8C61;&#x4E00;&#x4E0B;&#x56DB;&#x4E2A;&#x72C2;&#x66B4;&#x8005;&#x56F4;&#x7740;&#x4E00;&#x4E2A;&#x6728;&#x5934;&#x684C;&#x5B50;&#x804A;&#x5929;&#x3002;</p>
<blockquote>
<p>Now, as everyone knows, the dwarven berserker ritual for ending a comforting coffee klatch is to pick up their &#x201C;comfort sticks&#x201D; (double-bladed war axes) and scratch each other&#x2019;s backs. One war axe is placed between each pair of dwarves, as shown in Figure 9-5.</p>
</blockquote>
<p>&#x6BCF;&#x5BF9;&#x77EE;&#x4EBA;&#x4E4B;&#x95F4;&#x90FD;&#x653E;&#x6709;&#x4E00;&#x628A;&#x65A7;&#x5934;&#x3002;&#x5982;&#x56FE;9-5</p>
<p>&#x56FE;9-5<br><img src="/2016/07/15/braveclojure-concurrency/9-5.png" alt="&#x56FE;9-5"></p>
<blockquote>
<p>Their ritual proceeds thusly:</p>
<ol>
<li>Pick up the left war axe, when available.</li>
<li>Pick up the right war axe, when available.</li>
<li>Comfort your neighbor with vigorous swings of your &#x201C;comfort sticks.&#x201D;</li>
<li>Release both war axes.</li>
<li>Repeat.</li>
</ol>
</blockquote>
<p>&#x4EEA;&#x5F0F;&#x7684;&#x8FC7;&#x7A0B;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p>
<ol>
<li>&#x53EF;&#x7528;&#x65F6;&#xFF0C;&#x62FF;&#x8D77;&#x5DE6;&#x8FB9;&#x7684;&#x6218;&#x65A7;&#x3002;</li>
<li>&#x53EF;&#x7528;&#x65F6;&#xFF0C;&#x62FF;&#x8D77;&#x53F3;&#x8FB9;&#x7684;&#x6218;&#x65A7;&#x3002;</li>
<li>&#x7528;&#x5B83;&#x4EEC;&#x7ED9;&#x90BB;&#x5C45;&#x6320;&#x75D2;&#x75D2;&#x3002;</li>
<li>&#x653E;&#x4E0B;&#x4E24;&#x628A;&#x65A7;&#x5934;&#x3002;</li>
<li>&#x91CD;&#x590D;&#x3002;</li>
</ol>
<blockquote>
<p>Following this ritual, it&#x2019;s entirely possible that all the dwarven berserkers will pick up their left comfort stick and then block indefinitely while waiting for the comfort stick to their right to become available, resulting in deadlock. (By the way, if you want to look into this phenomenon further, it&#x2019;s usually referred to as the dining philosophers problem, but that&#x2019;s a more boring scenario.) This book doesn&#x2019;t discuss deadlock in much detail, but it&#x2019;s good to know the concept and its terminology.</p>
</blockquote>
<p>&#x6309;&#x7167;&#x8FD9;&#x4E2A;&#x4EEA;&#x5F0F;&#xFF0C;&#x5B8C;&#x5168;&#x6709;&#x53EF;&#x80FD;&#x6240;&#x6709;&#x77EE;&#x4EBA;&#x90FD;&#x4E3E;&#x7740;&#x5DE6;&#x624B;&#x65A7;&#x5934;&#xFF0C;&#x7136;&#x540E;&#x7B49;&#x7740;&#x53F3;&#x8FB9;&#x7684;&#x65A7;&#x5934;&#xFF0C;&#x9677;&#x5165;&#x65E0;&#x9650;&#x7B49;&#x5F85;&#xFF0C;&#x5BFC;&#x81F4;&#x6B7B;&#x9501;&#x3002;(&#x987A;&#x4FBF;&#x63D0;&#x4E00;&#x4E0B;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x60F3;&#x8FDB;&#x4E00;&#x6B65;&#x7814;&#x7A76;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x901A;&#x5E38;&#x53EB;&#x8FDB;&#x9910;&#x7684;&#x54F2;&#x5B66;&#x5BB6;&#x95EE;&#x9898;)&#x3002;&#x672C;&#x4E66;&#x4E0D;&#x5BF9;&#x6B7B;&#x9501;&#x8FDB;&#x884C;&#x7EC6;&#x8282;&#x8BA8;&#x8BBA;&#xFF0C;&#x4F46;&#x77E5;&#x9053;&#x6982;&#x5FF5;&#x548C;&#x672F;&#x8BED;&#x662F;&#x4EF6;&#x597D;&#x4E8B;&#x3002;</p>
<blockquote>
<p>Concurrent programming has its goblins, but with the right tools, it&#x2019;s manageable and even fun. Let&#x2019;s start looking at the right tools.</p>
</blockquote>
<p>&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x6709;&#x8FD9;&#x4E9B;&#x54E5;&#x5E03;&#x6797;&#xFF0C;&#x4F46;&#x7528;&#x6B63;&#x786E;&#x7684;&#x5DE5;&#x5177;&#xFF0C;&#x4ED6;&#x4EEC;&#x662F;&#x53EF;&#x7BA1;&#x7406;&#xFF0C;&#x751A;&#x81F3;&#x6709;&#x8DA3;&#x7684;&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x5F00;&#x59CB;&#x67E5;&#x770B;&#x8FD9;&#x4E9B;&#x6B63;&#x786E;&#x7684;&#x5DE5;&#x5177;&#x3002;</p>
<blockquote>
<p>Futures, Delays, and Promises</p>
</blockquote>
<h2 id="&#x672A;&#x6765;-future-&#xFF0C;&#x5EF6;&#x671F;-delay-&#x548C;&#x627F;&#x8BFA;-promise"><a href="#&#x672A;&#x6765;-future-&#xFF0C;&#x5EF6;&#x671F;-delay-&#x548C;&#x627F;&#x8BFA;-promise" class="headerlink" title="&#x672A;&#x6765;(future)&#xFF0C;&#x5EF6;&#x671F;(delay)&#x548C;&#x627F;&#x8BFA;(promise)"></a>&#x672A;&#x6765;(future)&#xFF0C;&#x5EF6;&#x671F;(delay)&#x548C;&#x627F;&#x8BFA;(promise)</h2><blockquote>
<p>Futures, delays, and promises are easy, lightweight tools for concurrent programming. In this section, you&#x2019;ll learn how each one works and how to use them together to defend against the reference cell Concurrency Goblin and the mutual exclusion Concurrency Goblin. You&#x2019;ll discover that, although simple, these tools go a long way toward meeting your concurrency needs.</p>
</blockquote>
<p>&#x672A;&#x6765;&#xFF0C;&#x5EF6;&#x671F;&#x548C;&#x627F;&#x8BFA;&#x662F;&#x7B80;&#x5355;&#x8F7B;&#x91CF;&#x7684;&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x5DE5;&#x5177;&#x3002;&#x8FD9;&#x8282;&#x91CC;&#xFF0C;&#x4F60;&#x5C06;&#x4E86;&#x89E3;&#x4ED6;&#x4EEC;&#x662F;&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#x7684;&#xFF0C;&#x5E76;&#x5B66;&#x4E60;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x4ED6;&#x4EEC;&#x9632;&#x6B62;&#x5F15;&#x7528;&#x5355;&#x5143;&#x95EE;&#x9898;&#x548C;&#x4E92;&#x65A5;&#x95EE;&#x9898;&#x3002;&#x4F60;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x8FD9;&#x4E9B;&#x5DE5;&#x5177;&#x867D;&#x7136;&#x7B80;&#x5355;&#xFF0C;&#x4F46;&#x5BF9;&#x4F60;&#x7684;&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x6709;&#x5F88;&#x5927;&#x5E2E;&#x52A9;&#x3002;</p>
<blockquote>
<p>They do this by giving you more flexibility than is possible with serial code. When you write serial code, you bind together these three events:</p>
</blockquote>
<p>&#x76F8;&#x6BD4;&#x8FDE;&#x7EED;&#x4EE3;&#x7801;&#xFF0C;&#x4ED6;&#x4EEC;&#x4E3A;&#x4F60;&#x63D0;&#x4F9B;&#x4E86;&#x66F4;&#x5927;&#x7684;&#x7075;&#x6D3B;&#x6027;&#x3002;&#x5199;&#x8FDE;&#x7EED;&#x4EE3;&#x7801;&#x65F6;&#x5019;&#xFF0C;&#x628A;&#x8FD9;&#x4E09;&#x4E2A;&#x4E8B;&#x4EF6;&#x7ED1;&#x5B9A;&#x5728;&#x4E00;&#x8D77;&#x4E86;&#xFF1A;</p>
<blockquote>
<ol>
<li>Task definition</li>
<li>Task execution</li>
<li>Requiring the task&#x2019;s result</li>
</ol>
</blockquote>
<ol>
<li>&#x4EFB;&#x52A1;&#x5B9A;&#x4E49;</li>
<li>&#x4EFB;&#x52A1;&#x6267;&#x884C;</li>
<li>&#x8BF7;&#x6C42;&#x4EFB;&#x52A1;&#x7ED3;&#x679C;</li>
</ol>
<blockquote>
<p>As an example, look at this hypothetical code, which defines a simple API call task:</p>
</blockquote>
<p>&#x4F5C;&#x4E3A;&#x4F8B;&#x5B50;&#xFF0C;&#x770B;&#x4E0B;&#x8FD9;&#x4E2A;&#x5047;&#x5B9A;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;API&#x8C03;&#x7528;&#x4EFB;&#x52A1;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">web-api/get</span> <span class="symbol">:dwarven-beard-waxes</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>As soon as Clojure encounters this task definition, it executes it. It also requires the result right now, blocking until the API call finishes. Part of learning concurrent programming is learning to identify when these chronological couplings aren&#x2019;t necessary. Futures, delays, and promises allow you to separate task definition, task execution, and requiring the result. Onward!</p>
</blockquote>
<p>&#x4E00;&#x65E6;Clojure&#x9047;&#x5230;&#x8FD9;&#x4E2A;&#x4EFB;&#x52A1;&#x5B9A;&#x4E49;&#xFF0C;&#x5C31;&#x4F1A;&#x6267;&#x884C;&#xFF0C;&#x5E76;&#x7ACB;&#x523B;&#x8BF7;&#x6C42;&#x7ED3;&#x679C;&#xFF0C;&#x4E00;&#x76F4;&#x7B49;&#x5F85;&#x76F4;&#x5230;API&#x8C03;&#x7528;&#x5B8C;&#x6210;&#x3002;&#x5B66;&#x4E60;&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x9700;&#x8981;&#x5B66;&#x4F1A;&#x8BC6;&#x522B;&#x8FD9;&#x4E9B;&#x65F6;&#x95F4;&#x4E0A;&#x7684;&#x85D5;&#x5408;&#x4F55;&#x65F6;&#x4E0D;&#x662F;&#x5FC5;&#x987B;&#x7684;&#x3002;&#x672A;&#x6765;&#xFF0C;&#x5EF6;&#x671F;&#x548C;&#x627F;&#x8BFA;&#x8BA9;&#x4F60;&#x80FD;&#x5206;&#x79BB;&#x4EFB;&#x52A1;&#x5B9A;&#x4E49;&#xFF0C;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#xFF0C;&#x548C;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x3002;</p>
<blockquote>
<p>Futures</p>
</blockquote>
<h3 id="&#x672A;&#x6765;"><a href="#&#x672A;&#x6765;" class="headerlink" title="&#x672A;&#x6765;"></a>&#x672A;&#x6765;</h3><blockquote>
<p>In Clojure, you can use futures to define a task and place it on another thread without requiring the result immediately. You can create a <code>future</code> with the future macro. Try this in a REPL:</p>
</blockquote>
<p>&#x5728;Clojure&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x672A;&#x6765;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#xFF0C;&#x5E76;&#x4E14;&#x628A;&#x5B83;&#x653E;&#x8FDB;&#x53E6;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x4E0D;&#x7528;&#x9A6C;&#x4E0A;&#x8BF7;&#x6C42;&#x7ED3;&#x679C;&#x3002;&#x7528;<code>future</code>&#x5B8F;&#x5EFA;&#x7ACB;&#x672A;&#x6765;&#x3002;&#x5728;REPL&#x91CC;&#x8BD5;&#x4E00;&#x4E0B;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">future</span></span> (<span class="name">Thread/sleep</span> <span class="number">4000</span>)</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;I&apos;ll print after 4 seconds&quot;</span>))</span><br><span class="line">(<span class="name">println</span> <span class="string">&quot;I&apos;ll print immediately&quot;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>Thread/sleep</code> tells the current thread to just sit on its bum and do nothing for the specified number of milliseconds. Normally, if you evaluated <code>Thread/sleep</code> in your REPL, you wouldn&#x2019;t be able to evaluate any other statements until the REPL was done sleeping; the thread executing your REPL would be blocked. However, <code>future</code> creates a new thread and places each expression you pass it on the new thread, including <code>Thread/sleep</code>, allowing the REPL&#x2019;s thread to continue, unblocked.</p>
</blockquote>
<p><code>Thread/sleep</code>&#x544A;&#x8BC9;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x5728;&#x6307;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#x5185;&#x4EC0;&#x4E48;&#x90FD;&#x4E0D;&#x5E72;&#x3002;&#x901A;&#x5E38;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x5728;&#x4F60;&#x7684;REPL&#x91CC;&#x6267;&#x884C;<code>Thread/sleep</code>,&#x4F60;&#x5C06;&#x65E0;&#x6CD5;&#x6C42;&#x503C;&#x4EFB;&#x4F55;&#x5176;&#x4ED6;&#x8BED;&#x53E5;&#xFF0C;sleep&#x7ED3;&#x675F;&#x524D;&#x4F60;&#x7684;REPL&#x90FD;&#x5C06;&#x5904;&#x4E8E;&#x963B;&#x585E;&#x72B6;&#x6001;&#x3002;&#x4F46;<code>future</code>&#x65B0;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x628A;&#x4F20;&#x7ED9;future&#x7684;&#x6BCF;&#x4E2A;&#x8868;&#x8FBE;&#x5F0F;&#x90FD;&#x653E;&#x5728;&#x65B0;&#x7EBF;&#x7A0B;&#x4E0A;&#xFF0C;&#x5305;&#x62EC;<code>Thread/sleep</code>,&#x8FD9;&#x4F7F;&#x4F60;&#x7684;REPL&#x7EBF;&#x7A0B;&#x7EE7;&#x7EED;&#xFF0C;&#x4FDD;&#x6301;&#x975E;&#x963B;&#x585E;&#x3002;</p>
<blockquote>
<p>You can use futures to run tasks on a separate thread and then forget about them, but often you&#x2019;ll want to use the result of the task. The <code>future</code> function returns a reference value that you can use to request the result. The reference is like the ticket that a dry cleaner gives you: at any time you can use it to request your clean dress, but if your dress isn&#x2019;t clean yet, you&#x2019;ll have to wait. Similarly, you can use the reference value to request a future&#x2019;s result, but if the future isn&#x2019;t done computing the result, you&#x2019;ll have to wait.</p>
</blockquote>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x7528;&#x672A;&#x6765;&#x628A;&#x4EFB;&#x52A1;&#x653E;&#x5728;&#x72EC;&#x7ACB;&#x7684;&#x7EBF;&#x7A0B;&#x4E0A;&#x8FD0;&#x884C;&#xFF0C;&#x7136;&#x540E;&#x4E0D;&#x518D;&#x7BA1;&#x5B83;&#xFF0C;&#x4F46;&#x4F60;&#x7ECF;&#x5E38;&#x9700;&#x8981;&#x4EFB;&#x52A1;&#x8FD0;&#x884C;&#x7684;&#x7ED3;&#x679C;&#x3002;<code>future</code>&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x7528;&#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#x8BF7;&#x6C42;&#x7ED3;&#x679C;&#x3002;&#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#x5C31;&#x50CF;&#x5E72;&#x6D17;&#x5E97;&#x5458;&#x53D1;&#x7ED9;&#x4F60;&#x7684;&#x7968;&#x636E;&#xFF1A;&#x4EFB;&#x4F55;&#x65F6;&#x5019;&#x4F60;&#x90FD;&#x53EF;&#x4EE5;&#x7528;&#x5B83;&#x6765;&#x53D6;&#x56DE;&#x4F60;&#x7684;&#x5E72;&#x51C0;&#x8863;&#x670D;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x8863;&#x670D;&#x8FD8;&#x6CA1;&#x6D17;&#x597D;&#xFF0C;&#x4F60;&#x5FC5;&#x987B;&#x7B49;&#x5F85;&#x3002;&#x7C7B;&#x4F3C;&#x5730;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x7528;&#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#x503C;&#x6765;&#x8BF7;&#x6C42;&#x672A;&#x6765;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x672A;&#x6765;&#x8FD8;&#x6CA1;&#x8BA1;&#x7B97;&#x51FA;&#x7ED3;&#x679C;&#xFF0C;&#x4F60;&#x5FC5;&#x987B;&#x7B49;&#x5F85;&#x3002;</p>
<blockquote>
<p>Requesting a future&#x2019;s result is called dereferencing the future, and you do it with either the <code>deref</code> function or the <code>@</code> reader macro. A future&#x2019;s result value is the value of the last expression evaluated in its body. A future&#x2019;s body executes only once, and its value gets cached. Try the following:</p>
</blockquote>
<p>&#x8BF7;&#x6C42;&#x4E00;&#x4E2A;&#x672A;&#x6765;&#x7684;&#x7ED3;&#x679C;&#x53EB;&#x505A;&#x5BF9;&#x672A;&#x6765;&#x53D6;&#x503C;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;<code>defef</code>&#x51FD;&#x6570;&#x6216;<code>@</code>&#x8BFB;&#x53D6;&#x5B8F;&#x53D6;&#x503C;&#x3002;&#x672A;&#x6765;&#x7684;&#x7ED3;&#x679C;&#x7684;&#x503C;&#xFF0C;&#x662F;&#x5176;&#x4E3B;&#x4F53;&#x91CC;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x503C;&#x3002;&#x4E00;&#x4E2A;&#x672A;&#x6765;&#x7684;&#x4E3B;&#x4F53;&#x53EA;&#x6267;&#x884C;&#x4E00;&#x6B21;&#xFF0C;&#x5176;&#x7ED3;&#x679C;&#x88AB;&#x7F13;&#x5B58;&#x3002;&#x8BD5;&#x8BD5;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [result (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">println</span> <span class="string">&quot;this prints once&quot;</span>)</span><br><span class="line">                     (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> <span class="number">1</span>))]</span><br><span class="line">  (<span class="name">println</span> <span class="string">&quot;deref: &quot;</span> (<span class="name"><span class="builtin-name">deref</span></span> result))</span><br><span class="line">  (<span class="name">println</span> <span class="string">&quot;@: &quot;</span> @result))</span><br><span class="line"><span class="comment">; =&gt; &quot;this prints once&quot;</span></span><br><span class="line"><span class="comment">; =&gt; deref: 2</span></span><br><span class="line"><span class="comment">; =&gt; @: 2</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notice that the string <code>&quot;this prints once&quot;</code> indeed prints only once, even though you dereference the future twice. This shows that the future&#x2019;s body ran only once and the result, <code>2</code>, got cached.</p>
</blockquote>
<p>&#x6CE8;&#x610F;&#x5B57;&#x7B26;&#x4E32;<code>&quot;this prints once&quot;</code>&#x786E;&#x5B9E;&#x53EA;&#x6253;&#x5370;&#x4E86;&#x4E00;&#x6B21;&#xFF0C;&#x5373;&#x4F7F;&#x4F60;&#x53D6;&#x503C;&#x4E86;&#x4E24;&#x6B21;&#x3002;&#x8FD9;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;&#x672A;&#x6765;&#x7684;&#x4E3B;&#x4F53;&#x53EA;&#x8FD0;&#x884C;&#x4E86;&#x4E00;&#x6B21;&#xFF0C;&#x5E76;&#x4E14;&#x7ED3;&#x679C;,<code>2</code>&#x88AB;&#x7F13;&#x5B58;&#x4E86;&#x3002;</p>
<blockquote>
<p>Dereferencing a future will block if the future hasn&#x2019;t finished running, like so:</p>
</blockquote>
<p>&#x53D6;&#x503C;&#x4E00;&#x4E2A;&#x672A;&#x8FD0;&#x884C;&#x5B8C;&#x6210;&#x7684;&#x672A;&#x6765;&#x4F1A;&#x963B;&#x585E;&#xFF0C;&#x50CF;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [result (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">Thread/sleep</span> <span class="number">3000</span>)</span><br><span class="line">                     (<span class="name"><span class="builtin-name">+</span></span> <span class="number">1</span> <span class="number">1</span>))]</span><br><span class="line">  (<span class="name">println</span> <span class="string">&quot;The result is: &quot;</span> @result)</span><br><span class="line">  (<span class="name">println</span> <span class="string">&quot;It will be at least 3 seconds before I print&quot;</span>))</span><br><span class="line"><span class="comment">; =&gt; The result is: 2</span></span><br><span class="line"><span class="comment">; =&gt; It will be at least 3 seconds before I print</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Sometimes you want to place a time limit on how long to wait for a future. To do that, you can pass <code>deref</code> a number of milliseconds to wait along with the value to return if the <code>deref</code> times out:</p>
</blockquote>
<p>&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x65F6;&#x95F4;&#x9650;&#x5236;&#xFF0C;&#x9650;&#x5236;&#x7B49;&#x5F85;&#x4E00;&#x4E2A;&#x672A;&#x6765;&#x7684;&#x65F6;&#x95F4;&#x4E0A;&#x9650;&#x3002;&#x7ED9;<code>defef</code>&#x4F20;&#x4E00;&#x4E2A;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#x548C;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x503C;&#x5373;&#x53EF;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">deref</span></span> (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">Thread/sleep</span> <span class="number">1000</span>) <span class="number">0</span>) <span class="number">10</span> <span class="number">5</span>)</span><br><span class="line"><span class="comment">; =&gt; 5</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>This code tells <code>deref</code> to return the value <code>5</code> if the future doesn&#x2019;t return a value within 10 milliseconds.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x4EE3;&#x7801;&#x4E3A;<code>defef</code>&#x8BBE;&#x7F6E;&#x4E86;10&#x6BEB;&#x79D2;&#x7684;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#xFF0C;&#x548C;<code>5</code>&#xFF0C;&#x4F5C;&#x4E3A;&#x5230;&#x671F;&#x8FD4;&#x56DE;&#x503C;&#x3002;</p>
<blockquote>
<p>Finally, you can interrogate a future using <code>realized?</code> to see if it&#x2019;s done running:</p>
</blockquote>
<p>&#x6700;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;<code>realized?</code>&#x67E5;&#x8BE2;&#x4E00;&#x4E2A;&#x672A;&#x6765;&#x662F;&#x5426;&#x8FD0;&#x884C;&#x5B8C;&#x6210;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">realized?</span> (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">Thread/sleep</span> <span class="number">1000</span>)))</span><br><span class="line"><span class="comment">; =&gt; false</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [f (<span class="name"><span class="builtin-name">future</span></span>)]</span><br><span class="line">  @f</span><br><span class="line">  (<span class="name">realized?</span> f))</span><br><span class="line"><span class="comment">; =&gt; true</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Futures are a dead-simple way to sprinkle some concurrency on your program.</p>
</blockquote>
<p>&#x672A;&#x6765;&#x662F;&#x8D85;&#x7EA7;&#x7B80;&#x5355;&#x7684;&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x65B9;&#x6CD5;&#x3002;</p>
<blockquote>
<p>On their own, they give you the power to chuck tasks onto other threads, which can make your program more efficient. They also let your program behave more flexibly by giving you control over when a task&#x2019;s result is required.</p>
</blockquote>
<p>&#x5C31;&#x5176;&#x672C;&#x8EAB;&#x800C;&#x8A00;&#xFF0C;&#x4ED6;&#x8D4B;&#x4E88;&#x4F60;&#x628A;&#x4EFB;&#x52A1;&#x653E;&#x5728;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x8FD0;&#x884C;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x8FD9;&#x4F7F;&#x7A0B;&#x5E8F;&#x66F4;&#x9AD8;&#x6548;&#x3002;&#x4E5F;&#x8BA9;&#x4F60;&#x80FD;&#x63A7;&#x5236;&#x4F55;&#x65F6;&#x8BF7;&#x6C42;&#x4EFB;&#x52A1;&#x7ED3;&#x679C;&#xFF0C;&#x8FD9;&#x4F7F;&#x4F60;&#x7684;&#x7A0B;&#x5E8F;&#x66F4;&#x52A0;&#x7075;&#x6D3B;&#x3002;</p>
<blockquote>
<p>When you dereference a future, you indicate that the result is required right now and that evaluation should stop until the result is obtained. You&#x2019;ll see how this can help you deal with the mutual exclusion problem in just a bit.  Alternatively, you can ignore the result. For example, you can use futures to write to a log file asynchronously, in which case you don&#x2019;t need to dereference the future to get any value back.</p>
</blockquote>
<p>&#x5BF9;&#x4E00;&#x4E2A;&#x672A;&#x6765;&#x53D6;&#x503C;&#x65F6;&#xFF0C;&#x8868;&#x793A;&#x73B0;&#x5728;&#x5C31;&#x9700;&#x8981;&#x7ED3;&#x679C;&#xFF0C;&#x800C;&#x4E14;&#x6C42;&#x503C;&#x4F1A;&#x505C;&#x6B62;&#xFF0C;&#x76F4;&#x5230;&#x83B7;&#x5F97;&#x7ED3;&#x679C;&#x3002;&#x4F60;&#x4F1A;&#x770B;&#x5230;&#x4ED6;&#x5982;&#x4F55;&#x5E2E;&#x4F60;&#x5904;&#x7406;&#x4E92;&#x65A5;&#x95EE;&#x9898;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5FFD;&#x7565;&#x7ED3;&#x679C;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x672A;&#x6765;&#x5F02;&#x6B65;&#x5730;&#x5199;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#x4E0D;&#x9700;&#x8981;&#x53D6;&#x56DE;&#x4EFB;&#x4F55;&#x503C;&#x3002;</p>
<blockquote>
<p>The flexibility that futures give you is very cool. Clojure also allows you to treat task definition and requiring the result independently with delays and promises.</p>
</blockquote>
<p>&#x672A;&#x6765;&#x8D4B;&#x4E88;&#x4F60;&#x7684;&#x7075;&#x6D3B;&#x6027;&#x5F88;&#x9177;&#x3002;Clojure&#x4E5F;&#x5141;&#x8BB8;&#x4F60;&#x7528;&#x5EF6;&#x671F;&#x548C;&#x627F;&#x8BFA;&#x5206;&#x522B;&#x5904;&#x7406;&#x4EFB;&#x52A1;&#x5B9A;&#x4E49;&#x548C;&#x7ED3;&#x679C;&#x8BF7;&#x6C42;&#x3002;</p>
<blockquote>
<p>Delays</p>
</blockquote>
<h3 id="&#x5EF6;&#x671F;"><a href="#&#x5EF6;&#x671F;" class="headerlink" title="&#x5EF6;&#x671F;"></a>&#x5EF6;&#x671F;</h3><blockquote>
<p><code>Delays</code> allow you to define a task without having to execute it or require the result immediately. You can create a delay using <code>delay</code>:</p>
</blockquote>
<p><code>Delays</code>&#x5141;&#x8BB8;&#x4F60;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#xFF0C;&#x4F46;&#x4E0D;&#x7528;&#x7ACB;&#x523B;&#x6267;&#x884C;&#x5E76;&#x8BF7;&#x6C42;&#x7ED3;&#x679C;&#x3002;&#x7528;<code>delay</code>&#x5EFA;&#x7ACB;&#x4E00;&#x4E2A;&#x5EF6;&#x671F;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> jackson-5-delay</span><br><span class="line">  (<span class="name"><span class="builtin-name">delay</span></span> (<span class="name"><span class="builtin-name">let</span></span> [message <span class="string">&quot;Just call my name and I&apos;ll be there&quot;</span>]</span><br><span class="line">           (<span class="name">println</span> <span class="string">&quot;First deref:&quot;</span> message)</span><br><span class="line">           message)))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In this example, nothing is printed, because we haven&#x2019;t yet asked the <code>let</code> form to be evaluated. You can evaluate the delay and get its result by dereferencing it or by using <code>force</code>. <code>force</code> behaves identically to <code>deref</code> in that it communicates more clearly that you&#x2019;re causing a task to start as opposed to waiting for a task to finish:</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4EC0;&#x4E48;&#x90FD;&#x6CA1;&#x6253;&#x5370;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x8FD8;&#x6CA1;&#x8BA9;<code>let</code>&#x88AB;&#x6C42;&#x503C;&#x3002;&#x7528;&#x53D6;&#x503C;&#x6216;&#x7528;<code>force</code>,&#x53EF;&#x4EE5;&#x5BF9;&#x5EF6;&#x671F;&#x6C42;&#x503C;&#x5E76;&#x5F97;&#x5230;&#x7ED3;&#x679C;&#x3002;<code>force</code>&#x7684;&#x529F;&#x80FD;&#x4E0E;<code>defef</code>&#x4E00;&#x6837;&#xFF0C;&#x4F46;&#x5B83;&#x66F4;&#x6E05;&#x6670;&#x5730;&#x8868;&#x660E;&#x4F60;&#x4F7F;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#x5F00;&#x59CB;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x7B49;&#x5F85;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#x5B8C;&#x6210;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">force</span></span> jackson-5-delay)</span><br><span class="line"><span class="comment">; =&gt; First deref: Just call my name and I&apos;ll be there</span></span><br><span class="line"><span class="comment">; =&gt; &quot;Just call my name and I&apos;ll be there&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Like futures, a delay is run only once and its result is cached. Subsequent dereferencing will return the Jackson 5 message without printing anything:</p>
</blockquote>
<p>&#x4E0E;&#x672A;&#x6765;&#x7C7B;&#x4F3C;&#xFF0C;&#x5EF6;&#x671F;&#x53EA;&#x8FD0;&#x884C;&#x4E00;&#x6B21;&#xFF0C;&#x5E76;&#x4E14;&#x7ED3;&#x679C;&#x88AB;&#x7F13;&#x5B58;&#x3002;&#x540E;&#x7EED;&#x7684;&#x53D6;&#x503C;&#x4E0D;&#x4F1A;&#x6253;&#x5370;&#x4EFB;&#x4F55;&#x4E1C;&#x897F;&#xFF1A;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@jackson-5-delay</span><br><span class="line">; =&gt; &quot;Just call my name and I&apos;ll be there&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>One way you can use a delay is to fire off a statement the first time one future out of a group of related futures finishes. For example, pretend your app uploads a set of headshots to a headshot-sharing site and notifies the owner as soon as the first one is up, as in the following:</p>
</blockquote>
<p>&#x5EF6;&#x671F;&#x7684;&#x4E00;&#x4E2A;&#x7528;&#x6CD5;&#x662F;&#xFF1A;&#x5F53;&#x7B2C;&#x4E00;&#x6B21;&#xFF0C;&#x4E00;&#x7EC4;&#x76F8;&#x5173;&#x7684;&#x672A;&#x6765;&#x4E2D;&#x7684;&#x67D0;&#x4E2A;&#x5B8C;&#x6210;&#x65F6;&#xFF0C;&#x6267;&#x884C;&#x4E00;&#x6761;&#x8BED;&#x53E5;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5047;&#x8BBE;&#x4F60;&#x7684;app&#x4E0A;&#x4F20;&#x4E00;&#x7EC4;&#x5934;&#x50CF;&#x7167;&#x7247;&#x5230;&#x4E00;&#x4E2A;&#x5934;&#x50CF;&#x7167;&#x7247;&#x5206;&#x4EAB;&#x7F51;&#x7AD9;&#xFF0C;&#x800C;&#x4E14;&#x5F53;&#x7B2C;&#x4E00;&#x5F20;&#x4E0A;&#x4F20;&#x5B8C;&#x6210;&#x65F6;&#x901A;&#x77E5;&#x7528;&#x6237;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> gimli-headshots [<span class="string">&quot;serious.jpg&quot;</span> <span class="string">&quot;fun.jpg&quot;</span> <span class="string">&quot;playful.jpg&quot;</span>])</span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> email-user</span><br><span class="line">  [email-address]</span><br><span class="line">  (<span class="name">println</span> <span class="string">&quot;Sending headshot notification to&quot;</span> email-address))</span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> upload-document</span><br><span class="line">  <span class="string">&quot;Needs to be implemented&quot;</span></span><br><span class="line">  [headshot]</span><br><span class="line">  <span class="literal">true</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [notify (<span class="name"><span class="builtin-name">delay</span></span> &#x278A;(<span class="name">email-user</span> <span class="string">&quot;and-my-axe@gmail.com&quot;</span>))]</span><br><span class="line">  (<span class="name"><span class="builtin-name">doseq</span></span> [headshot gimli-headshots]</span><br><span class="line">    (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">upload-document</span> headshot)</span><br><span class="line">            &#x278B;(<span class="name"><span class="builtin-name">force</span></span> notify))))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In this example, you define a vector of headshots to upload (<code>gimli-headshots</code>) and two functions (<code>email-user</code> and <code>upload-document</code>) to pretend-perform the two operations. Then you use <code>let</code> to bind <code>notify</code> to a delay. The body of the delay, <code>(email-user &quot;and-my-axe@gmail.com&quot;)</code> &#x278A;, isn&#x2019;t evaluated when the delay is created. Instead, it gets evaluated the first time one of the futures created by the <code>doseq</code> form evaluates (<code>force notify</code>) &#x278B;. Even though <code>(force notify)</code> will be evaluated three times, the delay body is evaluated only once. Gimli will be grateful to know when the first headshot is available so he can begin tweaking it and sharing it. He&#x2019;ll also appreciate not being spammed, and you&#x2019;ll appreciate not facing his dwarven wrath.</p>
</blockquote>
<p>&#x4F8B;&#x5B50;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x7EC4;&#x8981;&#x4E0A;&#x4F20;&#x7684;&#x5934;&#x50CF;(<code>gimli-headshots</code>)&#x548C;&#x4E24;&#x4E2A;&#x51FD;&#x6570;(<code>email-user</code> &#x548C; <code>upload-document</code>)&#x6A21;&#x62DF;&#x6267;&#x884C;&#x4E24;&#x4E2A;&#x64CD;&#x4F5C;&#x3002;&#x7136;&#x540E;&#x7528;<code>let</code>&#x7ED1;&#x5B9A;<code>nodify</code>&#x81F3;&#x4E00;&#x4E2A;&#x5EF6;&#x671F;&#x3002;&#x5EF6;&#x671F;&#x7684;&#x4E3B;&#x4F53;,<code>(email-user &quot;and-my-axe@gmail.com&quot;)</code>&#x278A;&#x5728;&#x521B;&#x5EFA;&#x65F6;&#x6CA1;&#x6709;&#x6C42;&#x503C;&#x3002;&#x76F8;&#x53CD;&#xFF0C;&#x6C42;&#x503C;&#x53D1;&#x751F;&#x7684;&#x65F6;&#x95F4;&#x662F;&#xFF1A;&#x7B2C;&#x4E00;&#x6B21;<code>doseq</code>&#x521B;&#x5EFA;&#x7684;&#x67D0;&#x4E2A;&#x672A;&#x6765;&#x6C42;&#x503C;<code>(force notify)</code>&#x278B;&#x7684;&#x65F6;&#x5019;&#x3002;&#x867D;&#x7136;<code>(force notify)</code>&#x5C06;&#x6C42;&#x503C;&#x4E09;&#x6B21;&#xFF0C;&#xFF0C;&#x4F46;&#x5EF6;&#x671F;&#x4E3B;&#x4F53;&#x53EA;&#x6C42;&#x503C;&#x4E00;&#x6B21;&#x3002;&#x4E0A;&#x4F20;&#x8005;&#x77E5;&#x9053;&#x7B2C;&#x4E00;&#x5F20;&#x7167;&#x7247;&#x4E0A;&#x4F20;&#x5B8C;&#x6210;&#x4F1A;&#x5F88;&#x9AD8;&#x5174;&#xFF0C;&#x4ED6;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x7F16;&#x8F91;&#x7167;&#x7247;&#xFF0C;&#x4ED6;&#x4E5F;&#x56E0;&#x4E3A;&#x6CA1;&#x6536;&#x5230;&#x91CD;&#x590D;&#x7684;&#x5783;&#x573E;&#x90AE;&#x4EF6;&#x800C;&#x9AD8;&#x5174;&#x3002;</p>
<blockquote>
<p>This technique can help protect you from the mutual exclusion Concurrency Goblin&#x2014;the problem of making sure that only one thread can access a particular resource at a time. In this example, the delay guards the email server resource. Because the body of a delay is guaranteed to fire only once, you can be sure that you will never run into a situation where two threads send the same email. Of course, no thread will ever be able to use the delay to send an email again. That might be too drastic a constraint for most situations, but in cases like this example, it works perfectly.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x6280;&#x5DE7;&#x53EF;&#x4EE5;&#x9632;&#x6B62;&#x4E92;&#x65A5;&#x5E76;&#x53D1;&#x95EE;&#x9898;&#xFF0C;&#x786E;&#x4FDD;&#x4E00;&#x4E2A;&#x65F6;&#x95F4;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x80FD;&#x8BBF;&#x95EE;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x8D44;&#x6E90;&#x3002;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x5EF6;&#x671F;&#x4FDD;&#x62A4;&#x4E86;&#x90AE;&#x4EF6;&#x670D;&#x52A1;&#x5668;&#x8D44;&#x6E90;&#x3002;&#x7531;&#x4E8E;&#x5EF6;&#x671F;&#x4E3B;&#x4F53;&#x4FDD;&#x8BC1;&#x53EA;&#x6267;&#x884C;&#x4E00;&#x6B21;&#xFF0C;&#x4F60;&#x80FD;&#x786E;&#x4FE1;&#x7EDD;&#x4E0D;&#x4F1A;&#x6709;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#x53D1;&#x9001;&#x540C;&#x6837;&#x7684;&#x90AE;&#x4EF6;&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x6CA1;&#x6709;&#x7EBF;&#x7A0B;&#x80FD;&#x518D;&#x6B21;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x5EF6;&#x671F;&#x53D1;&#x9001;&#x90AE;&#x4EF6;&#x3002;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x4E0B;&#x8FD9;&#x4E2A;&#x9650;&#x5236;&#x53EF;&#x80FD;&#x592A;&#x6FC0;&#x8FDB;&#xFF0C;&#x4F46;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x8FD9;&#x4E2A;&#x9650;&#x5236;&#x5DE5;&#x4F5C;&#x5F88;&#x5B8C;&#x7F8E;&#x3002;</p>
<blockquote>
<p>Promise</p>
</blockquote>
<h3 id="&#x627F;&#x8BFA;"><a href="#&#x627F;&#x8BFA;" class="headerlink" title="&#x627F;&#x8BFA;"></a>&#x627F;&#x8BFA;</h3><blockquote>
<p><em>Promises</em> allow you to express that you expect a result without having to define the task that should produce it or when that task should run. You create promises using <code>promise</code> and deliver a result to them using <code>deliver</code>. You obtain the result by dereferencing:</p>
</blockquote>
<p><em>&#x627F;&#x8BFA;</em> &#x8BA9;&#x4F60;&#x80FD;&#x8868;&#x8FBE;&#xFF1A;&#x671F;&#x671B;&#x4E00;&#x4E2A;&#x7ED3;&#x679C;&#xFF0C;&#x4F46;&#x4E0D;&#x7528;&#x5B9A;&#x4E49;&#x4EA7;&#x751F;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#x7684;&#x4EFB;&#x52A1;&#x6216;&#x4E0D;&#x7528;&#x6307;&#x5B9A;&#x90A3;&#x4E2A;&#x4EFB;&#x52A1;&#x5E94;&#x8BE5;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x8FD0;&#x884C;&#x3002;&#x7528;<code>promise</code>&#x521B;&#x5EFA;&#x627F;&#x8BFA;&#xFF0C;&#x7528;<code>deliver</code>&#x4EA4;&#x4ED8;&#x627F;&#x8BFA;&#x7ED3;&#x679C;&#x3002;&#x7528;&#x53D6;&#x503C;&#x83B7;&#x5F97;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#xFF1A;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(def my-promise (promise))</span><br><span class="line">(deliver my-promise (+ 1 2))</span><br><span class="line">@my-promise</span><br><span class="line">; =&gt; 3</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Here, you create a promise and then deliver a value to it. Finally, you obtain the value by dereferencing the promise. Dereferencing is how you express that you expect a result, and if you had tried to dereference <code>my-promise</code> without first delivering a value, the program would block until a promise was delivered, just like with futures and delays. You can only deliver a result to a promise once.</p>
</blockquote>
<p>&#x8FD9;&#x91CC;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x627F;&#x8BFA;&#x7136;&#x540E;&#x5BF9;&#x5B83;&#x4EA4;&#x4ED8;&#x4E86;&#x4E00;&#x4E2A;&#x503C;&#x3002;&#x6700;&#x540E;&#x7528;&#x53D6;&#x503C;&#x83B7;&#x5F97;&#x4E86;&#x90A3;&#x4E2A;&#x503C;&#x3002;&#x53D6;&#x503C;&#x662F;&#x8868;&#x8FBE;&#x4E86;&#x4F60;&#x671F;&#x671B;&#x4E00;&#x4E2A;&#x7ED3;&#x679C;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5148;&#x4EA4;&#x4ED8;&#x4E00;&#x4E2A;&#x503C;&#xFF0C;&#x5C31;&#x5BF9;<code>my-promise</code>&#x53D6;&#x503C;&#xFF0C;&#x7A0B;&#x5E8F;&#x5C06;&#x4F1A;&#x963B;&#x585E;&#xFF0C;&#x76F4;&#x81F3;&#x4E00;&#x4E2A;&#x503C;&#x88AB;&#x4EA4;&#x4ED8;&#xFF0C;&#x4E0E;&#x672A;&#x6765;(futures)&#x548C;&#x5EF6;&#x671F;(delay)&#x4E00;&#x6837;&#x3002;&#x5BF9;&#x4E00;&#x4E2A;&#x627F;&#x8BFA;&#x53EA;&#x80FD;&#x4EA4;&#x4ED8;&#x4E00;&#x6B21;&#x7ED3;&#x679C;&#x3002;</p>
<blockquote>
<p>One use for promises is to find the first satisfactory element in a collection of data. Suppose, for example, that you&#x2019;re gathering ingredients to make your parrot sound like James Earl Jones. Because James Earl Jones has the smoothest voice on earth, one of the ingredients is premium yak butter with a smoothness rating of 97 or greater. You have a budget of $100 for one pound.</p>
</blockquote>
<p>&#x627F;&#x8BFA;&#x7684;&#x4E00;&#x4E2A;&#x7528;&#x5904;&#x662F;&#x4ECE;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x96C6;&#x5408;&#x91CC;&#x627E;&#x5230;&#x7B2C;&#x4E00;&#x4E2A;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7684;&#x6210;&#x5458;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5047;&#x8BBE;&#x4F60;&#x6B63;&#x5728;&#x6536;&#x96C6;&#x4F7F;&#x4F60;&#x7684;&#x9E66;&#x9E49;&#x53D1;&#x51FA;&#x540C;James Earl Jones&#x58F0;&#x97F3;&#x4E00;&#x6837;&#x7684;&#x58F0;&#x97F3;&#x7684;&#x914D;&#x65B9;&#x3002;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x914D;&#x65B9;&#x662F;&#x5149;&#x6ED1;&#x5EA6;&#x4E3A;97%&#x6216;&#x66F4;&#x9AD8;&#x7684;&#x4F18;&#x8D28;&#x7266;&#x725B;&#x9EC4;&#x6CB9;&#x3002;&#x4F60;&#x6709;100&#x7F8E;&#x5143;&#x7684;&#x9884;&#x7B97;&#x7528;&#x4E8E;&#x8D2D;&#x4E70;&#x4E00;&#x78C5;&#x3002;</p>
<blockquote>
<p>You are a modern practitioner of the magico-ornithological arts, so rather than tediously navigating each yak butter retail site, you create a script to give you the URL of the first yak butter that meets your needs.</p>
</blockquote>
<p>&#x4F60;&#x51B3;&#x5B9A;&#x5199;&#x4E00;&#x4E2A;&#x811A;&#x672C;&#x7528;&#x6765;&#x83B7;&#x5F97;&#x7B26;&#x5408;&#x9700;&#x6C42;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x7266;&#x725B;&#x6CB9;&#x7684;URL&#x3002;</p>
<blockquote>
<p>The following code defines some yak butter products, creates a function to mock up an API call, and creates another function to test whether a product is satisfactory:</p>
</blockquote>
<p>&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E9B;&#x7266;&#x725B;&#x9EC4;&#x6CB9;&#x4EA7;&#x54C1;&#xFF0C;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x7528;&#x6765;&#x6A21;&#x62DF;API&#x8C03;&#x7528;&#xFF0C;&#x521B;&#x5EFA;&#x4E86;&#x53E6;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6D4B;&#x8BD5;&#x4EA7;&#x54C1;&#x662F;&#x5426;&#x6EE1;&#x8DB3;&#x9700;&#x8981;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> yak-butter-international</span><br><span class="line">  {<span class="symbol">:store</span> <span class="string">&quot;Yak Butter International&quot;</span></span><br><span class="line">    <span class="symbol">:price</span> <span class="number">90</span></span><br><span class="line">    <span class="symbol">:smoothness</span> <span class="number">90</span>})</span><br><span class="line">(<span class="name"><span class="builtin-name">def</span></span> butter-than-nothing</span><br><span class="line">  {<span class="symbol">:store</span> <span class="string">&quot;Butter Than Nothing&quot;</span></span><br><span class="line">   <span class="symbol">:price</span> <span class="number">150</span></span><br><span class="line">   <span class="symbol">:smoothness</span> <span class="number">83</span>})</span><br><span class="line"><span class="comment">;; This is the butter that meets our requirements</span></span><br><span class="line">(<span class="name"><span class="builtin-name">def</span></span> baby-got-yak</span><br><span class="line">  {<span class="symbol">:store</span> <span class="string">&quot;Baby Got Yak&quot;</span></span><br><span class="line">   <span class="symbol">:price</span> <span class="number">94</span></span><br><span class="line">   <span class="symbol">:smoothness</span> <span class="number">99</span>})</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> mock-api-call</span><br><span class="line">  [result]</span><br><span class="line">  (<span class="name">Thread/sleep</span> <span class="number">1000</span>)</span><br><span class="line">  result)</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> satisfactory?</span><br><span class="line">  <span class="string">&quot;If the butter meets our criteria, return the butter, else return false&quot;</span></span><br><span class="line">  [butter]</span><br><span class="line">  (<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">&lt;=</span></span> (<span class="symbol">:price</span> butter) <span class="number">100</span>)</span><br><span class="line">       (<span class="name"><span class="builtin-name">&gt;=</span></span> (<span class="symbol">:smoothness</span> butter) <span class="number">97</span>)</span><br><span class="line">       butter))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The API call waits one second before returning a result to simulate the time it would take to perform an actual call.</p>
</blockquote>
<p>API&#x8C03;&#x7528;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x524D;&#x7B49;&#x5F85;&#x4E86;&#x4E00;&#x79D2;&#xFF0C;&#x7528;&#x6765;&#x6A21;&#x62DF;&#x5B9E;&#x9645;&#x8C03;&#x7528;&#x82B1;&#x8D39;&#x7684;&#x65F6;&#x95F4;&#x3002;</p>
<blockquote>
<p>To show how long it will take to check the sites synchronously, we&#x2019;ll use <code>some</code> to apply the <code>satisfactory?</code> function to each element of the collection and return the first truthy result, or nil if there are none. When you check each site synchronously, it could take more than one second per site to obtain a result, as the following code shows:</p>
</blockquote>
<p>&#x4E3A;&#x663E;&#x793A;&#x540C;&#x6B65;&#x68C0;&#x67E5;&#x8FD9;&#x4E9B;&#x7F51;&#x7AD9;&#x9700;&#x8981;&#x591A;&#x4E45;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;&#x4EA7;&#x54C1;&#x96C6;&#x5408;&#x7684;&#x6BCF;&#x9879;&#x4EA7;&#x54C1;&#x6A21;&#x62DF;api&#x8C03;&#x7528;&#xFF0C;&#x53D6;&#x5F97;&#x4EA7;&#x54C1;&#xFF0C;&#x7136;&#x540E;&#x5224;&#x65AD;&#x662F;&#x5426;&#x7B26;&#x5408;&#x8981;&#x6C42;&#x3002;&#x5E76;&#x7528;<code>some</code>&#x53D6;&#x51FA;&#x7B2C;&#x4E00;&#x4E2A;&#x7B26;&#x5408;&#x8981;&#x6C42;&#x7684;&#x4EA7;&#x54C1;&#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7B26;&#x5408;&#x7684;&#x4EA7;&#x54C1;&#xFF0C;&#x8FD4;&#x56DE;nil&#x3002;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x6240;&#x793A;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">time</span></span> (<span class="name">some</span> (<span class="name"><span class="builtin-name">comp</span></span> satisfactory? mock-api-call)</span><br><span class="line">            [yak-butter-international butter-than-nothing baby-got-yak]))</span><br><span class="line"><span class="comment">; =&gt; &quot;Elapsed time: 3002.132 msecs&quot;</span></span><br><span class="line"><span class="comment">; =&gt; {:store &quot;Baby Got Yak&quot;, :smoothness 99, :price 94}</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Here I&#x2019;ve used <code>comp</code> to compose functions, and I&#x2019;ve used <code>time</code> to print the time taken to evaluate a form. You can use a promise and futures to perform each check on a separate thread. If your computer has multiple cores, this could reduce the time it takes to about one second:</p>
</blockquote>
<p>&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86;<code>comp</code>&#x7EC4;&#x5408;&#x51FD;&#x6570;&#xFF0C;&#x4F7F;&#x7528;&#x4E86;<code>time</code>&#x6253;&#x5370;&#x6C42;&#x503C;&#x65F6;&#x95F4;&#x3002;&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x627F;&#x8BFA;&#x548C;&#x672A;&#x6765;&#x5728;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x6BCF;&#x4E2A;&#x68C0;&#x67E5;&#x3002;&#x5982;&#x679C;&#x4F60;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#x662F;&#x591A;&#x6838;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x628A;&#x82B1;&#x8D39;&#x7684;&#x65F6;&#x95F4;&#x51CF;&#x5C11;&#x5230;&#x5927;&#x7EA6;&#x4E00;&#x79D2;:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">time</span></span></span><br><span class="line"> (<span class="name"><span class="builtin-name">let</span></span> [butter-promise (<span class="name"><span class="builtin-name">promise</span></span>)]</span><br><span class="line">   (<span class="name"><span class="builtin-name">doseq</span></span> [butter [yak-butter-international butter-than-nothing baby-got-yak]]</span><br><span class="line">     (<span class="name"><span class="builtin-name">future</span></span> (<span class="name"><span class="builtin-name">if-let</span></span> [satisfactory-butter (<span class="name">satisfactory?</span> (<span class="name">mock-api-call</span> butter))]</span><br><span class="line">               (<span class="name">deliver</span> butter-promise satisfactory-butter))))</span><br><span class="line">   (<span class="name">println</span> <span class="string">&quot;And the winner is:&quot;</span> @butter-promise)))</span><br><span class="line"><span class="comment">; =&gt; &quot;Elapsed time: 1002.652 msecs&quot;</span></span><br><span class="line"><span class="comment">; =&gt; And the winner is: {:store Baby Got Yak, :smoothness 99, :price 94}</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>In this example, you first create a promise, <code>butter-promise</code>, and then create three futures with access to that promise. Each future&#x2019;s task is to evaluate a yak butter site and to deliver the site&#x2019;s data to the promise if it&#x2019;s satisfactory. Finally, you dereference <code>butter-promise</code>, causing the program to block until the site data is delivered. This takes about one second instead of three because the site evaluations happen in parallel. By decoupling the requirement for a result from how the result is actually computed, you can perform multiple computations in parallel and save some time.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x5EFA;&#x7ACB;&#x4E86;&#x4E00;&#x4E2A;&#x627F;&#x8BFA;,<code>butter-promise</code>,&#x7136;&#x540E;&#x521B;&#x5EFA;&#x4E86;&#x4E09;&#x4E2A;&#x672A;&#x6765;&#x7528;&#x4E8E;&#x8BBF;&#x95EE;&#x8FD9;&#x4E2A;&#x627F;&#x8BFA;&#x3002;&#x6BCF;&#x4E2A;&#x672A;&#x6765;&#x7684;&#x5E72;&#x7684;&#x4E8B;&#x60C5;&#x662F;&#xFF1A;&#x6C42;&#x503C;&#x4E00;&#x4E2A;&#x7F51;&#x7AD9;&#x7684;&#x7266;&#x725B;&#x9EC4;&#x6CB9;&#xFF0C;&#x5E76;&#x4E14;&#x5982;&#x679C;&#x6EE1;&#x8DB3;&#x9700;&#x8981;&#xFF0C;&#x5C31;&#x628A;&#x5B83;&#x4EA4;&#x4ED8;&#x7ED9;&#x8FD9;&#x4E2A;&#x627F;&#x8BFA;&#x3002;&#x6700;&#x540E;&#xFF0C;&#x5BF9;<code>butter-promise</code>&#x53D6;&#x503C;&#xFF0C;&#x4F7F;&#x7A0B;&#x5E8F;&#x963B;&#x585E;&#xFF0C;&#x76F4;&#x5230;&#x6709;&#x6570;&#x636E;&#x4EA4;&#x4ED8;&#x3002;&#x7531;&#x4E8E;&#x6C42;&#x503C;&#x5E76;&#x884C;&#x8FD0;&#x884C;&#xFF0C;&#x6240;&#x4EE5;&#x82B1;&#x8D39;&#x4E86;&#x4E00;&#x79D2;&#x800C;&#x4E0D;&#x662F;&#x4E09;&#x79D2;&#x3002;&#x901A;&#x8FC7;&#x628A;&#x7ED3;&#x679C;&#x8BA1;&#x7B97;&#x548C;&#x8BF7;&#x6C42;&#x7ED3;&#x679C;&#x5206;&#x79BB;&#xFF0C;&#x53EF;&#x4EE5;&#x5E76;&#x884C;&#x6267;&#x884C;&#x591A;&#x4E2A;&#x8BA1;&#x7B97;&#x5E76;&#x8282;&#x7EA6;&#x65F6;&#x95F4;&#x3002;</p>
<blockquote>
<p>You can view this as a way to protect yourself from the reference cell Concurrency Goblin. Because promises can be written to only once, you prevent the kind of inconsistent state that arises from nondeterministic reads and writes.</p>
</blockquote>
<p>&#x4F60;&#x53EF;&#x4EE5;&#x628A;&#x8FD9;&#x4E2A;&#x5F53;&#x4F5C;&#x9632;&#x6B62;&#x5F15;&#x7528;&#x5355;&#x5143;&#x95EE;&#x9898;&#x7684;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x3002;&#x56E0;&#x4E3A;&#x627F;&#x8BFA;&#x53EA;&#x80FD;&#x88AB;&#x5199;&#x4E00;&#x6B21;&#xFF0C;&#x6240;&#x4EE5;&#x9632;&#x6B62;&#x4E86;&#x4E0D;&#x786E;&#x5B9A;&#x7684;&#x8BFB;&#x5199;&#x4E2D;&#x51FA;&#x73B0;&#x7684;&#x6570;&#x636E;&#x4E0D;&#x4E00;&#x81F4;&#x72B6;&#x6001;&#x3002;</p>
<blockquote>
<p>You might be wondering what happens if none of the yak butter is satisfactory. If that happens, the dereference would block forever and tie up the thread. To avoid that, you can include a timeout:</p>
</blockquote>
<p>&#x4F60;&#x53EF;&#x80FD;&#x60F3;&#x77E5;&#x9053;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7B26;&#x5408;&#x8981;&#x6C42;&#x7684;&#x7266;&#x725B;&#x9EC4;&#x6CB9;&#x600E;&#x4E48;&#x529E;&#xFF1F;&#x5982;&#x679C;&#x53D1;&#x751F;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x53D6;&#x503C;&#x5C06;&#x6C38;&#x4E45;&#x963B;&#x585E;&#xFF0C;&#x5E76;&#x5360;&#x7528;&#x90A3;&#x4E2A;&#x7EBF;&#x7A0B;&#x3002;&#x4E3A;&#x907F;&#x514D;&#x8FD9;&#x6837;&#xFF0C;&#x53EF;&#x4EE5;&#x589E;&#x52A0;&#x4E00;&#x4E2A;&#x8D85;&#x65F6;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [p (<span class="name"><span class="builtin-name">promise</span></span>)]</span><br><span class="line">  (<span class="name"><span class="builtin-name">deref</span></span> p <span class="number">100</span> <span class="string">&quot;timed out&quot;</span>))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This creates a promise, <code>p</code>, and tries to dereference it. The number 100 tells <code>deref</code> to wait 100 milliseconds, and if no value is available by then, to use the timeout value, <code>&quot;timed out&quot;</code>.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x627F;&#x8BFA;&#xFF0C;<code>p</code>,&#x5E76;&#x4E14;&#x5BF9;&#x5B83;&#x53D6;&#x503C;&#x3002;&#x6570;&#x5B57;100&#x544A;&#x8BC9;<code>deref</code>&#x7B49;&#x5F85;100&#x6BEB;&#x79D2;&#xFF0C;&#x5982;&#x679C;&#x4E4B;&#x540E;&#x6CA1;&#x6709;&#x53EF;&#x7528;&#x7684;&#x503C;&#xFF0C;&#x5C31;&#x7528;&#x8D85;&#x65F6;&#x503C;<code>&quot;timeed out&quot;</code>&#x3002;</p>
<blockquote>
<p>The last detail I should mention is that you can also use promises to register callbacks, achieving the same functionality that you might be used to in JavaScript. JavaScript callbacks are a way of defining code that should execute asynchronously once some other code finishes. Here&#x2019;s how to do it in Clojure:</p>
</blockquote>
<p>&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x7EC6;&#x8282;&#x662F;&#x53EF;&#x4EE5;&#x7528;&#x627F;&#x8BFA;&#x6CE8;&#x518C;&#x56DE;&#x8C03;&#x51FD;&#x6570;&#xFF0C;&#x83B7;&#x5F97;&#x4E0E;JavaScript&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x76F8;&#x540C;&#x7684;&#x529F;&#x80FD;&#x3002;JavaScript&#x56DE;&#x8C03;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x4E86;&#x8FD9;&#x6837;&#x7684;&#x4EE3;&#x7801;&#xFF1A;&#x4E00;&#x65E6;&#x67D0;&#x4E9B;&#x5176;&#x4ED6;&#x4EE3;&#x7801;&#x5B8C;&#x6210;&#xFF0C;&#x8FD9;&#x4E9B;&#x4EE3;&#x7801;&#x5C31;&#x4F1A;&#x5F02;&#x6B65;&#x6267;&#x884C;&#x3002;&#x5728;Clojure&#x91CC;&#x53EF;&#x4EE5;&#x8FD9;&#x4E48;&#x505A;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [ferengi-wisdom-promise (<span class="name"><span class="builtin-name">promise</span></span>)]</span><br><span class="line">  (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">println</span> <span class="string">&quot;Here&apos;s some Ferengi wisdom:&quot;</span> @ferengi-wisdom-promise))</span><br><span class="line">  (<span class="name">Thread/sleep</span> <span class="number">100</span>)</span><br><span class="line">  (<span class="name">deliver</span> ferengi-wisdom-promise <span class="string">&quot;Whisper your way to success.&quot;</span>))</span><br><span class="line"><span class="comment">; =&gt; Here&apos;s some Ferengi wisdom: Whisper your way to success.</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>This example creates a future that begins executing immediately. However, the future&#x2019;s thread is blocking because it&#x2019;s waiting for a value to be delivered to <code>ferengi-wisdom-promise</code>. After 100 milliseconds, you deliver the value and the <code>println</code> statement in the future runs.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x7ACB;&#x523B;&#x5F00;&#x59CB;&#x6267;&#x884C;&#x7684;&#x672A;&#x6765;&#x3002;&#x4F46;&#x8FD9;&#x4E2A;&#x672A;&#x6765;&#x7684;&#x7EBF;&#x7A0B;&#x662F;&#x963B;&#x585E;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x7B49;&#x5F85;&#x4E00;&#x4E2A;&#x503C;&#x4EA4;&#x4ED8;&#x7ED9;<code>ferengi-wisdom-promise</code>&#x3002;100&#x6BEB;&#x79D2;&#x540E;&#xFF0C;&#x503C;&#x88AB;&#x4EA4;&#x4ED8;&#xFF0C;&#x672A;&#x6765;&#x91CC;&#x7684;<code>println</code>&#x8BED;&#x53E5;&#x8FD0;&#x884C;&#x3002;</p>
<blockquote>
<p>Futures, delays, and promises are great, simple ways to manage concurrency in your application. In the next section, we&#x2019;ll look at one more fun way to keep your concurrent applications under control.</p>
</blockquote>
<p>&#x672A;&#x6765;&#xFF0C;&#x5EF6;&#x671F;&#x548C;&#x627F;&#x8BFA;&#x662F;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x91CC;&#x7BA1;&#x7406;&#x5E76;&#x53D1;&#x7684;&#x597D;&#x65B9;&#x6CD5;&#x3002;&#x4E0B;&#x8282;&#x6211;&#x4EEC;&#x4F1A;&#x770B;&#x5230;&#x66F4;&#x591A;&#x6709;&#x8DA3;&#x7684;&#x63A7;&#x5236;&#x5E76;&#x53D1;&#x7A0B;&#x5E8F;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<blockquote>
<p>Rolling Your Own Queue</p>
</blockquote>
<h3 id="&#x81EA;&#x5EFA;&#x961F;&#x5217;"><a href="#&#x81EA;&#x5EFA;&#x961F;&#x5217;" class="headerlink" title="&#x81EA;&#x5EFA;&#x961F;&#x5217;"></a>&#x81EA;&#x5EFA;&#x961F;&#x5217;</h3><blockquote>
<p>So far you&#x2019;ve looked at some simple ways to combine futures, delays, and promises to make your concurrent programs a little safer. In this section, you&#x2019;ll use a macro to combine futures and promises in a slightly more complex manner. You might not necessarily ever use this code, but it&#x2019;ll show the power of these modest tools a bit more. The macro will require you to hold runtime logic and macro expansion logic in your head at the same time to understand what&#x2019;s going on; if you get stuck, just skip ahead.</p>
</blockquote>
<p>&#x5230;&#x73B0;&#x5728;&#x4F60;&#x5DF2;&#x7ECF;&#x770B;&#x5230;&#x4E86;&#x4E00;&#x4E9B;&#x7B80;&#x5355;&#x7684;&#xFF0C;&#x7528;&#x6765;&#x7EC4;&#x5408;&#x672A;&#x6765;&#xFF0C;&#x5EF6;&#x671F;&#xFF0C;&#x548C;&#x627F;&#x8BFA;&#xFF0C;&#x4F7F;&#x5E76;&#x53D1;&#x7A0B;&#x5E8F;&#x66F4;&#x52A0;&#x5B89;&#x5168;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x8FD9;&#x8282;&#xFF0C;&#x4F60;&#x5C06;&#x7528;&#x4E00;&#x4E2A;&#x5B8F;&#x4EE5;&#x66F4;&#x590D;&#x6742;&#x4E9B;&#x7684;&#x65B9;&#x5F0F;&#x7EC4;&#x5408;&#x672A;&#x6765;&#x548C;&#x627F;&#x8BFA;&#x3002;&#x4F60;&#x4E0D;&#x4E00;&#x5B9A;&#x8981;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x4EE3;&#x7801;&#xFF0C;&#x4F46;&#x5B83;&#x80FD;&#x8BA9;&#x4F60;&#x8FDB;&#x4E00;&#x6B65;&#x770B;&#x5230;&#x8FD9;&#x4E9B;&#x6734;&#x7D20;&#x5DE5;&#x5177;&#x7684;&#x529B;&#x91CF;&#x3002;&#x4E3A;&#x7406;&#x89E3;&#x8FD9;&#x4E2A;&#x5B8F;&#xFF0C;&#x4F60;&#x5934;&#x8111;&#x4E2D;&#x8981;&#x540C;&#x65F6;&#x60F3;&#x7740;&#x5B8F;&#x5C55;&#x5F00;&#x548C;&#x8FD0;&#x884C;&#x65F6;&#x903B;&#x8F91;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x5361;&#x4F4F;&#x4E86;&#xFF0C;&#x8DF3;&#x8FC7;&#x5373;&#x53EF;&#x3002;</p>
<blockquote>
<p>One characteristic The Three Concurrency Goblins have in common is that they all involve tasks concurrently accessing a shared resource&#x2014;a variable, a printer, a dwarven war axe&#x2014;in an uncoordinated way. If you want to ensure that only one task will access a resource at a time, you can place the resource access portion of a task on a queue that&#x2019;s executed serially. It&#x2019;s kind of like making a cake: you and a friend can separately retrieve the ingredients (eggs, flour, eye of newt, what have you), but some steps you&#x2019;ll have to perform serially. You have to prepare the batter before you put it in the oven. Figure 9-6 illustrates this strategy.</p>
</blockquote>
<p>&#x4E09;&#x4E2A;&#x5E76;&#x53D1;&#x95EE;&#x9898;&#x7684;&#x4E00;&#x4E2A;&#x5171;&#x540C;&#x7279;&#x70B9;&#x662F;&#xFF1A;&#x4ED6;&#x4EEC;&#x90FD;&#x4E0E;&#x4E0D;&#x534F;&#x8C03;&#x5730;&#x8BBF;&#x95EE;&#x5171;&#x4EAB;&#x8D44;&#x6E90;&#x7684;&#x4EFB;&#x52A1;&#x6709;&#x5173;&#xFF0C;&#x8FD9;&#x4E9B;&#x8D44;&#x6E90;&#x5305;&#x62EC;&#xFF1A;&#x53D8;&#x91CF;&#xFF0C;&#x6253;&#x5370;&#x673A;&#xFF0C;&#x77EE;&#x4EBA;&#x6218;&#x65A7;&#x3002;&#x5982;&#x679C;&#x4F60;&#x60F3;&#x786E;&#x4FDD;&#x4E00;&#x6B21;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#x8BBF;&#x95EE;&#x67D0;&#x4E2A;&#x8D44;&#x6E90;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x628A;&#x4EFB;&#x52A1;&#x4E2D;&#x8BBF;&#x95EE;&#x8D44;&#x6E90;&#x7684;&#x90E8;&#x5206;&#x653E;&#x8FDB;&#x4E00;&#x4E2A;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x7684;&#x961F;&#x5217;&#x3002;&#x8FD9;&#x6709;&#x70B9;&#x60F3;&#x505A;&#x86CB;&#x7CD5;&#xFF1A;&#x4F60;&#x548C;&#x4E00;&#x4E2A;&#x670B;&#x53CB;&#x53EF;&#x4EE5;&#x5206;&#x522B;&#x53D6;&#x5F97;&#x5236;&#x4F5C;&#x6750;&#x6599;(&#x9E21;&#x86CB;&#xFF0C;&#x9762;&#x7C89;&#xFF0C;&#x877E;&#x8788;&#x773C;&#x775B;&#x7B49;&#x4E1C;&#x897F;)&#xFF0C;&#x4F46;&#x67D0;&#x4E9B;&#x6B65;&#x9AA4;&#x4F60;&#x4EEC;&#x5FC5;&#x987B;&#x6309;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x3002;&#x4F60;&#x5FC5;&#x987B;&#x5148;&#x51C6;&#x5907;&#x597D;&#x9762;&#x7CCA;&#xFF0C;&#x518D;&#x653E;&#x5165;&#x70E4;&#x7BB1;&#x3002;&#x56FE;9-6&#x6F14;&#x793A;&#x4E86;&#x8FD9;&#x4E2A;&#x7B56;&#x7565;&#x3002;</p>
<p>&#x56FE;9-6<br><img src="/2016/07/15/braveclojure-concurrency/9-6.png" alt="Dividing tasks"></p>
<blockquote>
<p>To implement the queuing macro, you&#x2019;ll pay homage to the British, because they invented queues. You&#x2019;ll use a queue to ensure that the customary British greeting &#x201C;Ello, gov&#x2019;na! Pip pip! Cheerio!&#x201D; is delivered in the correct order. This demonstration will involve an abundance of <code>sleep</code>ing, so here&#x2019;s a macro to do that more concisely:</p>
</blockquote>
<p>&#x4F60;&#x5C06;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#x7528;&#x4EE5;&#x786E;&#x4FDD;&#x95EE;&#x5019;&#x8BED; &#x201C;Ello, gov&#x2019;na! Pip pip! Cheerio!&#x201D; &#x6309;&#x6B63;&#x786E;&#x7684;&#x987A;&#x5E8F;&#x88AB;&#x4EA4;&#x4ED8;&#x3002;&#x8FD9;&#x4E2A;&#x793A;&#x4F8B;&#x91CC;&#x6709;&#x5F88;&#x591A;<code>sleep</code>,&#x6240;&#x4EE5;&#x7528;&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x5B8F;&#x4F7F;&#x4EE3;&#x7801;&#x66F4;&#x7B80;&#x6D01;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defmacro</span></span> wait</span><br><span class="line">  <span class="string">&quot;Sleep `timeout` seconds before evaluating body&quot;</span></span><br><span class="line">  [timeout &amp; body]</span><br><span class="line">  `(<span class="name"><span class="builtin-name">do</span></span> (<span class="name">Thread/sleep</span> ~timeout) ~@body))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>All this code does is take whatever forms you give it and insert a call to <code>Thread/sleep</code> before them, all wrapped up in <code>do</code>.</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684;&#x5168;&#x90E8;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#x5728;&#x6240;&#x6709;&#x5F62;&#x5F0F;&#x524D;&#x63D2;&#x5165;&#x4E00;&#x4E2A;&#x8C03;&#x7528; <code>Thread/sleep</code>,&#x5E76;&#x5168;&#x90E8;&#x7528;<code>do</code>&#x5305;&#x8D77;&#x6765;&#x3002;</p>
<blockquote>
<p>The code in Listing 9-1 splits up tasks into a concurrent portion and a serialized portion:</p>
</blockquote>
<p>&#x4E0B;&#x9762;9-1&#x7684;&#x4EE3;&#x7801;&#x628A;&#x4EFB;&#x52A1;&#x5206;&#x6210;&#x5E76;&#x884C;&#x90E8;&#x5206;&#x548C;&#x4E32;&#x884C;&#x90E8;&#x5206;&#xFF1A;</p>
<blockquote>
<p>Listing 9-1. The expansion of an enqueue macro call&#xFF1A;</p>
</blockquote>
<p>&#x5217;&#x8868; 9-1&#x3002;enqueue&#x5B8F;&#x8C03;&#x7528;&#x7684;&#x5C55;&#x5F00;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [saying3 (<span class="name"><span class="builtin-name">promise</span></span>)]</span><br><span class="line">  (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">deliver</span> saying3 (<span class="name">wait</span> <span class="number">100</span> <span class="string">&quot;Cheerio!&quot;</span>)))</span><br><span class="line">  @(<span class="name"><span class="builtin-name">let</span></span> [saying2 (<span class="name"><span class="builtin-name">promise</span></span>)]</span><br><span class="line">     (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">deliver</span> saying2 (<span class="name">wait</span> <span class="number">400</span> <span class="string">&quot;Pip pip!&quot;</span>)))</span><br><span class="line">&#x278A;      @(<span class="name"><span class="builtin-name">let</span></span> [saying1 (<span class="name"><span class="builtin-name">promise</span></span>)]</span><br><span class="line">        (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">deliver</span> saying1 (<span class="name">wait</span> <span class="number">200</span> <span class="string">&quot;&apos;Ello, gov&apos;na!&quot;</span>)))</span><br><span class="line">        (<span class="name">println</span> @saying1)</span><br><span class="line">        saying1)</span><br><span class="line">     (<span class="name">println</span> @saying2)</span><br><span class="line">     saying2)</span><br><span class="line">  (<span class="name">println</span> @saying3)</span><br><span class="line">  saying3)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The overall strategy is to create a promise for each task (in this case, printing part of the greeting) to create a corresponding future that will deliver a concurrently computed value to the promise. This ensures that all of the futures are created before any of the promises are dereferenced, and it ensures that the serialized portions are executed in the correct order. The value of <code>saying1</code> is printed first&#x2014;<code>&quot;&apos;Ello, gov&apos;na!&quot;</code>&#x2014;then the value of <code>saying2</code>, and finally <code>saying3</code>. Returning <code>saying1</code> in a <code>let</code> block and dereferencing the <code>let</code> block at &#x278A; ensures that you&#x2019;ll be completely finished with <code>saying1</code> before the code moves on to do anything to <code>saying2</code>, and this pattern is repeated with <code>saying2</code> and <code>saying3</code>.</p>
</blockquote>
<p>&#x4EE3;&#x7801;&#x7684;&#x6574;&#x4F53;&#x7B56;&#x7565;&#x662F;&#x4E3A;&#x6BCF;&#x4E2A;&#x6253;&#x5370;&#x4EFB;&#x52A1;&#x5EFA;&#x7ACB;&#x4E00;&#x4E2A;&#x627F;&#x8BFA;&#xFF0C;&#x7528;&#x4E8E;&#x5EFA;&#x7ACB;&#x5BF9;&#x5E94;&#x7684;&#x672A;&#x6765;&#xFF0C;&#x8FD9;&#x4E2A;&#x672A;&#x6765;&#x5C06;&#x4EA4;&#x4ED8;&#x4E00;&#x4E2A;&#x5E76;&#x884C;&#x8BA1;&#x7B97;&#x503C;&#x7ED9;&#x90A3;&#x4E2A;&#x627F;&#x8BFA;&#x3002;&#x8FD9;&#x786E;&#x4FDD;&#x4E86;&#x6240;&#x6709;&#x672A;&#x6765;&#x90FD;&#x5EFA;&#x7ACB;&#x4E8E;&#x4EFB;&#x4F55;&#x627F;&#x8BFA;&#x88AB;&#x53D6;&#x503C;&#x4E4B;&#x524D;&#xFF0C;&#x540C;&#x65F6;&#x786E;&#x4FDD;&#x4E86;&#x4E32;&#x884C;&#x90E8;&#x5206;&#x6309;&#x6B63;&#x786E;&#x7684;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x3002;<code>saying1</code>&#x7684;&#x503C;<code>&quot;&apos;Ello, gov&apos;na!&quot;</code>&#x88AB;&#x9996;&#x5148;&#x6253;&#x5370;&#xFF0C;&#x7136;&#x540E;&#x662F;<code>saying2</code>,<code>saying3</code>&#x7684;&#x503C;&#x3002;&#x5728;&#x278A;&#x5904;&#xFF0C;<code>let</code>&#x4EE3;&#x7801;&#x5757;&#x8FD4;&#x56DE;&#x8FD4;&#x56DE;<code>saying1</code>,&#x5E76;&#x5BF9;&#x5B83;&#x53D6;&#x503C;&#xFF0C;&#x8FD9;&#x786E;&#x4FDD;&#x4E86;&#x4EE3;&#x7801;&#x524D;&#x8FDB;&#x5230;<code>saying2</code>&#x524D;&#xFF0C;<code>saying1</code>&#x5C06;&#x5B8C;&#x5168;&#x6267;&#x884C;&#x5B8C;&#xFF0C;<code>saying2</code>&#x548C;<code>saying3</code>&#x4E5F;&#x91CD;&#x590D;&#x4E86;&#x8FD9;&#x4E2A;&#x6A21;&#x5F0F;&#x3002;</p>
<blockquote>
<p>It might seem silly to dereference the <code>let</code> block, but doing so lets you abstract this code with a macro. And you will definitely want to use a macro, because writing out code like the previous example would drive you mental (as the British would say). Ideally, the macro would work as shown in Listing 9-2:</p>
</blockquote>
<p>&#x5BF9;<code>let</code>&#x53D6;&#x503C;&#x53EF;&#x80FD;&#x770B;&#x8D77;&#x6765;&#x5F88;&#x50BB;&#xFF0C;&#x4F46;&#x8FD9;&#x4E48;&#x505A;&#x4F7F;&#x4F60;&#x80FD;&#x7528;&#x5B8F;&#x62BD;&#x8C61;&#x8FD9;&#x5757;&#x4EE3;&#x7801;&#x3002;&#x800C;&#x4E14;&#x4F60;&#x80AF;&#x5B9A;&#x60F3;&#x7528;&#x5B8F;&#xFF0C;&#x56E0;&#x4E3A;&#x50CF;&#x524D;&#x9762;&#x90A3;&#x6837;&#x5199;&#x4EE3;&#x7801;&#x4F1A;&#x4F7F;&#x4F60;&#x5934;&#x8111;&#x53D1;&#x75AF;&#x3002;&#x7406;&#x60F3;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x4E2A;&#x5B8F;&#x5C06;&#x8FD9;&#x4E48;&#x7528;&#xFF1A;</p>
<p>Listing 9-2:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">-&gt;</span></span> (<span class="name">enqueue</span> &#x278A;saying &#x278B;(<span class="name">wait</span> <span class="number">200</span> <span class="string">&quot;&apos;Ello, gov&apos;na!&quot;</span>) &#x278C;(<span class="name">println</span> @saying))</span><br><span class="line">   &#x278D;(<span class="name">enqueue</span> saying (<span class="name">wait</span> <span class="number">400</span> <span class="string">&quot;Pip pip!&quot;</span>) (<span class="name">println</span> @saying))</span><br><span class="line">    (<span class="name">enqueue</span> saying (<span class="name">wait</span> <span class="number">100</span> <span class="string">&quot;Cheerio!&quot;</span>) (<span class="name">println</span> @saying)))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The macro lets you name the promise that gets created &#x278A;, define how to derive the value to deliver that promise &#x278B;, and define what to do with the promise &#x278C;. The macro can also take another <code>enqueue</code> macro call as its first argument, which lets you thread it &#x278D;. Listing 9-3 shows how you can define the <code>enqueue</code> macro. After defining <code>enqueue</code>, the code in Listing 9-2 will expand into the code in Listing 9-1, with all the nested <code>let</code> expressions:</p>
</blockquote>
<p>&#x4F4D;&#x7F6E;&#x278A;&#xFF1A;&#x547D;&#x540D;&#x521B;&#x5EFA;&#x7684;&#x627F;&#x8BFA;&#xFF0C;&#x278B;&#xFF1A;&#x5B9A;&#x4E49;&#x5982;&#x4F55;&#x5F97;&#x5230;&#x4EA4;&#x4ED8;&#x7ED9;&#x627F;&#x8BFA;&#x7684;&#x503C;&#xFF0C;&#x278C;:&#x5B9A;&#x4E49;&#x7528;&#x8FD9;&#x4E2A;&#x627F;&#x8BFA;&#x5E72;&#x4EC0;&#x4E48;&#x3002;&#x278D;&#xFF1A;&#x8FD9;&#x4E2A;&#x5B8F;&#x4E5F;&#x80FD;&#x63A5;&#x53D7;&#x53E6;&#x4E00;&#x4E2A;<code>enqueue</code>&#x5B8F;&#x8C03;&#x7528;&#x4F5C;&#x4E3A;&#x5176;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x4EE5;&#x4FBF;&#x4E8E;&#x628A;&#x4ED6;&#x4EEC;&#x4E32;&#x8D77;&#x6765;&#x3002;&#x5217;&#x8868;9-3&#x5C55;&#x793A;&#x4E86;&#x5982;&#x4F55;&#x5B9A;&#x4E49;<code>enqueue</code>&#x5B8F;&#x3002;&#x5B9A;&#x4E49;<code>enqueue</code>&#x4E4B;&#x540E;&#xFF0C;&#x5217;&#x8868;9-2&#x5C06;&#x88AB;&#x5C55;&#x5F00;&#x6210;&#x5217;&#x8868;9-1&#xFF0C;&#x5E26;&#x7740;&#x6240;&#x6709;&#x5F97;&#x5D4C;&#x5957;<code>let</code>&#x8868;&#x8FBE;&#x5F0F;&#xFF1A;</p>
<p>Listing 9-3:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defmacro</span></span> enqueue</span><br><span class="line">&#x278A;   ([q concurrent-promise-name concurrent serialized]</span><br><span class="line">&#x278B;    `(<span class="name"><span class="builtin-name">let</span></span> [~concurrent-promise-name (<span class="name"><span class="builtin-name">promise</span></span>)]</span><br><span class="line">      (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">deliver</span> ~concurrent-promise-name ~concurrent))</span><br><span class="line">&#x278C;       (<span class="name"><span class="builtin-name">deref</span></span> ~q)</span><br><span class="line">      ~serialized</span><br><span class="line">      ~concurrent-promise-name))</span><br><span class="line">&#x278D;   ([concurrent-promise-name concurrent serialized]</span><br><span class="line">   `(<span class="name">enqueue</span> (<span class="name"><span class="builtin-name">future</span></span>) ~concurrent-promise-name ~concurrent ~serialized)))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notice first that this macro has two arities in order to supply a default value. The first arity &#x278A; is where the real work is done. It has the parameter <code>q</code>, and the second arity does not. The second arity &#x278D; calls the first with value <code>(future)</code> supplied for <code>q</code>; you&#x2019;ll see why in a minute. At &#x278B;, the macro returns a form that creates a promise, delivers its value in a future, dereferences whatever form is supplied for <code>q</code>, evaluates the serialized code, and finally returns the promise. <code>q</code> will usually be a nested <code>let</code> expression returned by another call to <code>enqueue</code>, like in Listing 9-2. If no value is supplied for <code>q</code>, the macro supplies a future so that the <code>deref</code> at &#x278C; doesn&#x2019;t cause an exception.</p>
</blockquote>
<p>&#x9996;&#x5148;&#x6CE8;&#x610F;&#xFF0C;&#x8FD9;&#x4E2A;&#x5B8F;&#x6709;&#x4E24;&#x5957;&#x53C2;&#x6570;&#x4EE5;&#x4FBF;&#x4E8E;&#x63D0;&#x4F9B;&#x9ED8;&#x8BA4;&#x503C;&#x3002;&#x7B2C;&#x4E00;&#x5957;&#x53C2;&#x6570;(&#x278A;&#x5904;)&#x505A;&#x4E86;&#x771F;&#x6B63;&#x7684;&#x5DE5;&#x4F5C;&#x3002;&#x4ED6;&#x6709;&#x4E2A;&#x53C2;&#x6570;<code>q</code>&#xFF0C;&#x7B2C;&#x4E8C;&#x5957;&#x6CA1;&#x6709;&#x3002;&#x7B2C;&#x4E8C;&#x5957;&#x53C2;&#x6570;(&#x278D;&#x5904;)&#x8C03;&#x7528;&#x4E86;&#x7B2C;&#x4E00;&#x5957;&#xFF0C;&#x4E3A;<code>q</code>&#x63D0;&#x4F9B;&#x4E86;&#x503C;<code>(future)</code>&#xFF0C;&#x9A6C;&#x4E0A;&#x5C31;&#x4F1A;&#x89E3;&#x91CA;&#x8FD9;&#x4E48;&#x505A;&#x7684;&#x7528;&#x5904;&#x3002;&#x5728;&#x278B;&#x5904;&#xFF1A;&#x8FD9;&#x4E2A;&#x5B8F;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x5F62;&#x5F0F;&#xFF0C;&#x8FD9;&#x4E2A;&#x5F62;&#x5F0F;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x627F;&#x8BFA;&#xFF0C;&#x5728;&#x4E00;&#x4E2A;&#x672A;&#x6765;&#x91CC;&#x4EA4;&#x4ED8;&#x4E86;&#x8FD9;&#x4E2A;&#x627F;&#x8BFA;&#x7684;&#x503C;&#xFF0C;&#x5BF9;<code>q</code>&#x53D6;&#x503C;&#xFF0C;&#x6C42;&#x503C;&#x4E32;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x6700;&#x540E;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;&#x627F;&#x8BFA;&#x3002;&#x901A;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;<code>q</code>&#x5C06;&#x662F;&#x4E2A;&#x53E6;&#x4E00;&#x4E2A;<code>enqueue</code>&#x8C03;&#x7528;&#x8FD4;&#x56DE;&#x7684;&#x5D4C;&#x5957;&#x7684;<code>let</code>&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x50CF;&#x5217;&#x8868;9-2&#x90A3;&#x6837;&#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x503C;&#x63D0;&#x4F9B;&#x7ED9;<code>q</code>,&#x8FD9;&#x4E2A;&#x5B8F;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x672A;&#x6765;&#xFF0C;&#x4F7F;&#x278C;&#x5904;&#x7684;<code>deref</code>&#x4E0D;&#x4F1A;&#x9020;&#x6210;&#x5F02;&#x5E38;&#x3002;</p>
<blockquote>
<p>Now that we&#x2019;ve written the <code>enqueue</code> macro, let&#x2019;s try it out to see whether it reduces the execution time!</p>
</blockquote>
<p>&#x73B0;&#x5728;&#x6709;&#x4E86;<code>enqueue</code>&#x5B8F;&#xFF0C;&#x8BD5;&#x4E00;&#x4E0B;&#x5B83;&#x80FD;&#x5426;&#x51CF;&#x5C11;&#x6267;&#x884C;&#x65F6;&#x95F4;&#xFF01;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">time</span></span> @(<span class="name"><span class="builtin-name">-&gt;</span></span> (<span class="name">enqueue</span> saying (<span class="name">wait</span> <span class="number">200</span> <span class="string">&quot;&apos;Ello, gov&apos;na!&quot;</span>) (<span class="name">println</span> @saying))</span><br><span class="line">           (<span class="name">enqueue</span> saying (<span class="name">wait</span> <span class="number">400</span> <span class="string">&quot;Pip pip!&quot;</span>) (<span class="name">println</span> @saying))</span><br><span class="line">           (<span class="name">enqueue</span> saying (<span class="name">wait</span> <span class="number">100</span> <span class="string">&quot;Cheerio!&quot;</span>) (<span class="name">println</span> @saying))))</span><br><span class="line"><span class="comment">; =&gt; &apos;Ello, gov&apos;na!</span></span><br><span class="line"><span class="comment">; =&gt; Pip pip!</span></span><br><span class="line"><span class="comment">; =&gt; Cheerio!</span></span><br><span class="line"><span class="comment">; =&gt; &quot;Elapsed time: 401.635 msecs&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Blimey! The greeting is delivered in the correct order, and you can see by the elapsed time that the &#x201C;work&#x201D; of sleeping was handled concurrently.</p>
</blockquote>
<p>&#x554A;&#xFF01;&#x7ED3;&#x679C;&#x6B63;&#x786E;&#xFF0C;&#x4ECE;&#x65F6;&#x95F4;&#x770B;&#x90A3;&#x4E9B;&#x4F11;&#x7720;&#x90E8;&#x5206;&#x4E5F;&#x662F;&#x5E76;&#x884C;&#x6267;&#x884C;&#x7684;&#x3002;</p>
<blockquote>
<p>Summary</p>
</blockquote>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><blockquote>
<p>It&#x2019;s important for programmers like you to learn concurrent and parallel programming techniques so you can design programs that run efficiently on modern hardware. Concurrency refers to a program&#x2019;s ability to carry out more than one task, and in Clojure you achieve this by placing tasks on separate threads. Programs execute in parallel when a computer has more than one CPU, which allows more than one thread to be executed at the same time.</p>
</blockquote>
<p>&#x5B66;&#x4E60;&#x5E76;&#x53D1;&#x548C;&#x5E76;&#x884C;&#x7F16;&#x7A0B;&#x6280;&#x672F;&#xFF0C;&#x4EE5;&#x4FBF;&#x8BBE;&#x8BA1;&#x51FA;&#x80FD;&#x5728;&#x73B0;&#x4EE3;&#x786C;&#x4EF6;&#x4E0A;&#x9AD8;&#x6548;&#x8FD0;&#x884C;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x5BF9;&#x4E8E;&#x4F60;&#x8FD9;&#x6837;&#x7684;&#x7A0B;&#x5E8F;&#x5458;&#x662F;&#x5F88;&#x91CD;&#x8981;&#x7684;&#x4E8B;&#x60C5;&#x3002;&#x5E76;&#x53D1;&#x6307;&#x7A0B;&#x5E8F;&#x6267;&#x884C;&#x4E0D;&#x6B62;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#x7684;&#x80FD;&#x529B;&#xFF0C;&#x5728;Clojure&#x91CC;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x628A;&#x4EFB;&#x52A1;&#x653E;&#x5728;&#x72EC;&#x7ACB;&#x7684;&#x7EBF;&#x7A0B;&#x4E0A;&#x83B7;&#x5F97;&#x8FD9;&#x79CD;&#x80FD;&#x529B;&#x3002;&#x5F53;&#x8BA1;&#x7B97;&#x673A;&#x6709;&#x4E0D;&#x6B62;&#x4E00;&#x4E2A;CPU&#x65F6;&#x5019;&#xFF0C;&#x7A0B;&#x5E8F;&#x5E76;&#x884C;&#x6267;&#x884C;&#xFF0C;&#x8FD9;&#x6837;&#x540C;&#x4E00;&#x65F6;&#x95F4;&#x5C31;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x4E0D;&#x6B62;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x3002;</p>
<blockquote>
<p>Concurrent programming refers to the techniques used to manage three concurrency risks: reference cells, mutual exclusion, and deadlock. Clojure gives you three basic tools that help you mitigate those risks: futures, delays, and promises. Each tool lets you decouple the three events of defining a task, executing a task, and requiring a task&#x2019;s result. Futures let you define a task and execute it immediately, allowing you to require the result later or never. Futures also cache their results. Delays let you define a task that doesn&#x2019;t get executed until later, and a delay&#x2019;s result gets cached. Promises let you express that you require a result without having to know about the task that produces that result. You can only deliver a value to a promise once.</p>
</blockquote>
<p>&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x6307;&#x7528;&#x4E8E;&#x7BA1;&#x7406;&#x4E09;&#x79CD;&#x5E76;&#x53D1;&#x98CE;&#x9669;(&#x5F15;&#x7528;&#x5355;&#x5143;&#xFF0C;&#x4E92;&#x65A5;&#xFF0C;&#x6B7B;&#x9501;)&#x7684;&#x6280;&#x672F;&#x3002;Clojure&#x63D0;&#x4F9B;&#x4E86;&#x4E09;&#x4E2A;&#x57FA;&#x672C;&#x5DE5;&#x5177;&#x5E2E;&#x52A9;&#x4F60;&#x51CF;&#x5C11;&#x8FD9;&#x4E9B;&#x98CE;&#x9669;&#xFF1A;&#x672A;&#x6765;&#xFF0C;&#x5EF6;&#x671F;&#xFF0C;&#x627F;&#x8BFA;&#x3002;&#x4F7F;&#x4F60;&#x80FD;&#x89E3;&#x8026;&#x5B9A;&#x4E49;&#x4EFB;&#x52A1;&#xFF0C;&#x6267;&#x884C;&#x4EFB;&#x52A1;&#xFF0C;&#x83B7;&#x53D6;&#x4EFB;&#x52A1;&#x7ED3;&#x679C;&#x3002;&#x672A;&#x6765;&#x5B9A;&#x4E49;&#x5E76;&#x7ACB;&#x523B;&#x6267;&#x884C;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x8BF7;&#x6C42;&#x6216;&#x4E0D;&#x8BF7;&#x6C42;&#x7ED3;&#x679C;&#x3002;&#x672A;&#x6765;&#x4E5F;&#x7F13;&#x5B58;&#x7ED3;&#x679C;&#x3002;&#x5EF6;&#x671F;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x4EE5;&#x540E;&#x6267;&#x884C;&#x7684;&#x4EFB;&#x52A1;&#xFF0C;&#x5EF6;&#x671F;&#x7684;&#x7ED3;&#x679C;&#x4E5F;&#x7F13;&#x5B58;&#x3002;&#x627F;&#x8BFA;&#x8BA9;&#x4F60;&#x53EF;&#x4EE5;&#x8BF7;&#x6C42;&#x4E00;&#x4E2A;&#x7ED3;&#x679C;&#xFF0C;&#x800C;&#x4E0D;&#x7528;&#x5FC5;&#x987B;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x4EA7;&#x751F;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#x3002;&#x5BF9;&#x4E00;&#x4E2A;&#x627F;&#x8BFA;&#x53EA;&#x80FD;&#x4EA4;&#x4ED8;&#x4E00;&#x6B21;&#x503C;&#x3002;</p>
<blockquote>
<p>In the next chapter, you&#x2019;ll explore the philosophical side of concurrent programming and learn more sophisticated tools for managing the risks.</p>
</blockquote>
<p>&#x4E0B;&#x7AE0;&#x5C06;&#x63A2;&#x7D22;&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x7684;&#x54F2;&#x5B66;&#x65B9;&#x9762;&#xFF0C;&#x4F1A;&#x5B66;&#x4E60;&#x66F4;&#x591A;&#x7BA1;&#x7406;&#x8FD9;&#x4E9B;&#x98CE;&#x9669;&#x590D;&#x6742;&#x5DE5;&#x5177;&#x3002;</p>
<blockquote>
<p>Exercises</p>
</blockquote>
<h2 id="&#x7EC3;&#x4E60;"><a href="#&#x7EC3;&#x4E60;" class="headerlink" title="&#x7EC3;&#x4E60;"></a>&#x7EC3;&#x4E60;</h2><blockquote>
<ol>
<li>Write a function that takes a string as an argument and searches for it on Bing and Google using the <code>slurp</code> function. Your function should return the HTML of the first page returned by the search.</li>
<li>Update your function so it takes a second argument consisting of the search engines to use.</li>
<li>Create a new function that takes a search term and search engines as arguments, and returns a vector of the URLs from the first page of search results from each search engine.</li>
</ol>
</blockquote>
<ol>
<li><p>&#x5199;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x53C2;&#x6570;&#xFF0C;&#x7528;<code>slurp</code>&#x5728;Google&#x548C;Bing&#x4E0A;&#x641C;&#x7D22;&#x5B83;&#x3002;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x641C;&#x7D22;&#x8FD4;&#x56DE;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;HTML&#x3002;</p>
</li>
<li><p>&#x66F4;&#x65B0;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x63A5;&#x53D7;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x8868;&#x793A;&#x641C;&#x7D22;&#x5F15;&#x64CE;&#x3002;</p>
</li>
<li><p>&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x641C;&#x7D22;&#x9879;&#x548C;&#x591A;&#x4E2A;&#x5F15;&#x64CE;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;&#x6BCF;&#x4E2A;&#x641C;&#x7D22;&#x5F15;&#x64CE;&#x7B2C;&#x4E00;&#x9875;&#x641C;&#x7D22;&#x7ED3;&#x679C;&#x91CC;&#x7684;URL&#x7EC4;&#x6210;&#x7684;vector&#x3002;</p>
</li>
</ol>
<hr>
<p>&#x8BD1;&#x6587;&#x7ED3;&#x675F;&#x3002;</p>

      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Clojure/" rel="tag">#Clojure</a>
          
            <a href="/tags/Clojure-For-The-Branve-And-True/" rel="tag">#Clojure For The Branve And True</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/03/express-demo/" rel="next" title="用Express搭建Api演示">
                <i class="fa fa-chevron-left"></i> 用Express搭建Api演示
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/22/clojure-metaphysics/" rel="prev" title="【译】第十章:Clojure哲学体系:Atom, Refs, Vars与抱抱僵尸">
                【译】第十章:Clojure哲学体系:Atom, Refs, Vars与抱抱僵尸 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://s.gravatar.com/avatar/954a8b1f4c32dbb5a11399ae5e236a5f?s=80"
               alt="胡军" />
          <p class="site-author-name" itemprop="name">胡军</p>
          <p class="site-description motion-element" itemprop="description">immutable values from past</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">22</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>
          
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/morrxy" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#并发与并行概念"><span class="nav-number">1.</span> <span class="nav-text">并发与并行概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#管理多任务与同时执行多任务"><span class="nav-number">1.1.</span> <span class="nav-text">管理多任务与同时执行多任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#阻塞与异步任务"><span class="nav-number">1.2.</span> <span class="nav-text">阻塞与异步任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#并发编程与并行编程"><span class="nav-number">1.3.</span> <span class="nav-text">并发编程与并行编程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Clojure实现：JVM线程"><span class="nav-number">2.</span> <span class="nav-text">Clojure实现：JVM线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是线程？"><span class="nav-number">2.1.</span> <span class="nav-text">什么是线程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三只哥布林：引用单元，互斥，矮人狂暴者"><span class="nav-number">2.2.</span> <span class="nav-text">三只哥布林：引用单元，互斥，矮人狂暴者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#未来-future-，延期-delay-和承诺-promise"><span class="nav-number">3.</span> <span class="nav-text">未来(future)，延期(delay)和承诺(promise)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#未来"><span class="nav-number">3.1.</span> <span class="nav-text">未来</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#延期"><span class="nav-number">3.2.</span> <span class="nav-text">延期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#承诺"><span class="nav-number">3.3.</span> <span class="nav-text">承诺</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自建队列"><span class="nav-number">3.4.</span> <span class="nav-text">自建队列</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习"><span class="nav-number">5.</span> <span class="nav-text">练习</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">胡军</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.scheme !== 'Pisces' && (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always')) {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'morrxy';
      var disqus_identifier = '2016/07/15/braveclojure-concurrency/';
      var disqus_title = '【译】第九章:并发与并行编程';
      var disqus_url = 'http://yoursite.com/2016/07/15/braveclojure-concurrency/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  

  


</body>
</html>
