<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Clojure,Clojure For The Branve And True," />





  <link rel="alternate" href="/atom.xml" title="胡军的网络日志" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="&amp;#x672C;&amp;#x6587;&amp;#x662F;&amp;#x6211;&amp;#x5BF9;Clojure&amp;#x4E66;&amp;#x7C4D; CLOJURE FOR THE BRAVE AND TRUE&amp;#x7B2C;&amp;#x5341;&amp;#x7AE0;Clojure Metaphysics: Atoms, Refs, Vars, and Cuddle Zombies &amp;#x505A;&amp;#x7684;&amp;#x7FFB">
<meta property="og:type" content="article">
<meta property="og:title" content="【译】第十章:Clojure哲学体系:Atom, Refs, Vars与抱抱僵尸">
<meta property="og:url" content="http://yoursite.com/2016/07/22/clojure-metaphysics/index.html">
<meta property="og:site_name" content="胡军的网络日志">
<meta property="og:description" content="&amp;#x672C;&amp;#x6587;&amp;#x662F;&amp;#x6211;&amp;#x5BF9;Clojure&amp;#x4E66;&amp;#x7C4D; CLOJURE FOR THE BRAVE AND TRUE&amp;#x7B2C;&amp;#x5341;&amp;#x7AE0;Clojure Metaphysics: Atoms, Refs, Vars, and Cuddle Zombies &amp;#x505A;&amp;#x7684;&amp;#x7FFB">
<meta property="og:image" content="http://yoursite.com/2016/07/22/clojure-metaphysics/cuddle-zombie.png">
<meta property="og:image" content="http://yoursite.com/2016/07/22/clojure-metaphysics/fred-read.png">
<meta property="og:image" content="http://yoursite.com/2016/07/22/clojure-metaphysics/fp-metaphysics.png">
<meta property="og:image" content="http://yoursite.com/2016/07/22/clojure-metaphysics/sock-gnome.png">
<meta property="og:image" content="http://yoursite.com/2016/07/22/clojure-metaphysics/troll.png">
<meta property="og:image" content="http://yoursite.com/2016/07/22/clojure-metaphysics/pmap-small-grain.png">
<meta property="og:image" content="http://yoursite.com/2016/07/22/clojure-metaphysics/ppmap.png">
<meta property="og:updated_time" content="2016-07-22T14:00:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【译】第十章:Clojure哲学体系:Atom, Refs, Vars与抱抱僵尸">
<meta name="twitter:description" content="&amp;#x672C;&amp;#x6587;&amp;#x662F;&amp;#x6211;&amp;#x5BF9;Clojure&amp;#x4E66;&amp;#x7C4D; CLOJURE FOR THE BRAVE AND TRUE&amp;#x7B2C;&amp;#x5341;&amp;#x7AE0;Clojure Metaphysics: Atoms, Refs, Vars, and Cuddle Zombies &amp;#x505A;&amp;#x7684;&amp;#x7FFB">
<meta name="twitter:image" content="http://yoursite.com/2016/07/22/clojure-metaphysics/cuddle-zombie.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 【译】第十章:Clojure哲学体系:Atom, Refs, Vars与抱抱僵尸 | 胡军的网络日志 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">胡军的网络日志</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'wmG9FieA3KCB8x2CXpVc','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                【译】第十章:Clojure哲学体系:Atom, Refs, Vars与抱抱僵尸
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-22T21:51:52+08:00" content="2016-07-22">
              2016-07-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/22/clojure-metaphysics/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/22/clojure-metaphysics/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>&#x672C;&#x6587;&#x662F;&#x6211;&#x5BF9;Clojure&#x4E66;&#x7C4D; <a href="http://www.braveclojure.com/clojure-for-the-brave-and-true/" target="_blank" rel="external">CLOJURE FOR THE BRAVE AND TRUE</a>&#x7B2C;&#x5341;&#x7AE0;<a href="http://www.braveclojure.com/zombie-metaphysics/" target="_blank" rel="external">Clojure Metaphysics: Atoms, Refs, Vars, and Cuddle Zombies</a> &#x505A;&#x7684;&#x7FFB;&#x8BD1;&#x3002;&#x7FFB;&#x8BD1;&#x5F62;&#x5F0F;&#xFF0C;&#x4E2D;&#x82F1;&#x5BF9;&#x7167;&#xFF0C;&#x82F1;&#x6587;&#x5F15;&#x7528;&#x8DDF;&#x7740;&#x4E2D;&#x6587;&#x7FFB;&#x8BD1;&#x3002;&#x5982;&#x6709;&#x9519;&#x8BEF;&#xFF0C;&#x5728;&#x6240;&#x96BE;&#x514D;&#xFF0C;&#x6B22;&#x8FCE;&#x6307;&#x6B63;&#x3002;</p>
<p><a href="https://morrxy.github.io/tags/Clojure-For-The-Branve-And-True/" target="_blank" rel="external">&#x5176;&#x4ED6;&#x7AE0;&#x7684;&#x7FFB;&#x8BD1;&#x5728;&#x8FD9;&#x91CC;</a>&#x3002;</p>
<p>&#x8BD1;&#x6587;&#x5F00;&#x59CB;&#x3002;</p>
<hr>
<blockquote>
<p>The Three Concurrency Goblins are all spawned from the same pit of evil: shared access to mutable state. You can see this in the reference cell discussion in Chapter 9. When two threads make uncoordinated changes to the reference cell, the result is unpredictable.</p>
</blockquote>
<p>&#x4E09;&#x4E2A;&#x5E76;&#x53D1;&#x54E5;&#x5E03;&#x6797;&#x90FD;&#x4EA7;&#x751F;&#x4E8E;&#x540C;&#x6837;&#x7684;&#x90AA;&#x6076;&#x9677;&#x9631;&#xFF1A;&#x5171;&#x4EAB;&#x53EF;&#x66F4;&#x6539;&#x72B6;&#x6001;&#x7684;&#x8BBF;&#x95EE;&#x6743;&#x3002;&#x5728;&#x7B2C;9&#x7AE0;&#x7684;&#x5F15;&#x7528;&#x5355;&#x5143;&#x7684;&#x8BA8;&#x8BBA;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x3002;&#x5F53;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#x5BF9;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x5355;&#x5143;&#x8FDB;&#x884C;&#x4E0D;&#x534F;&#x8C03;&#x5730;&#x4FEE;&#x6539;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7ED3;&#x679C;&#x662F;&#x4E0D;&#x53EF;&#x9884;&#x6599;&#x7684;&#x3002;</p>
<blockquote>
<p>Rich Hickey designed Clojure to specifically address the problems that develop from shared access to mutable state. In fact, Clojure embodies a very clear conception of state that makes it inherently safer for concurrency than most popular programming languages. It&#x2019;s safe all the way down to its <code>meta-freakin-physics</code>.</p>
</blockquote>
<p>Rich Hickey&#x5BF9;Clojure&#x8FDB;&#x884C;&#x4E86;&#x7279;&#x522B;&#x8BBE;&#x8BA1;&#xFF0C;&#x4EE5;&#x89E3;&#x51B3;&#x5171;&#x4EAB;&#x53EF;&#x66F4;&#x6539;&#x72B6;&#x6001;&#x7684;&#x8BBF;&#x95EE;&#x6743;&#x5E26;&#x6765;&#x7684;&#x95EE;&#x9898;&#x3002;&#x4E8B;&#x5B9E;&#x4E0A;&#xFF0C;Clojure&#x4F53;&#x73B0;&#x4E86;&#x4E00;&#x79CD;&#x975E;&#x5E38;&#x6E05;&#x6670;&#x7684;&#x72B6;&#x6001;&#x6982;&#x5FF5;&#xFF0C;&#x4F7F;Clojure&#x5728;&#x5E76;&#x53D1;&#x4E0A;&#x5929;&#x751F;&#x5C31;&#x6BD4;&#x5927;&#x591A;&#x6570;&#x6D41;&#x884C;&#x7684;&#x7F16;&#x7A0B;&#x8BED;&#x8A00;&#x5B89;&#x5168;&#x3002;&#x5B83;&#x7684;&#x4E00;&#x5207;&#x90FD;&#x662F;&#x5B89;&#x5168;&#x7684;&#xFF0C;&#x8FDE;&#x540C;&#x5B83;&#x7684;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;&#x4E5F;&#x662F;&#x5B89;&#x5168;&#x7684;&#x3002;</p>
<blockquote>
<p>In this chapter, you&#x2019;ll learn about Clojure&#x2019;s underlying metaphysics, as compared to the metaphysics of typical object-oriented (OO) languages. Learning this philosophy will prepare you to handle Clojure&#x2019;s remaining concurrency tools, the atom, ref, and var reference types. (Clojure has one additional reference type, agents, which this book doesn&#x2019;t cover.) Each of these types enables you to safely perform state-modifying operations concurrently. You&#x2019;ll also learn about easy ways to make your program more efficient without introducing state at all.</p>
</blockquote>
<p>&#x8FD9;&#x7AE0;&#x5C06;&#x5B66;&#x4E60;Clojure&#x7684;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;&#xFF0C;&#x5E76;&#x4E0E;&#x5176;&#x4ED6;&#x9762;&#x76F8;&#x5BF9;&#x8C61;&#x8BED;&#x8A00;&#x7684;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#x3002;&#x8FD9;&#x5C06;&#x4F7F;&#x4F60;&#x505A;&#x597D;&#x51C6;&#x5907;&#xFF0C;&#x8FD0;&#x7528;Clojure&#x7684;&#x5E76;&#x53D1;&#x5DE5;&#x5177;&#xFF0C;atom, ref, &#x548C; var &#x5F15;&#x7528;&#x7C7B;&#x578B;&#x3002;(Clojure&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#xFF0C;agents,&#x672C;&#x4E66;&#x6CA1;&#x6709;&#x8BB2;&#x89E3;&#x3002;)&#x6BCF;&#x4E2A;&#x7C7B;&#x578B;&#x90FD;&#x80FD;&#x8BA9;&#x4F60;&#x5B89;&#x5168;&#x5730;&#x5E76;&#x53D1;&#x6267;&#x884C;&#x72B6;&#x6001;&#x4FEE;&#x6539;&#x64CD;&#x4F5C;&#x3002;&#x8FD9;&#x7AE0;&#x6211;&#x4EEC;&#x8FD8;&#x4F1A;&#x5B66;&#x4E60;&#x4E00;&#x4E9B;&#x65B9;&#x6CD5;&#xFF0C;&#x4F7F;&#x4F60;&#x5B8C;&#x5168;&#x4E0D;&#x7528;&#x5F15;&#x5165;&#x72B6;&#x6001;&#xFF0C;&#x4ECE;&#x800C;&#x66F4;&#x9AD8;&#x6548;&#x5730;&#x7F16;&#x7A0B;&#x3002;</p>
<blockquote>
<p>Metaphysics attempts to answer two basic questions in the broadest possible terms:</p>
</blockquote>
<p>&#x54F2;&#x5B66;&#x4F53;&#x7CFB;&#x4ECE;&#x5C3D;&#x53EF;&#x80FD;&#x5E7F;&#x6CDB;&#x7684;&#x65B9;&#x9762;&#xFF0C;&#x5C1D;&#x8BD5;&#x56DE;&#x7B54;&#x4E24;&#x4E2A;&#x57FA;&#x672C;&#x95EE;&#x9898;&#xFF1A;</p>
<blockquote>
<ul>
<li>What is there?</li>
<li>What is it like?</li>
</ul>
</blockquote>
<ul>
<li>&#x6709;&#x4EC0;&#x4E48;&#xFF1F;</li>
<li>&#x50CF;&#x4EC0;&#x4E48;&#xFF1F;</li>
</ul>
<blockquote>
<p>To draw out the differences between Clojure and OO languages, I&#x2019;ll explain two different ways of modeling a cuddle zombie. Unlike a regular zombie, a cuddle zombie does not want to devour your brains. It only wants to spoon you and maybe smell your neck. That makes its undead, shuffling, decaying state all the more tragic. How could you try to kill something that only wants love? Who&#x2019;s the real monster here?</p>
</blockquote>
<p>&#x4E3A;&#x4E86;&#x8BF4;&#x660E;Clojure&#x4E0E;OO&#x8BED;&#x8A00;&#x7684;&#x533A;&#x522B;&#xFF0C;&#x6211;&#x5C06;&#x89E3;&#x91CA;&#x4E24;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x7528;&#x4E8E;&#x5EFA;&#x6A21;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x3002;&#x4E0E;&#x666E;&#x901A;&#x50F5;&#x5C38;&#x4E0D;&#x540C;&#xFF0C;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x4E0D;&#x60F3;&#x541E;&#x5403;&#x4F60;&#x7684;&#x5927;&#x8111;&#x3002;&#x5B83;&#x53EA;&#x60F3;&#x7231;&#x629A;&#x4F60;&#xFF0C;&#x4E5F;&#x8BB8;&#x4F1A;&#x95FB;&#x95FB;&#x4F60;&#x7684;&#x8116;&#x5B50;&#x3002;&#x8FD9;&#x4F7F;&#x5B83;&#x7684;&#x4E0D;&#x6B7B;&#xFF0C;&#x6447;&#x6643;&#x7740;&#x884C;&#x8D70;&#xFF0C;&#x6B63;&#x5728;&#x8150;&#x70C2;&#x7684;&#x72B6;&#x6001;&#x66F4;&#x52A0;&#x60B2;&#x60E8;&#x3002;&#x4F60;&#x600E;&#x4E48;&#x80FD;&#x5C1D;&#x8BD5;&#x6740;&#x6B7B;&#x53EA;&#x60F3;&#x8981;&#x7231;&#x7684;&#x4E1C;&#x897F;&#xFF1F;&#x8C01;&#x624D;&#x662F;&#x771F;&#x6B63;&#x7684;&#x602A;&#x7269;&#xFF1F;</p>
<blockquote>
<p>Object-Oriented Metaphysics</p>
</blockquote>
<h2 id="&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;"><a href="#&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;" class="headerlink" title="&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;"></a>&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;</h2><blockquote>
<p>OO metaphysics treats the cuddle zombie as an object that exists in the world. The object has properties that may change over time, but it&#x2019;s still treated as a single, constant object. If that seems like a totally obvious, uncontroversial approach to zombie metaphysics, you probably haven&#x2019;t spent hours in an intro philosophy class arguing about what it means for a chair to exist and what really makes it a chair in the first place.</p>
</blockquote>
<p>&#x9762;&#x76F8;&#x5BF9;&#x8C61;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;&#x628A;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x5F53;&#x4F5C;&#x4E00;&#x4E2A;&#x4E16;&#x754C;&#x4E0A;&#x5B58;&#x5728;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x6709;&#x53EF;&#x80FD;&#x968F;&#x7740;&#x65F6;&#x95F4;&#x53D8;&#x5316;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x4F46;&#x5B83;&#x4ECD;&#x7136;&#x88AB;&#x770B;&#x4F5C;&#x4E00;&#x4E2A;&#x5355;&#x4E00;&#xFF0C;&#x6301;&#x4E45;&#x7684;&#x5BF9;&#x8C61;&#x3002;&#x5982;&#x679C;&#x8FD9;&#x770B;&#x8D77;&#x6765;&#x50CF;&#x4E00;&#x4E2A;&#x5B8C;&#x5168;&#x660E;&#x663E;&#xFF0C;&#x6BEB;&#x65E0;&#x4E89;&#x8BAE;&#x7684;&#x50F5;&#x5C38;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x53EF;&#x80FD;&#x6CA1;&#x6709;&#x5728;&#x54F2;&#x5B66;&#x4ECB;&#x7ECD;&#x8BFE;&#x91CC;&#x82B1;&#x8D39;&#x8FC7;&#x51E0;&#x4E2A;&#x5C0F;&#x65F6;&#xFF0C;&#x8BA8;&#x8BBA;&#x4E00;&#x4E2A;&#x6905;&#x5B50;&#x5B58;&#x5728;&#x610F;&#x5473;&#x7740;&#x4EC0;&#x4E48;&#xFF0C;&#x548C;&#x662F;&#x4EC0;&#x4E48;&#x7B2C;&#x4E00;&#x6B21;&#x4F7F;&#x5B83;&#x771F;&#x6B63;&#x5B58;&#x5728;&#x3002;</p>
<blockquote>
<p>The tricky part is that the cuddle zombie is always changing. Its body slowly deteriorates. Its undying hunger for cuddles grows fiercer with time. In OO terms, we would say that the cuddle zombie is an object with mutable state and that its state is ever fluctuating. But no matter how much the zombie changes, we still identify it as the same zombie. Here&#x2019;s how you might model and interact with a cuddle zombie in Ruby:</p>
</blockquote>
<p>&#x68D8;&#x624B;&#x7684;&#x662F;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x4E00;&#x76F4;&#x5728;&#x53D8;&#x5316;&#x3002;&#x5B83;&#x7684;&#x8EAB;&#x4F53;&#x6162;&#x6162;&#x8150;&#x70C2;&#x3002;&#x5B83;&#x5BF9;&#x62E5;&#x62B1;&#x7684;&#x6E34;&#x671B;&#x968F;&#x7740;&#x65F6;&#x95F4;&#x8D8A;&#x6765;&#x8D8A;&#x5F3A;&#x70C8;&#x3002;&#x7528;&#x9762;&#x76F8;&#x5BF9;&#x8C61;&#x7684;&#x672F;&#x8BED;&#xFF0C;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x8BF4;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x662F;&#x4E00;&#x4E2A;&#x5E26;&#x6709;&#x53EF;&#x53D8;&#x72B6;&#x6001;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x4E14;&#x5B83;&#x7684;&#x72B6;&#x6001;&#x4E00;&#x76F4;&#x5728;&#x6539;&#x53D8;&#x3002;&#x4F46;&#x65E0;&#x8BBA;&#x5B83;&#x600E;&#x4E48;&#x53D8;&#xFF0C;&#x5B83;&#x4ECD;&#x7136;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x50F5;&#x5C38;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x5982;&#x4F55;&#x7528;Ruby&#x5EFA;&#x6A21;&#x5E76;&#x4E0E;&#x4E00;&#x4E2A;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#xFF1A;</p>
<blockquote>
<p>10-1. Modeling cuddle zombie behavior with Ruby</p>
</blockquote>
<p>10-1. &#x7528;Ruby&#x5EFA;&#x6A21;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x7684;&#x884C;&#x4E3A;</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CuddleZombie</span></span></span><br><span class="line">  <span class="comment"># attr_accessor is just a shorthand way for creating getters and</span></span><br><span class="line">  <span class="comment"># setters for the listed instance variables</span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:cuddle_hunger_level</span>, <span class="symbol">:percent_deteriorated</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(cuddle_hunger_level = <span class="number">1</span>, percent_deteriorated = <span class="number">0</span>)</span></span></span><br><span class="line">    <span class="keyword">self</span>.cuddle_hunger_level = cuddle_hunger_level</span><br><span class="line">    <span class="keyword">self</span>.percent_deteriorated = percent_deteriorated</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">fred = CuddleZombie.new(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">fred.cuddle_hunger_level  <span class="comment"># =&gt; 2</span></span><br><span class="line">fred.percent_deteriorated <span class="comment"># =&gt; 3</span></span><br><span class="line"></span><br><span class="line">fred.cuddle_hunger_level = <span class="number">3</span></span><br><span class="line">fred.cuddle_hunger_level <span class="comment"># =&gt; 3</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>In this example, you create a cuddle zombie, <code>fred</code>, with two attributes: <code>cuddle_hunger_level</code> and <code>percent_deteriorated</code>. <code>fred</code> starts out with a <code>cuddle_hunger_level</code> of just 2, but you can change it to whatever you want and it&#x2019;s still good ol&#x2019; Fred, the same cuddle zombie. In this case, you changed its <code>cuddle_hunger_level</code> to 3.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#xFF0C;<code>fred</code>,&#x6709;&#x4E24;&#x4E2A;&#x5C5E;&#x6027;&#xFF1A;<code>cuddle_hunger_level</code>,&#x548C;<code>percent_deteriorated</code>&#x3002;<code>fred</code>&#x5F00;&#x59CB;&#x7684;<code>cuddle_hunger_level</code>&#x662F;2&#xFF0C;&#x4F46;&#x4EFB;&#x4F55;&#x65F6;&#x5019;&#xFF0C;&#x53EA;&#x8981;&#x4F60;&#x613F;&#x610F;&#xFF0C;&#x4F60;&#x90FD;&#x80FD;&#x6539;&#x53D8;&#x8FD9;&#x4E2A;&#x5C5E;&#x6027;&#xFF0C;&#x800C;&#x5B83;&#x8FD8;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x8001;&#x670B;&#x53CB;Fred,&#x540C;&#x4E00;&#x4E2A;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x3002;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x4F60;&#x628A;<code>cuddle_hunger_level</code>&#x6539;&#x6210;&#x4E86;3&#x3002;</p>
<p><img src="/2016/07/22/clojure-metaphysics/cuddle-zombie.png" alt="cuddle-zombie"></p>
<blockquote>
<p>You can see that this object is just a fancy reference cell. It&#x2019;s subject to the same nondeterministic results in a multithreaded environment. For example, if two threads try to increment Fred&#x2019;s hunger level with something like <code>fred.cuddle_hunger_level = fred.cuddle_hunger_level + 1</code>, one of the increments could be lost, just like in the example with two threads writing to <code>X</code> in &#x201C;The Three Goblins: Reference Cells, Mutual Exclusion, and Dwarven Berserkers&#x201D; on page 193.</p>
</blockquote>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x795E;&#x5947;&#x7684;&#x5F15;&#x7528;&#x5355;&#x5143;&#x3002;&#x5B83;&#x540C;&#x6837;&#x53D7;&#x5236;&#x4E8E;&#x591A;&#x7EBF;&#x7A0B;&#x73AF;&#x5883;&#x4E0B;&#x7684;&#x4E0D;&#x786E;&#x5B9A;&#x6027;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#x5C1D;&#x8BD5;&#x589E;&#x52A0;&#x5F17;&#x96F7;&#x5FB7;&#x7684;&#x6E34;&#x671B;&#x7EA7;&#x522B;&#xFF0C;&#x7528;&#x7C7B;&#x4F3C;&#x8FD9;&#x6837;&#x7684;&#x4EE3;&#x7801;&#xFF0C;<code>fred.cuddle_hunger_level = fred.cuddle_hunger_level + 1</code>,&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x589E;&#x52A0;&#x4F1A;&#x4E22;&#x5931;&#xFF0C;&#x5C31;&#x50CF;193&#x9875;&#x7684;&#x4E09;&#x4E2A;&#x54E5;&#x5E03;&#x6797;&#x7684;&#x4F8B;&#x5B50;&#x4E00;&#x6837;&#xFF0C;&#x90A3;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;&#x6709;&#x4E24;&#x4E2A;&#x8FDB;&#x7A0B;&#x5BF9;<code>X</code>&#x8FDB;&#x884C;&#x5199;&#x64CD;&#x4F5C;,<a href="https://morrxy.github.io/2016/07/15/braveclojure-concurrency/#&#x4E09;&#x53EA;&#x54E5;&#x5E03;&#x6797;&#xFF1A;&#x5F15;&#x7528;&#x5355;&#x5143;&#xFF0C;&#x4E92;&#x65A5;&#xFF0C;&#x77EE;&#x4EBA;&#x72C2;&#x66B4;&#x8005;" target="_blank" rel="external">&#x70B9;&#x51FB;&#x67E5;&#x770B;</a>&#x3002;</p>
<blockquote>
<p>Even if you&#x2019;re only performing reads on a separate thread, the program will still be nondeterministic. For example, suppose you&#x2019;re conducting research on cuddle zombie behavior. You want to log a zombie&#x2019;s hunger level whenever it reaches 50 percent deterioration, but you want to do this on another thread to increase performance, using code like that in Listing 10-1:</p>
</blockquote>
<p>&#x5373;&#x4F7F;&#x4F60;&#x53EA;&#x5728;&#x72EC;&#x7ACB;&#x7EBF;&#x7A0B;&#x4E0A;&#x8FDB;&#x884C;&#x8BFB;&#x64CD;&#x4F5C;&#xFF0C;&#x7A0B;&#x5E8F;&#x4F9D;&#x7136;&#x662F;&#x4E0D;&#x786E;&#x5B9A;&#x7684;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5047;&#x8BBE;&#x4F60;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x7684;&#x884C;&#x4E3A;&#x7814;&#x7A76;&#x3002;&#x5F53;&#x4E00;&#x4E2A;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x7684;&#x6E34;&#x671B;&#x7EA7;&#x522B;&#x5230;&#x8FBE;&#x767E;&#x5206;&#x4E4B;&#x4E94;&#x5341;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F60;&#x5E0C;&#x671B;&#x8BB0;&#x5F55;&#x4E0B;&#x6765;&#xFF0C;&#x4F46;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#xFF0C;&#x4F60;&#x60F3;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x4E0A;&#x5E72;&#x8FD9;&#x4EF6;&#x4E8B;&#xFF0C;&#x4F7F;&#x7528;&#x50CF;&#x5217;&#x8868;10-1&#x8FD9;&#x6837;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<p><em>This Ruby code isn&#x2019;t safe for concurrent execution.</em></p>
<p>&#x8FD9;&#x4E2A;Ruby&#x4EE3;&#x7801;&#x5BF9;&#x4E8E;&#x5E76;&#x53D1;&#x6267;&#x884C;&#x662F;&#x4E0D;&#x5B89;&#x5168;&#x7684;&#x3002;</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> fred.percent_deteriorated &gt;= <span class="number">50</span></span><br><span class="line">  Thread.new { database_logger.log(fred.cuddle_hunger_level) }</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>The problem is that another thread could change fred before the write actually takes place.</p>
</blockquote>
<p>&#x95EE;&#x9898;&#x5728;&#x4E8E;&#xFF0C;&#x5199;&#x64CD;&#x4F5C;&#x771F;&#x6B63;&#x53D1;&#x751F;&#x524D;&#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x53EF;&#x80FD;&#x6539;&#x53D8;&#x5F17;&#x96F7;&#x5FB7;&#x3002;</p>
<blockquote>
<p>For example, Figure 10-1 shows two threads executing from top to bottom. In this situation, it would be correct to write 5 to the database, but 10 gets written instead.</p>
</blockquote>
<p>&#x4F8B;&#x5982;&#xFF0C;&#x56FE;10-1&#x6F14;&#x793A;&#x4E86;&#x4ECE;&#x4E0A;&#x81F3;&#x4E0B;&#x6267;&#x884C;&#x7684;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#x3002;&#x8FD9;&#x4E2A;&#x60C5;&#x51B5;&#x91CC;&#xFF0C;&#x6570;&#x636E;&#x5E93;&#x91CC;&#x5199;&#x5165;5&#x5E94;&#x8BE5;&#x662F;&#x5BF9;&#x7684;&#xFF0C;&#x4F46;&#x5199;&#x5165;&#x7684;&#x662F;10&#x3002;</p>
<p><em>Figure 10-1: Logging inconsistent cuddle zombie data</em></p>
<p><em>&#x56FE; 10-1: &#x8BB0;&#x5F55;&#x4E0D;&#x4E00;&#x81F4;&#x7684;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x6570;&#x636E;</em></p>
<p><img src="/2016/07/22/clojure-metaphysics/fred-read.png" alt="fred-read"></p>
<blockquote>
<p>This would be unfortunate. You don&#x2019;t want your data to be inconsistent when you&#x2019;re trying to recover from the cuddle zombie apocalypse. However, there&#x2019;s no way to retain the state of an object at a specific moment in time.</p>
</blockquote>
<p>&#x8FD9;&#x5F88;&#x4E0D;&#x5E78;&#x3002;&#x5F53;&#x5C1D;&#x8BD5;&#x4ECE;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x707E;&#x53D8;&#x6062;&#x590D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F60;&#x4E0D;&#x60F3;&#x8981;&#x4E0D;&#x4E00;&#x81F4;&#x7684;&#x6570;&#x636E;&#x3002;&#x4F46;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x4FDD;&#x7559;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x67D0;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x65F6;&#x523B;&#x7684;&#x72B6;&#x6001;&#x3002;</p>
<blockquote>
<p>Additionally, in order to change the <code>cuddle_hunger_level</code> and <code>percent_deteriorated</code> simultaneously, you must be extra careful. Otherwise, it&#x2019;s possible for <code>fred</code> to be viewed in an inconsistent state, because another thread might <code>read</code> the <code>fred</code> object in between the two changes that you intend to be simultaneous, like so:</p>
</blockquote>
<p>&#x53E6;&#x5916;&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x8981;&#x540C;&#x65F6;&#x6539;&#x53D8;<code>cuddle_hunger_level</code>&#x548C;<code>percent_deteriorated</code>&#xFF0C;&#x4F60;&#x5FC5;&#x987B;&#x7279;&#x522B;&#x5C0F;&#x5FC3;&#x3002;&#x5426;&#x5219;&#x6709;&#x53EF;&#x80FD;&#x4F7F;&#x5F17;&#x96F7;&#x5FB7;&#x7684;&#x72B6;&#x6001;&#x770B;&#x8D77;&#x6765;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x56E0;&#x4E3A;&#x53E6;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x53EF;&#x80FD;&#x5728;&#x8FD9;&#x4E24;&#x4E2A;&#x4FEE;&#x6539;&#x4E4B;&#x95F4;&#x8BFB;&#x53D6;&#x5F17;&#x96F7;&#x5FB7;&#x5BF9;&#x8C61;&#xFF0C;&#x50CF;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fred.cuddle_hunger_level = fred.cuddle_hunger_level + <span class="number">1</span></span><br><span class="line"><span class="comment"># At this time, another thread could read fred&apos;s attributes and</span></span><br><span class="line"><span class="comment"># &quot;perceive&quot; fred in an inconsistent state unless you use a mutex</span></span><br><span class="line">fred.percent_deteriorated = fred.percent_deteriorated + <span class="number">1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>This is another version of the mutual exclusion problem. In object-oriented programming (OOP), you can manually address this problem with a mutex, which ensures that only one thread can access a resource (in this case, the <code>fred</code> object) at a time for the duration of the mutex.</p>
</blockquote>
<p>&#x8FD9;&#x662F;&#x53E6;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x7684;&#x4E92;&#x65A5;&#x95EE;&#x9898;&#x3002;&#x5728;&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x7F16;&#x7A0B;&#x91CC;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x4E92;&#x65A5;&#x624B;&#x5DE5;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x4E92;&#x65A5;&#x786E;&#x4FDD;&#x4E86;&#x5728;&#x4E92;&#x65A5;&#x6301;&#x7EED;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4E00;&#x6B21;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x80FD;&#x8BBF;&#x95EE;&#x4E00;&#x4E2A;&#x8D44;&#x6E90;(&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x662F;<code>fred</code>&#x5BF9;&#x8C61;)&#x3002;</p>
<blockquote>
<p>The fact that objects are never stable doesn&#x2019;t stop us from treating them as the fundamental building blocks of programs. In fact, this is considered an advantage of OOP. It doesn&#x2019;t matter how the state changes; you can still interact with a stable interface and everything will work as it should. This conforms to our intuitive sense of the world. A piece of wax is still the same piece of wax even if its properties change: if I change its color, melt it, and pour it on the face of my enemy, I&#x2019;d still think of it as the same wax object I started with.</p>
</blockquote>
<p>&#x5BF9;&#x8C61;&#x6C38;&#x8FDC;&#x662F;&#x4E0D;&#x7A33;&#x5B9A;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x4E8B;&#x5B9E;&#x5E76;&#x672A;&#x963B;&#x6B62;&#x6211;&#x4EEC;&#x628A;&#x5BF9;&#x8C61;&#x4F5C;&#x4E3A;&#x7F16;&#x7A0B;&#x7684;&#x57FA;&#x7840;&#x7ED3;&#x6784;&#x3002;&#x4E8B;&#x5B9E;&#x4E0A;&#xFF0C;&#x8FD9;&#x88AB;&#x770B;&#x4F5C;&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x7F16;&#x7A0B;&#x7684;&#x4E00;&#x4E2A;&#x4F18;&#x70B9;&#x3002;&#x4E0D;&#x7BA1;&#x72B6;&#x6001;&#x5982;&#x4F55;&#x6539;&#x53D8;&#xFF0C;&#x4F60;&#x59CB;&#x7EC8;&#x4E0E;&#x7A33;&#x5B9A;&#x7684;&#x63A5;&#x53E3;&#x4EA4;&#x4E92;&#xFF0C;&#x5E76;&#x4E14;&#x4E00;&#x5207;&#x90FD;&#x6309;&#x9884;&#x60F3;&#x5DE5;&#x4F5C;&#x3002;&#x8FD9;&#x7B26;&#x5408;&#x6211;&#x4EEC;&#x5BF9;&#x4E16;&#x754C;&#x7684;&#x76F4;&#x89C9;&#x3002;&#x5373;&#x4F7F;&#x4E00;&#x5757;&#x814A;&#x7684;&#x5C5E;&#x6027;&#x6539;&#x53D8;&#x4E86;&#xFF0C;&#x5B83;&#x59CB;&#x7EC8;&#x8FD8;&#x662F;&#x90A3;&#x5757;&#x814A;&#xFF1A;&#x5982;&#x679C;&#x6211;&#x6539;&#x53D8;&#x4E86;&#x5B83;&#x7684;&#x989C;&#x8272;&#xFF0C;&#x628A;&#x5B83;&#x878D;&#x5316;&#xFF0C;&#x5E76;&#x5012;&#x5728;&#x654C;&#x4EBA;&#x7684;&#x8138;&#x4E0A;&#xFF0C;&#x6211;&#x4ECD;&#x7136;&#x8BA4;&#x4E3A;&#x5B83;&#x662F;&#x5F00;&#x59CB;&#x90A3;&#x4E2A;&#x814A;&#x5BF9;&#x8C61;&#x3002;</p>
<blockquote>
<p>Also, in OOP, objects do things. They act on each other, changing state as the program runs. Again, this conforms to our intuitive sense of the world: change is the result of objects acting on each other. A Person object pushes on a Door object and enters a House object.</p>
</blockquote>
<p>&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x7F16;&#x7A0B;&#x91CC;&#xFF0C;&#x5BF9;&#x8C61;&#x4E5F;&#x505A;&#x4E8B;&#x60C5;&#x3002;&#x4ED6;&#x4EEC;&#x4E92;&#x76F8;&#x4F5C;&#x7528;&#xFF0C;&#x968F;&#x7740;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x6539;&#x53D8;&#x72B6;&#x6001;&#x3002;&#x8FD9;&#x53C8;&#x4E00;&#x6B21;&#x7B26;&#x5408;&#x6211;&#x4EEC;&#x5BF9;&#x4E16;&#x754C;&#x7684;&#x76F4;&#x89C9;&#xFF1A;&#x6539;&#x53D8;&#x662F;&#x5BF9;&#x8C61;&#x76F8;&#x4E92;&#x4F5C;&#x7528;&#x7684;&#x7ED3;&#x679C;&#x3002;&#x4E00;&#x4E2A;&#x4EBA;&#x5BF9;&#x8C61;&#x63A8;&#x4E00;&#x4E2A;&#x95E8;&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x4E14;&#x8FDB;&#x5165;&#x4E86;&#x4E00;&#x4E2A;&#x623F;&#x5B50;&#x5BF9;&#x8C61;&#x3002;</p>
<blockquote>
<p>Clojure Metaphysics</p>
</blockquote>
<h2 id="Clojure&#x54F2;&#x5B66;&#x4F53;&#x7CFB;"><a href="#Clojure&#x54F2;&#x5B66;&#x4F53;&#x7CFB;" class="headerlink" title="Clojure&#x54F2;&#x5B66;&#x4F53;&#x7CFB;"></a>Clojure&#x54F2;&#x5B66;&#x4F53;&#x7CFB;</h2><blockquote>
<p>In Clojure metaphysics, we would say that we never encounter the same cuddle zombie twice. The cuddle zombie is not a discrete thing that exists in the world independent of its mutations: it&#x2019;s actually a succession of values.</p>
</blockquote>
<p>&#x5728;Clojure&#x7684;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;&#x91CC;&#xFF0C;&#x6211;&#x4EEC;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x8BF4;&#x9047;&#x5230;&#x540C;&#x4E00;&#x4E2A;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x4E24;&#x6B21;&#x3002;&#x90A3;&#x4E2A;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x4E0D;&#x662F;&#x4E16;&#x754C;&#x4E0A;&#x7684;&#x72EC;&#x7ACB;&#x4E8E;&#x5176;&#x6539;&#x53D8;&#x7684;&#x5177;&#x4F53;&#x4E8B;&#x7269;&#xFF1A;&#x5B83;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x503C;&#x3002;</p>
<blockquote>
<p>The term value is used often by Clojurists, and its specific meaning might differ from what you&#x2019;re used to. Values are atomic in the sense that they form a single irreducible unit or component in a larger system; they&#x2019;re indivisible, unchanging, stable entities. Numbers are values: it wouldn&#x2019;t make sense for the number 15 to mutate into another number. When you add or subtract from 15, you don&#x2019;t change the number 15; you just wind up with a different number. Clojure&#x2019;s data structures are also values because they&#x2019;re immutable. When you use <code>assoc</code> on a map, you don&#x2019;t modify the original map; instead, you derive a new map.</p>
</blockquote>
<p>&#x503C;&#x8FD9;&#x4E2A;&#x672F;&#x8BED;&#x7ECF;&#x5E38;&#x88AB;Clojure&#x7A0B;&#x5E8F;&#x5458;&#x4F7F;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x5176;&#x7279;&#x5B9A;&#x542B;&#x4E49;&#x53EF;&#x80FD;&#x4E0E;&#x4F60;&#x4E60;&#x60EF;&#x7684;&#x4E0D;&#x540C;&#x3002;&#x503C;&#x6784;&#x6210;&#x4E86;&#x66F4;&#x5927;&#x7CFB;&#x7EDF;&#x4E2D;&#x7684;&#x5355;&#x4E00;&#x7684;&#x4E0D;&#x53EF;&#x524A;&#x51CF;&#x7684;&#x5355;&#x5143;&#xFF0C;&#x5B83;&#x4EEC;&#x662F;&#x4E0D;&#x53EF;&#x5206;&#x5272;&#x7684;&#xFF0C;&#x4E0D;&#x53D8;&#x7684;&#xFF0C;&#x7A33;&#x5B9A;&#x7684;&#x5B9E;&#x4F53;&#x3002;&#x4ECE;&#x8FD9;&#x4E2A;&#x610F;&#x4E49;&#x4E0A;&#x8BF4;&#xFF0C;&#x503C;&#x662F;&#x539F;&#x5B50;&#x7684;&#x3002;&#x6570;&#x5B57;&#x662F;&#x503C;&#xFF1A;&#x6570;&#x5B57;15&#x6539;&#x53D8;&#x6210;&#x53E6;&#x4E00;&#x4E2A;&#x6570;&#x5B57;&#x662F;&#x65E0;&#x610F;&#x4E49;&#x7684;&#x3002;&#x5BF9;15&#x8FDB;&#x884C;&#x52A0;&#x6216;&#x51CF;&#x65F6;&#xFF0C;&#x4E0D;&#x662F;&#x6539;&#x53D8;&#x6570;&#x5B57;15&#xFF0C;&#x53EA;&#x662F;&#x6700;&#x540E;&#x5F97;&#x5230;&#x4E86;&#x53E6;&#x4E00;&#x4E2A;&#x6570;&#x5B57;&#x3002;Clojure&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E5F;&#x662F;&#x503C;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x662F;&#x4E0D;&#x53EF;&#x53D8;&#x7684;&#x3002;&#x5F53;&#x4F60;&#x5BF9;&#x4E00;&#x4E2A;map&#x4F7F;&#x7528;<code>assco</code>&#x65F6;&#x5019;&#xFF0C;&#x4F60;&#x6CA1;&#x6709;&#x6539;&#x53D8;&#x539F;&#x6765;&#x7684;map&#xFF0C;&#x76F8;&#x53CD;&#xFF0C;&#x4F60;&#x5F97;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;map&#x3002;</p>
<blockquote>
<p>So a value doesn&#x2019;t change, but you can apply a process to a value to produce a new value. For example, say we start with a value <em>F1</em>, and then we apply the <em>Cuddle Zombie</em> process to <em>F1</em> to produce the value <em>F2</em>. The process then gets applied to the value <em>F2</em> to produce the value <em>F3</em>, and so on.</p>
</blockquote>
<p>&#x503C;&#x4E0D;&#x6539;&#x53D8;&#xFF0C;&#x4F46;&#x4F60;&#x53EF;&#x4EE5;&#x5BF9;&#x503C;&#x5E94;&#x7528;&#x4E00;&#x4E2A;&#x8FC7;&#x7A0B;&#x7528;&#x4EE5;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x65B0;&#x503C;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x5F00;&#x59CB;&#x6709;&#x4E2A;&#x503C;<em>F1</em>,&#x7136;&#x540E;&#x5BF9;<em>F1</em>&#x5E94;&#x7528;<em>Cuddle Zombie</em>&#x8FC7;&#x7A0B;&#xFF0C;&#x4EA7;&#x751F;&#x4E86;&#x503C;<em>F2</em>&#x3002;&#x7136;&#x540E;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x53C8;&#x5E94;&#x7528;&#x4E8E;<em>F2</em>&#x4EA7;&#x751F;&#x4E86;&#x503C;<em>F3</em>,&#x8BF8;&#x5982;&#x6B64;&#x7C7B;&#x3002;</p>
<blockquote>
<p>This leads to a different conception of <em>identity</em>. Instead of understanding identity as inherent to a changing object, as in OO metaphysics, Clojure metaphysics construes identity as something we humans impose on a succession of unchanging values produced by a process over time. We use <em>names</em> to designate identities. The name <em>Fred</em> is a handy way to refer to a series of individual states <em>F1</em>, <em>F2</em>, <em>F3</em>, and so on. From this viewpoint, there&#x2019;s no such thing as mutable state. Instead, state means the value of an identity at a point in time.</p>
</blockquote>
<p>&#x8FD9;&#x5BFC;&#x81F4;&#x4E86;&#x4E0D;&#x540C;&#x7684;<em>&#x8EAB;&#x4EFD;</em>&#x6982;&#x5FF5;&#x3002;&#x4E0D;&#x50CF;&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x54F2;&#x5B66;&#x90A3;&#x6837;&#xFF0C;&#x8BA4;&#x4E3A;&#x8EAB;&#x4EFD;&#x5BF9;&#x4E8E;&#x53D8;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x662F;&#x56FA;&#x6709;&#x7684;&#xFF0C;Clojure&#x54F2;&#x5B66;&#x8BA4;&#x4E3A;&#x8EAB;&#x4EFD;&#x662F;&#x6211;&#x4EEC;&#x5F3A;&#x52A0;&#x5728;&#x8FDE;&#x7EED;&#x4E0D;&#x53D8;&#x7684;&#x503C;&#x4E0A;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x8FD9;&#x4E9B;&#x503C;&#x662F;&#x4E00;&#x4E2A;&#x8FC7;&#x7A0B;&#x968F;&#x7740;&#x65F6;&#x95F4;&#x6D41;&#x901D;&#x4EA7;&#x751F;&#x7684;&#x3002;&#x6211;&#x4EEC;&#x7528;<em>&#x540D;&#x79F0;</em>&#x6807;&#x51FA;&#x8EAB;&#x4EFD;&#x3002;&#x4F7F;&#x7528;&#x540D;&#x79F0;<em>Fred</em>&#x53EF;&#x4EE5;&#x65B9;&#x4FBF;&#x5730;&#x5F15;&#x7528;&#x4E00;&#x7CFB;&#x5217;&#x4E2A;&#x522B;&#x7684;&#x72B6;&#x6001;,<em>F1</em>, <em>F2</em>, <em>F3</em> &#x7B49;&#x7B49;&#x3002;&#x4ECE;&#x8FD9;&#x4E2A;&#x89D2;&#x5EA6;&#x770B;&#xFF0C;&#x6CA1;&#x6709;&#x53EF;&#x53D8;&#x72B6;&#x6001;&#x90A3;&#x6837;&#x7684;&#x4E1C;&#x897F;&#x3002;&#x76F8;&#x53CD;&#xFF0C;&#x72B6;&#x6001;&#x610F;&#x5473;&#x7740;&#x8EAB;&#x4EFD;&#x5728;&#x67D0;&#x4E2A;&#x65F6;&#x95F4;&#x70B9;&#x4E0A;&#x7684;&#x503C;&#x3002;</p>
<blockquote>
<p>Rich Hickey has used the analogy of phone numbers to explain state. <em>Alan&#x2019;s phone number</em> has changed 10 times, but we will always call these numbers by the same name, <em>Alan&#x2019;s phone number</em>. Alan&#x2019;s phone number five years ago is a different value than Alan&#x2019;s phone number today, and both are two states of Alan&#x2019;s phone number identity.</p>
</blockquote>
<p>Rich Hickey&#x66FE;&#x7ECF;&#x7528;&#x7535;&#x8BDD;&#x53F7;&#x7801;&#x7684;&#x7C7B;&#x6BD4;&#x89E3;&#x91CA;&#x72B6;&#x6001;&#x3002;<em>&#x963F;&#x5170;&#x7684;&#x7535;&#x8BDD;&#x53F7;&#x7801;</em> &#x53D8;&#x8FC7;10&#x6B21;&#xFF0C;&#x4F46;&#x6211;&#x4EEC;&#x603B;&#x662F;&#x7528;&#x540C;&#x6837;&#x7684;&#x540D;&#x5B57;<em>&#x963F;&#x5170;&#x7684;&#x7535;&#x8BDD;&#x53F7;&#x7801;</em> &#x53EB;&#x8FD9;&#x4E9B;&#x53F7;&#x7801;&#x3002;&#x4E94;&#x5E74;&#x524D;&#x7684;&#x963F;&#x5170;&#x7684;&#x7535;&#x8BDD;&#x53F7;&#x7801;&#x4E0E;&#x4ECA;&#x5929;&#x7684;&#x963F;&#x5170;&#x7684;&#x7535;&#x8BDD;&#x53F7;&#x7801;&#x662F;&#x4E0D;&#x540C;&#x7684;&#x503C;&#xFF0C;&#x5B83;&#x4EEC;&#x90FD;&#x662F;&#x963F;&#x5170;&#x7684;&#x7535;&#x8BDD;&#x53F7;&#x7801;&#x8FD9;&#x4E2A;&#x8EAB;&#x4EFD;&#x7684;&#x72B6;&#x6001;&#x3002;</p>
<blockquote>
<p>This makes sense when you consider that in your programs you are dealing with information about the world. Rather than saying that information has changed, you would say you&#x2019;ve received new information. At 12:00 pm on Friday, Fred the Cuddle Zombie was in a state of 50 percent decay. At 1:00 pm, he was 60 percent decayed. These are both facts that you can process, and the introduction of a new fact does not invalidate a previous fact. Even though Fred&#x2019;s decay increased from 50 percent to 60 percent, it&#x2019;s still true that at 12:00 pm he was in a state of 50 percent decay.</p>
</blockquote>
<p>&#x8003;&#x8651;&#x5230;&#x4F60;&#x7684;&#x7A0B;&#x5E8F;&#x5904;&#x7406;&#x7684;&#x662F;&#x4E16;&#x754C;&#x4E0A;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x8FD9;&#x662F;&#x6709;&#x610F;&#x4E49;&#x7684;&#x3002;&#x4E0D;&#x662F;&#x4FE1;&#x606F;&#x5728;&#x6539;&#x53D8;&#xFF0C;&#x800C;&#x662F;&#x63A5;&#x53D7;&#x5230;&#x4E86;&#x65B0;&#x4FE1;&#x606F;&#x3002;&#x5468;&#x4E94;&#x665A;&#x4E0A;12&#x70B9;&#xFF0C;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x5F17;&#x96F7;&#x5FB7;&#x7684;&#x8150;&#x70C2;&#x5EA6;&#x662F;50%&#x3002;&#x591C;&#x91CC;&#x4E00;&#x70B9;&#xFF0C;&#x662F;60%&#x3002;&#x8FD9;&#x662F;&#x53EF;&#x4EE5;&#x5904;&#x7406;&#x7684;&#x4E24;&#x4E2A;&#x4E8B;&#x5B9E;&#xFF0C;&#x5E76;&#x4E14;&#x65B0;&#x4E8B;&#x5B9E;&#x7684;&#x5F15;&#x5165;&#x6CA1;&#x6709;&#x4F7F;&#x524D;&#x4E00;&#x4E2A;&#x65E0;&#x6548;&#x3002;&#x5C3D;&#x7BA1;&#x5F17;&#x96F7;&#x5FB7;&#x7684;&#x8150;&#x70C2;&#x5EA6;&#x4ECE;50%&#x589E;&#x52A0;&#x5230;60%&#xFF0C;&#x4F46;&#x4ED6;&#x5728;12&#x70B9;&#x65F6;&#x5019;&#x7684;&#x8150;&#x70C2;&#x5EA6;&#x4E3A;50%&#x4ECD;&#x7136;&#x662F;&#x4E8B;&#x5B9E;&#x3002;</p>
<blockquote>
<p>Figure 10-2 shows how you might visualize values, process, identity, and state.</p>
</blockquote>
<p>&#x56FE;10-2&#x56FE;&#x5F62;&#x5316;&#x5730;&#x6F14;&#x793A;&#x4E86;&#x503C;&#xFF0C;&#x8FC7;&#x7A0B;&#xFF0C;&#x8EAB;&#x4EFD;&#x548C;&#x72B6;&#x6001;&#x3002;</p>
<blockquote>
<p>Figure 10-2: Values, process, identity, and state</p>
</blockquote>
<p><img src="/2016/07/22/clojure-metaphysics/fp-metaphysics.png" alt="fpm"></p>
<blockquote>
<p>These values don&#x2019;t act on each other, and they can&#x2019;t be changed. They can&#x2019;t do anything. Change only occurs when a) a process generates a new value and b) we choose to associate the identity with the new value.</p>
</blockquote>
<p>&#x8FD9;&#x4E9B;&#x503C;&#x4E0D;&#x4E92;&#x76F8;&#x5F71;&#x54CD;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x6539;&#x53D8;&#x3002;&#x5B83;&#x4EEC;&#x4EC0;&#x4E48;&#x90FD;&#x4E0D;&#x505A;&#x3002;&#x53D8;&#x5316;&#x53EA;&#x51FA;&#x73B0;&#x4E8E;&#xFF1A;a) &#x8FC7;&#x7A0B;&#x4EA7;&#x751F;&#x4E86;&#x65B0;&#x503C;&#x3002; b) &#x6211;&#x4EEC;&#x628A;&#x8FD9;&#x4E2A;&#x8EAB;&#x4EFD;&#x4E0E;&#x4E00;&#x4E2A;&#x65B0;&#x503C;&#x5173;&#x8054;&#x8D77;&#x6765;&#x3002;</p>
<blockquote>
<p>To handle this sort of change, Clojure uses <em>reference types</em>. Reference types let you manage identities in Clojure. Using them, you can name an identity and retrieve its state. Let&#x2019;s look at the simplest of these, the <em>atom</em>.</p>
</blockquote>
<p>Clojure&#x4F7F;&#x7528;<em>&#x5F15;&#x7528;&#x7C7B;&#x578B;</em>&#x5904;&#x7406;&#x8FD9;&#x7C7B;&#x53D8;&#x5316;&#x3002;&#x4F7F;&#x7528;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x53EF;&#x4EE5;&#x7BA1;&#x7406;&#x8EAB;&#x4EFD;&#x3002;&#x7528;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x53EF;&#x4EE5;&#x547D;&#x540D;&#x4E00;&#x4E2A;&#x8EAB;&#x4EFD;&#xFF0C;&#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x5B83;&#x7684;&#x72B6;&#x6001;&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x770B;&#x770B;&#x6700;&#x7B80;&#x5355;&#x7684;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#xFF1A;<em>&#x539F;&#x5B50;</em></p>
<blockquote>
<p>Atoms</p>
</blockquote>
<h2 id="&#x539F;&#x5B50;"><a href="#&#x539F;&#x5B50;" class="headerlink" title="&#x539F;&#x5B50;"></a>&#x539F;&#x5B50;</h2><blockquote>
<p>Clojure&#x2019;s atom reference type allows you to endow a succession of related values with an identity. Here&#x2019;s how you create one:</p>
</blockquote>
<p>Clojure&#x7684;&#x539F;&#x5B50;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x8BA9;&#x4F60;&#x4E3A;&#x8FDE;&#x7EED;&#x76F8;&#x5173;&#x503C;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x8EAB;&#x4EFD;&#x3002;&#x521B;&#x5EFA;&#x65B9;&#x6CD5;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> fred (<span class="name"><span class="builtin-name">atom</span></span> {<span class="symbol">:cuddle-hunger-level</span> <span class="number">0</span></span><br><span class="line">                 <span class="symbol">:percent-deteriorated</span> <span class="number">0</span>}))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This creates a new atom and binds it to the name <code>fred</code>. This atom refers to the value <code>{:cuddle-hunger-level 0 :percent-deteriorated 0}</code>, and you would say that that&#x2019;s its current state.</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x539F;&#x5B50;&#x5E76;&#x628A;&#x5B83;&#x4E0E;&#x540D;&#x5B57;<code>fred</code>&#x7ED1;&#x5B9A;&#x3002;&#x8FD9;&#x4E2A;&#x539F;&#x5B50;&#x6307;&#x5411;&#x7684;&#x503C;&#x662F;<code>{:cuddle-hunger-level 0 :percent-deteriorated 0}</code>,&#x8FD9;&#x4E5F;&#x662F;&#x5B83;&#x5F53;&#x524D;&#x7684;&#x72B6;&#x6001;&#x3002;</p>
<blockquote>
<p>To get an atom&#x2019;s current state, you dereference it. Here&#x2019;s Fred&#x2019;s current state:</p>
</blockquote>
<p>&#x53D6;&#x503C;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x539F;&#x5B50;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x3002;Fred&#x7684;&#x5F53;&#x524D;&#x72B6;&#x6001;&#xFF1A;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@fred</span><br><span class="line">; =&gt; {:cuddle-hunger-level 0, :percent-deteriorated 0}</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Unlike futures, delays, and promises, dereferencing an atom (or any other reference type) will never block. When you dereference futures, delays, and promises, it&#x2019;s like you&#x2019;re saying &#x201C;I need a value now, and I will wait until I get it,&#x201D; so it makes sense that the operation would block. However, when you dereference a reference type, it&#x2019;s like you&#x2019;re saying &#x201C;give me the value I&#x2019;m currently referring to,&#x201D; so it makes sense that the operation doesn&#x2019;t block, because it doesn&#x2019;t have to wait for anything.</p>
</blockquote>
<p>&#x4E0D;&#x50CF;&#x672A;&#x6765;&#xFF0C;&#x5EF6;&#x671F;&#x548C;&#x627F;&#x8BFA;(<a href="https://morrxy.github.io/2016/07/15/braveclojure-concurrency/#&#x672A;&#x6765;-future-&#xFF0C;&#x5EF6;&#x671F;-delay-&#x548C;&#x627F;&#x8BFA;-promise" target="_blank" rel="external">&#x53C2;&#x8003;&#x8FD9;&#x91CC;</a>)&#xFF0C;&#x5BF9;&#x539F;&#x5B50;(&#x6216;&#x4EFB;&#x4F55;&#x5176;&#x4ED6;&#x5F15;&#x7528;&#x7C7B;&#x578B;)&#x53D6;&#x503C;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x963B;&#x585E;&#x3002;&#x5F53;&#x5BF9;&#x672A;&#x6765;&#xFF0C;&#x5EF6;&#x671F;&#x548C;&#x627F;&#x8BFA;&#x53D6;&#x503C;&#x65F6;&#xFF0C;&#x5C31;&#x50CF;&#x5728;&#x8BF4;&#xFF1A;&#x6211;&#x73B0;&#x5728;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x503C;&#xFF0C;&#x6211;&#x4F1A;&#x7B49;&#x7740;&#x76F4;&#x5230;&#x5F97;&#x5230;&#x5B83;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x4E9B;&#x64CD;&#x4F5C;&#x4F1A;&#x963B;&#x585E;&#x662F;&#x6709;&#x610F;&#x4E49;&#x7684;&#x3002;&#x4F46;&#x5F53;&#x5BF9;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x53D6;&#x503C;&#x65F6;&#xFF0C;&#x5C31;&#x50CF;&#x5728;&#x8BF4;&#xFF1A;&#x7ED9;&#x6211;&#x5F53;&#x524D;&#x6307;&#x5411;&#x7684;&#x503C;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x4E0D;&#x963B;&#x585E;&#x662F;&#x6709;&#x9053;&#x7406;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x4E0D;&#x7528;&#x7B49;&#x5F85;&#x4EFB;&#x4F55;&#x4E1C;&#x897F;&#x3002;</p>
<blockquote>
<p>In the Ruby example in Listing 10-1, we saw how object data could change while you try to log it on a separate thread. There&#x2019;s no danger of that happening when using atoms to manage state, because each state is immutable. Here&#x2019;s how you could log a zombie&#x2019;s state with <code>println</code>:</p>
</blockquote>
<p>&#x5728;&#x5217;&#x8868;10-1&#x7684;Ruby&#x4F8B;&#x5B50;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5F53;&#x4F60;&#x5C1D;&#x8BD5;&#x5728;&#x72EC;&#x7ACB;&#x7EBF;&#x7A0B;&#x8BB0;&#x5F55;&#x5BF9;&#x8C61;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x5B83;&#x6709;&#x53EF;&#x80FD;&#x6539;&#x53D8;&#x3002;&#x7528;&#x539F;&#x5B50;&#x7BA1;&#x7406;&#x72B6;&#x6001;&#x65F6;&#x5019;&#xFF0C;&#x4E0D;&#x4F1A;&#x6709;&#x8FD9;&#x79CD;&#x5371;&#x9669;&#xFF0C;&#x56E0;&#x4E3A;&#x6BCF;&#x4E2A;&#x72B6;&#x6001;&#x662F;&#x4E0D;&#x53EF;&#x53D8;&#x7684;&#x3002;&#x8FD9;&#x662F;&#x5982;&#x4F55;&#x7528;<code>print</code>&#x8BB0;&#x5F55;&#x50F5;&#x5C38;&#x72B6;&#x6001;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [zombie-state @fred]</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> (<span class="symbol">:percent-deteriorated</span> zombie-state) <span class="number">50</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">future</span></span> (<span class="name">println</span> (<span class="symbol">:cuddle-hunger-level</span> zombie-state)))))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The problem with the Ruby example in Listing 10-1 was that it took two steps to read the zombie&#x2019;s two attributes, and some other thread could have changed those attributes in between the two steps. However, by using atoms to refer to immutable data structures, you only have to perform one read, and the data structure returned won&#x2019;t get altered by another thread.</p>
</blockquote>
<p>&#x5217;&#x8868;10-1&#x7684;Ruby&#x4F8B;&#x5B50;&#x7684;&#x95EE;&#x9898;&#x5728;&#x4E8E;&#xFF1A;&#x8BFB;&#x53D6;&#x50F5;&#x5C38;&#x7684;&#x4E24;&#x4E2A;&#x5C5E;&#x6027;&#x82B1;&#x4E86;&#x4E24;&#x6B65;&#xFF0C;&#x8FD9;&#x4E24;&#x6B65;&#x4E4B;&#x95F4;&#xFF0C;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x53EF;&#x80FD;&#x5DF2;&#x7ECF;&#x6539;&#x53D8;&#x4E86;&#x8FD9;&#x4E9B;&#x5C5E;&#x6027;&#x3002;&#x4F46;&#x7528;&#x539F;&#x5B50;&#x5F15;&#x7528;&#x4E0D;&#x53EF;&#x53D8;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x4F60;&#x53EA;&#x9700;&#x8981;&#x6267;&#x884C;&#x4E00;&#x6B21;&#x8BFB;&#x53D6;&#xFF0C;&#x5E76;&#x4E14;&#x8FD4;&#x56DE;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E0D;&#x4F1A;&#x88AB;&#x53E6;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6539;&#x53D8;&#x3002;</p>
<blockquote>
<p>To update the atom so that it refers to a new state, you use <code>swap!</code>. This might seem contradictory, because I said that atomic values are unchanging. Indeed, they are! But now we&#x2019;re working with the atom <em>reference type</em>, a construct that refers to atomic values. The atomic values don&#x2019;t change, but the reference type can be updated and assigned a new value.</p>
</blockquote>
<p>&#x4F7F;&#x7528;<code>swap!</code>&#x66F4;&#x65B0;&#x539F;&#x5B50;&#xFF0C;&#x4F7F;&#x5B83;&#x6307;&#x5411;&#x4E00;&#x4E2A;&#x65B0;&#x72B6;&#x6001;&#x3002;&#x7531;&#x4E8E;&#x6211;&#x66FE;&#x7ECF;&#x8BF4;&#x8FC7;&#x539F;&#x5B50;&#x503C;&#x662F;&#x4E0D;&#x53D8;&#x7684;&#xFF0C;&#x8FD9;&#x770B;&#x8D77;&#x6765;&#x53EF;&#x80FD;&#x6709;&#x70B9;&#x77DB;&#x76FE;&#x3002;&#x539F;&#x5B50;&#x786E;&#x5B9E;&#x662F;&#x4E0D;&#x53D8;&#x7684;&#xFF01;&#x4F46;&#x73B0;&#x5728;&#x64CD;&#x4F5C;&#x7684;&#x662F;&#x539F;&#x5B50;<em>&#x5F15;&#x7528;&#x7C7B;&#x578B;</em> &#xFF0C;&#x4E00;&#x4E2A;&#x6307;&#x5411;&#x539F;&#x5B50;&#x503C;&#x7684;&#x7ED3;&#x6784;&#x3002;&#x539F;&#x5B50;&#x503C;&#x4E0D;&#x53D8;&#xFF0C;&#x4F46;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x53EF;&#x4EE5;&#x66F4;&#x65B0;&#xFF0C;&#x5E76;&#x88AB;&#x8D4B;&#x4E88;&#x4E00;&#x4E2A;&#x65B0;&#x503C;&#x3002;</p>
<blockquote>
<p><code>swap!</code> receives an atom and a function as arguments. It applies the function to the atom&#x2019;s current state to produce a new value, and then it updates the atom to refer to this new value. The new value is also returned. Here&#x2019;s how you might increase Fred&#x2019;s cuddle hunger level by one:</p>
</blockquote>
<p><code>swap!</code>&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x539F;&#x5B50;&#x548C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x3002;&#x5BF9;&#x539F;&#x5B50;&#x7684;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x5E94;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x65B0;&#x503C;&#xFF0C;&#x7136;&#x540E;&#x66F4;&#x65B0;&#x8FD9;&#x4E2A;&#x539F;&#x5B50;&#x6307;&#x5411;&#x8FD9;&#x4E2A;&#x65B0;&#x503C;&#x3002;&#x5E76;&#x8FD4;&#x56DE;&#x8FD9;&#x4E2A;&#x65B0;&#x503C;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x5982;&#x4F55;&#x628A;Fred&#x7684;&#x62E5;&#x62B1;&#x6E34;&#x671B;&#x7B49;&#x7EA7;&#x52A0;&#x4E00;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">swap!</span></span> fred</span><br><span class="line">       (<span class="name"><span class="builtin-name">fn</span></span> [current-state]</span><br><span class="line">         (<span class="name">merge-with</span> + current-state {<span class="symbol">:cuddle-hunger-level</span> <span class="number">1</span>})))</span><br><span class="line"><span class="comment">; =&gt; {:cuddle-hunger-level 1, :percent-deteriorated 0}</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Dereferencing <code>fred</code> will return the new state:</p>
</blockquote>
<p>&#x5BF9;<code>fred</code>&#x53D6;&#x503C;&#x4F1A;&#x8FD4;&#x56DE;&#x65B0;&#x72B6;&#x6001;&#xFF1A;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@fred</span><br><span class="line">; =&gt; {:cuddle-hunger-level 1, :percent-deteriorated 0}</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Unlike Ruby, it&#x2019;s not possible for <code>fred</code> to be in an inconsistent state, because you can update the hunger level and deterioration percentage at the same time, like this:</p>
</blockquote>
<p>&#x4E0D;&#x50CF;Ruby&#xFF0C;<code>fred</code>&#x4E0D;&#x53EF;&#x80FD;&#x5904;&#x4E8E;&#x4E0D;&#x4E00;&#x81F4;&#x72B6;&#x6001;&#xFF0C;&#x56E0;&#x4E3A;&#x4F60;&#x540C;&#x65F6;&#x66F4;&#x65B0;&#x6E34;&#x671B;&#x7EA7;&#x522B;&#x548C;&#x8150;&#x70C2;&#x767E;&#x5206;&#x6BD4;&#xFF0C;&#x50CF;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">swap!</span></span> fred</span><br><span class="line">       (<span class="name"><span class="builtin-name">fn</span></span> [current-state]</span><br><span class="line">         (<span class="name">merge-with</span> + current-state {<span class="symbol">:cuddle-hunger-level</span> <span class="number">1</span></span><br><span class="line">                                      <span class="symbol">:percent-deteriorated</span> <span class="number">1</span>})))</span><br><span class="line"><span class="comment">; =&gt; {:cuddle-hunger-level 2, :percent-deteriorated 1}</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>This code passes <code>swap!</code> a function that takes only one argument, <code>current-state</code>. You can also pass <code>swap!</code> a function that takes multiple arguments. For example, you could create a function that takes two arguments, a zombie state and the amount by which to increase its cuddle hunger level:</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4F20;&#x7ED9;<code>swap!</code>&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;<code>current-state</code>&#x7684;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E5F;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x591A;&#x4E2A;&#x53C2;&#x6570;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x50F5;&#x5C38;&#x72B6;&#x6001;&#x548C;&#x6E34;&#x671B;&#x62E5;&#x62B1;&#x7B49;&#x7EA7;&#x589E;&#x52A0;&#x7684;&#x6570;&#x91CF;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> increase-cuddle-hunger-level</span><br><span class="line">  [zombie-state increase-by]</span><br><span class="line">  (<span class="name">merge-with</span> + zombie-state {<span class="symbol">:cuddle-hunger-level</span> increase-by}))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Let&#x2019;s test <code>increase-cuddle-hunger-level</code> out real quick on a zombie state.</p>
</blockquote>
<p>&#x6D4B;&#x8BD5;&#x4E00;&#x4E0B;&#x3002;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">increase-cuddle-hunger-level</span> @fred <span class="number">10</span>)</span><br><span class="line"><span class="comment">; =&gt; {:cuddle-hunger-level 12, :percent-deteriorated 1}</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note that this code doesn&#x2019;t actually update <code>fred</code>, because we&#x2019;re not using <code>swap!</code> We&#x2019;re just making a normal function call to <code>increase-cuddle-hunger-level</code>, which returns a result.</p>
</blockquote>
<p>&#x6CE8;&#x610F;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x5B9E;&#x9645;&#x4E0A;&#x6CA1;&#x6709;&#x66F4;&#x65B0;<code>fred</code>,&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x4F7F;&#x7528;<code>swap!</code>,&#x53EA;&#x662F;&#x5BF9;<code>increase-cuddle-hunger-level</code>&#x505A;&#x4E86;&#x4E00;&#x6B21;&#x666E;&#x901A;&#x51FD;&#x6570;&#x8C03;&#x7528;,&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x7ED3;&#x679C;&#x3002;</p>
<blockquote>
<p>Now call <code>swap!</code> with the additional arguments, and <code>@fred</code> will be updated, like this:</p>
</blockquote>
<p>&#x73B0;&#x5728;&#x5E26;&#x7740;&#x9644;&#x52A0;&#x53C2;&#x6570;&#x8C03;&#x7528;<code>swap!</code>,<code>@fred</code>&#x5C06;&#x4F1A;&#x66F4;&#x65B0;&#xFF0C;&#x50CF;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(swap! fred increase-cuddle-hunger-level 10)</span><br><span class="line">; =&gt; {:cuddle-hunger-level 12, :percent-deteriorated 1}</span><br><span class="line"></span><br><span class="line">@fred</span><br><span class="line">; =&gt; {:cuddle-hunger-level 12, :percent-deteriorated 1}</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Or you could express the whole thing using Clojure&#x2019;s built-in functions. The <code>update-in</code> function takes three arguments: a collection, a vector for identifying which value to update, and a function to update that value. It can also take additional arguments that get passed to the update function. Here are a couple of examples:</p>
</blockquote>
<p>&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x7528;Clojure&#x7684;&#x5185;&#x7F6E;&#x51FD;&#x6570;&#x5B8C;&#x6210;&#x6574;&#x4E2A;&#x4E8B;&#x60C5;&#x3002;<code>update-in</code>&#x51FD;&#x6570;&#x63A5;&#x53D7;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#xFF1A;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#xFF0C;&#x4E00;&#x4E2A;vector&#x7528;&#x4E8E;&#x6307;&#x660E;&#x66F4;&#x65B0;&#x54EA;&#x4E2A;&#x503C;&#xFF0C;&#x548C;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x7528;&#x4E8E;&#x66F4;&#x65B0;&#x90A3;&#x4E2A;&#x503C;&#x3002;&#x4E5F;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x66F4;&#x591A;&#x53C2;&#x6570;&#x4F20;&#x7ED9;&#x90A3;&#x4E2A;&#x66F4;&#x65B0;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x662F;&#x51E0;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">update-in</span></span> {<span class="symbol">:a</span> {<span class="symbol">:b</span> <span class="number">3</span>}} [<span class="symbol">:a</span> <span class="symbol">:b</span>] inc)</span><br><span class="line"><span class="comment">; =&gt; {:a {:b 4}}</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">update-in</span></span> {<span class="symbol">:a</span> {<span class="symbol">:b</span> <span class="number">3</span>}} [<span class="symbol">:a</span> <span class="symbol">:b</span>] + <span class="number">10</span>)</span><br><span class="line"><span class="comment">; =&gt; {:a {:b 13}}</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>In the first example, you&#x2019;re updating the map <code>{:a {:b 3}}</code>. Clojure uses the vector <code>[:a :b]</code> to traverse the nested maps; <code>:a</code> yields the nested map <code>{:b 3}</code>, and <code>:b</code> yields the value <code>3</code>. Clojure applies the <code>inc</code> function to <code>3</code> and returns a new map with <code>3</code> replaced by <code>4</code>. The second example is similar. The only difference is that you&#x2019;re using the addition function and you&#x2019;re supplying <code>10</code> as an additional argument; Clojure ends up calling <code>(+ 3 10)</code>.</p>
</blockquote>
<p>&#x7B2C;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x8981;&#x66F4;&#x65B0;map<code>{:a {:b 3}}</code>&#x3002;&#x7528;vector<code>[:a :b]</code>&#x904D;&#x5386;&#x8FD9;&#x4E2A;map&#xFF0C;&#x5E76;&#x5F97;&#x5230;&#x503C;<code>3</code>&#x3002;&#x5BF9;<code>3</code>&#x5E94;&#x7528;<code>inc</code>&#x51FD;&#x6570;&#x5F97;&#x5230;<code>4</code>,&#x5E76;&#x66FF;&#x6362;map&#x91CC;&#x7684;<code>3</code>&#x3002;&#x7B2C;&#x4E8C;&#x4E2A;&#x4F8B;&#x5B50;&#x7C7B;&#x4F3C;&#xFF0C;&#x53EA;&#x662F;&#x7528;&#x4E86;<code>+</code>&#x51FD;&#x6570;&#x548C;&#x4E00;&#x4E2A;&#x9644;&#x52A0;&#x53C2;&#x6570;<code>10</code>&#xFF0C;&#x8C03;&#x7528;&#x7684;&#x662F;<code>(+ 3 10)</code>&#x3002;</p>
<blockquote>
<p>Here&#x2019;s how you can use the <code>update-in</code> function to change Fred&#x2019;s state:</p>
</blockquote>
<p>&#x5982;&#x4F55;&#x4F7F;&#x7528;<code>update-in</code>&#x51FD;&#x6570;&#x4FEE;&#x6539;Fred&#x7684;&#x72B6;&#x6001;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">swap!</span></span> fred update-in [<span class="symbol">:cuddle-hunger-level</span>] + <span class="number">10</span>)</span><br><span class="line"><span class="comment">; =&gt; {:cuddle-hunger-level 22, :percent-deteriorated 1}</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>By using atoms, you can retain past state. You can dereference an atom to retrieve State 1, and then update the atom, creating State 2, and still make use of State 1:</p>
</blockquote>
<p>&#x4F7F;&#x7528;&#x539F;&#x5B50;&#x53EF;&#x4EE5;&#x4FDD;&#x7559;&#x8FC7;&#x53BB;&#x7684;&#x72B6;&#x6001;&#x3002;&#x53EF;&#x4EE5;&#x5BF9;&#x539F;&#x5B50;&#x53D6;&#x503C;&#x83B7;&#x5F97;&#x72B6;&#x6001;1&#xFF0C;&#x7136;&#x540E;&#x66F4;&#x65B0;&#x539F;&#x5B50;&#xFF0C;&#x521B;&#x5EFA;&#x72B6;&#x6001;2&#xFF0C;&#x5E76;&#x7EE7;&#x7EED;&#x4F7F;&#x7528;&#x72B6;&#x6001;1:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [num (<span class="name"><span class="builtin-name">atom</span></span> <span class="number">1</span>)</span><br><span class="line">      s1 @num]</span><br><span class="line">  (<span class="name"><span class="builtin-name">swap!</span></span> num inc)</span><br><span class="line">  (<span class="name">println</span> <span class="string">&quot;State 1:&quot;</span> s1)</span><br><span class="line">  (<span class="name">println</span> <span class="string">&quot;Current state:&quot;</span> @num))</span><br><span class="line"><span class="comment">; =&gt; State 1: 1</span></span><br><span class="line"><span class="comment">; =&gt; Current state: 2</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>This code creates an atom named <code>num</code>, retrieves its state, updates its state, and then prints its past state and its current state, showing that I wasn&#x2019;t trying to trick you when I said you can retain past state, and therefore you can trust me with all manner of things&#x2014;including your true name, which I promise to utter only to save you from mortal danger.</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x540D;&#x5B57;&#x662F;<code>num</code>&#x7684;&#x539F;&#x5B50;&#xFF0C;&#x53D6;&#x5F97;&#x4E86;&#x5B83;&#x7684;&#x503C;&#xFF0C;&#x66F4;&#x65B0;&#x4E86;&#x5B83;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x7136;&#x540E;&#x6253;&#x5370;&#x5B83;&#x7684;&#x8FC7;&#x53BB;&#x548C;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x3002;</p>
<blockquote>
<p>This is all interesting and fun, but what happens if two separate threads call <code>(swap! fred increase-cuddle-hunger-level 1)</code>? Is it possible for one of the increments to get lost the way it did in the Ruby example at Listing 10-1?</p>
</blockquote>
<p>&#x8FD9;&#x5F88;&#x6709;&#x8DA3;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x4E24;&#x4E2A;&#x72EC;&#x7ACB;&#x7EBF;&#x7A0B;&#x8C03;&#x7528;<code>(swap! fred increase-cuddle-hunger-level 1)</code>&#x4F1A;&#x600E;&#x4E48;&#x6837;&#x5462;&#xFF1F;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x589E;&#x52A0;&#x4F1A;&#x4E0D;&#x4F1A;&#x50CF;&#x5217;&#x8868;10-1&#x7684;Ruby&#x4F8B;&#x5B50;&#x90A3;&#x6837;&#x4E22;&#x5931;&#x5462;&#xFF1F;</p>
<blockquote>
<p>The answer is no! <code>swap!</code> implements compare-and-set semantics, meaning it does the following internally:</p>
</blockquote>
<p>&#x7B54;&#x6848;&#x662F;&#x4E0D;&#x4F1A;&#xFF01;<code>swap!</code>&#x5B9E;&#x73B0;&#x4E86;&#x6BD4;&#x8F83;&#x5E76;&#x8BBE;&#x7F6E;&#x8BED;&#x610F;&#xFF0C;&#x610F;&#x5473;&#x7740;&#x5B83;&#x5185;&#x90E8;&#x505A;&#x4E86;&#x4E0B;&#x5217;&#x4E8B;&#x60C5;&#xFF1A;</p>
<blockquote>
<ol>
<li>It reads the current state of the atom.</li>
<li>It then applies the update function to that state.</li>
<li>Next, it checks whether the value it read in step 1 is identical to the atom&#x2019;s current value.</li>
<li>If it is, then <code>swap!</code> updates the atom to refer to the result of step 2.</li>
<li>If it isn&#x2019;t, then <code>swap!</code> retries, going through the process again with step 1.</li>
</ol>
</blockquote>
<ol>
<li>&#x8BFB;&#x53D6;&#x539F;&#x5B50;&#x7684;&#x5F53;&#x524D;&#x503C;&#x3002;</li>
<li>&#x5BF9;&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x5E94;&#x7528;&#x66F4;&#x65B0;&#x51FD;&#x6570;&#x3002;</li>
<li>&#x68C0;&#x67E5;&#x539F;&#x5B50;&#x5F53;&#x524D;&#x503C;&#x4E0E;&#x6B65;&#x9AA4;1&#x8BFB;&#x5230;&#x7684;&#x503C;&#x662F;&#x5426;&#x5B8C;&#x5168;&#x4E00;&#x6837;</li>
<li>&#x5982;&#x679C;&#x4E00;&#x6837;&#xFF0C;<code>swap!</code>&#x66F4;&#x65B0;&#x539F;&#x5B50;&#x6307;&#x5411;&#x6B65;&#x9AA4;2&#x7684;&#x7ED3;&#x679C;</li>
<li>&#x5982;&#x679C;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;<code>swap!</code>&#x4ECE;&#x6B65;&#x9AA4;1&#x5F00;&#x59CB;&#x91CD;&#x65B0;&#x5C1D;&#x8BD5;</li>
</ol>
<blockquote>
<p>This process ensures that no swaps will ever get lost.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x786E;&#x4FDD;&#x4E86;swap&#x4E0D;&#x4F1A;&#x4E22;&#x5931;&#x3002;</p>
<blockquote>
<p>One detail to note about <code>swap!</code> is that atom updates happen synchronously; they will block their thread. For example, if your update function calls <code>Thread/sleep 1000</code> for some reason, the thread will block for at least a second while <code>swap!</code> completes.</p>
</blockquote>
<p>&#x4E00;&#x4E2A;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;<code>swap!</code>&#x7684;&#x7EC6;&#x8282;&#x662F;&#x539F;&#x5B50;&#x66F4;&#x65B0;&#x662F;&#x540C;&#x6B65;&#x7684;&#xFF0C;&#x4F1A;&#x963B;&#x585E;&#x7EBF;&#x7A0B;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x66F4;&#x65B0;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x4E86;<code>Thread/sleep 1000</code>,<code>swap!</code>&#x5B8C;&#x6210;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;&#x81F3;&#x5C11;&#x4F1A;&#x963B;&#x585E;&#x4E00;&#x79D2;&#x3002;</p>
<blockquote>
<p>Sometimes you&#x2019;ll want to update an atom without checking its current value. For example, you might develop a serum that sets a cuddle zombie&#x2019;s hunger level and deterioration back to zero. For those cases, you can use the <code>reset!</code> function:</p>
</blockquote>
<p>&#x6709;&#x65F6;&#x5019;&#x66F4;&#x65B0;&#x539F;&#x5B50;&#x65F6;&#x5019;&#x4E0D;&#x60F3;&#x68C0;&#x67E5;&#x5B83;&#x7684;&#x5F53;&#x524D;&#x503C;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x4F60;&#x53EF;&#x80FD;&#x7814;&#x7A76;&#x51FA;&#x4E00;&#x79CD;&#x8840;&#x6E05;&#xFF0C;&#x53EF;&#x4EE5;&#x628A;&#x62B1;&#x62B1;&#x50F5;&#x5C38;&#x7684;&#x6E34;&#x671B;&#x7EA7;&#x522B;&#x548C;&#x8150;&#x70C2;&#x7EA7;&#x522B;&#x90FD;&#x53D8;&#x6210;&#x96F6;&#x3002;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>reset!</code>&#x51FD;&#x6570;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">reset!</span></span> fred {<span class="symbol">:cuddle-hunger-level</span> <span class="number">0</span></span><br><span class="line">              <span class="symbol">:percent-deteriorated</span> <span class="number">0</span>})</span><br></pre></td></tr></table></figure>
<blockquote>
<p>And that covers all the core functionality of atoms! To recap: atoms implement Clojure&#x2019;s concept of state. They allow you to endow a series of immutable values with an identity. They offer a solution to the reference cell and mutual exclusion problems through their compare-and-set semantics. They also allow you to work with past states without fear of them mutating in place.</p>
</blockquote>
<p>&#x8FD9;&#x5C31;&#x662F;&#x539F;&#x5B50;&#x7684;&#x6240;&#x6709;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#xFF01;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF1A;&#x539F;&#x5B50;&#x5B9E;&#x73B0;&#x4E86;Clojre&#x7684;&#x72B6;&#x6001;&#x6982;&#x5FF5;&#x3002;&#x5B83;&#x5141;&#x8BB8;&#x7ED9;&#x4E00;&#x7CFB;&#x5217;&#x4E0D;&#x53EF;&#x53D8;&#x7684;&#x503C;&#x8D4B;&#x4E88;&#x4E00;&#x4E2A;&#x8EAB;&#x4EFD;&#x3002;&#x901A;&#x8FC7;&#x6BD4;&#x8F83;&#x5E76;&#x8BBE;&#x7F6E;&#x8BED;&#x610F;&#xFF0C;&#x5B83;&#x4E3A;&#x5F15;&#x7528;&#x5355;&#x5143;&#x548C;&#x4E92;&#x65A5;&#x95EE;&#x9898;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x3002;&#x5B83;&#x8BA9;&#x4F60;&#x80FD;&#x591F;&#x4F7F;&#x7528;&#x8FC7;&#x53BB;&#x7684;&#x72B6;&#x6001;&#x800C;&#x4E0D;&#x7528;&#x5BB3;&#x6015;&#x5B83;&#x4EEC;&#x88AB;&#x4FEE;&#x6539;&#x3002;</p>
<blockquote>
<p>In addition to these core features, atoms also share two features with the other reference types. You can attach both <em>watches</em> and <em>validators</em> to atoms. Let&#x2019;s look at those now.</p>
</blockquote>
<p>&#x9664;&#x4E86;&#x8FD9;&#x4E9B;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#xFF0C;&#x539F;&#x5B50;&#x8DDF;&#x5176;&#x4ED6;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x4E00;&#x6837;&#xFF0C;&#x6709;&#x4E24;&#x4E2A;&#x529F;&#x80FD;&#x3002;&#x4F60;&#x53EF;&#x4EE5;&#x5BF9;&#x539F;&#x5B50;&#x9644;&#x52A0;<em>&#x76D1;&#x89C6;</em>&#x548C;<em>&#x6821;&#x9A8C;</em>&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E0B;&#x3002;</p>
<blockquote>
<p>Watches and Validators</p>
</blockquote>
<h2 id="&#x76D1;&#x89C6;&#x4E0E;&#x6821;&#x9A8C;"><a href="#&#x76D1;&#x89C6;&#x4E0E;&#x6821;&#x9A8C;" class="headerlink" title="&#x76D1;&#x89C6;&#x4E0E;&#x6821;&#x9A8C;"></a>&#x76D1;&#x89C6;&#x4E0E;&#x6821;&#x9A8C;</h2><blockquote>
<p>Watches allow you to be super creepy and check in on your reference types&#x2019; every move. Validators allow you to be super controlling and restrict what states are allowable. Both watches and validators are plain ol&#x2019; functions.</p>
</blockquote>
<p>&#x76D1;&#x89C6;&#x8BA9;&#x4F60;&#x5F88;&#x7D27;&#x5F20;&#xFF0C;&#x56E0;&#x4E3A;&#x76D1;&#x89C6;&#x8BA9;&#x4F60;&#x80FD;&#x770B;&#x5230;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x7684;&#x6BCF;&#x6B65;&#x52A8;&#x4F5C;&#x3002;&#x6821;&#x9A8C;&#x8BA9;&#x4F60;&#x5F88;&#x6709;&#x63A7;&#x5236;&#x529B;&#xFF0C;&#x56E0;&#x4E3A;&#x6821;&#x9A8C;&#x9650;&#x5236;&#x4E86;&#x4EC0;&#x4E48;&#x72B6;&#x6001;&#x662F;&#x8BB8;&#x53EF;&#x7684;&#x3002;&#x76D1;&#x89C6;&#x548C;&#x6821;&#x9A8C;&#x90FD;&#x662F;&#x666E;&#x901A;&#x51FD;&#x6570;&#x3002;</p>
<blockquote>
<p>Watches</p>
</blockquote>
<h3 id="&#x76D1;&#x89C6;"><a href="#&#x76D1;&#x89C6;" class="headerlink" title="&#x76D1;&#x89C6;"></a>&#x76D1;&#x89C6;</h3><blockquote>
<p>A <em>watch</em> is a function that takes four arguments: a key, the reference being watched, its previous state, and its new state. You can register any number of watches with a reference type.</p>
</blockquote>
<p><em>&#x76D1;&#x89C6;</em> &#x662F;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x63A5;&#x53D7;&#x56DB;&#x4E2A;&#x53C2;&#x6570;&#xFF1A;&#x4E00;&#x4E2A;key&#xFF0C;&#x88AB;&#x76D1;&#x89C6;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x4E4B;&#x524D;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x65B0;&#x72B6;&#x6001;&#x3002;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x53EF;&#x4EE5;&#x6CE8;&#x518C;&#x4EFB;&#x610F;&#x4E2A;&#x76D1;&#x89C6;&#x3002;</p>
<blockquote>
<p>Let&#x2019;s say that a zombie&#x2019;s shuffle speed (measured in shuffles per hour, or SPH) is dependent on its hunger level and deterioration. Here&#x2019;s how you&#x2019;d calculate it, multiplying the cuddle hunger level by how whole it is:</p>
</blockquote>
<p>&#x6BD4;&#x5982;&#x8BF4;&#x50F5;&#x5C38;&#x7684;&#x79FB;&#x52A8;&#x901F;&#x5EA6;(&#x6BCF;&#x5C0F;&#x65F6;&#x79FB;&#x52A8;&#x6B65;&#x6570;&#xFF0C;SPH)&#x4F9D;&#x8D56;&#x5B83;&#x7684;&#x6E34;&#x671B;&#x7EA7;&#x522B;&#x548C;&#x8150;&#x70C2;&#x7EA7;&#x522B;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x5982;&#x4F55;&#x8BA1;&#x7B97;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6E34;&#x671B;&#x7B49;&#x7EA7;&#x4E0E;&#x5B8C;&#x6574;&#x5EA6;&#x76F8;&#x4E58;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> shuffle-speed</span><br><span class="line">  [zombie]</span><br><span class="line">  (<span class="name"><span class="builtin-name">*</span></span> (<span class="symbol">:cuddle-hunger-level</span> zombie)</span><br><span class="line">     (<span class="name"><span class="builtin-name">-</span></span> <span class="number">100</span> (<span class="symbol">:percent-deteriorated</span> zombie))))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Let&#x2019;s also say that you want to be alerted whenever a zombie&#x2019;s shuffle speed reaches the dangerous level of 5,000 SPH. Otherwise, you want to be told that everything&#x2019;s okay. Here&#x2019;s a watch function you could use to print a warning message if the SPH is above 5,000 and print an all&#x2019;s-well message otherwise:</p>
</blockquote>
<p>&#x5047;&#x8BBE;&#x50F5;&#x5C38;&#x7684;&#x79FB;&#x52A8;&#x901F;&#x5EA6;&#x5230;&#x8FBE;5000SPH&#x8FD9;&#x4E2A;&#x5371;&#x9669;&#x7EA7;&#x522B;&#x65F6;&#x5019;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x62A5;&#x8B66;&#x3002;&#x6CA1;&#x5230;&#x8FBE;&#x65F6;&#x5019;&#x9700;&#x8981;&#x544A;&#x77E5;&#x4E00;&#x5207;ok&#x3002;&#x4E0B;&#x9762;&#x662F;&#x8FD9;&#x4E2A;&#x76D1;&#x89C6;&#x51FD;&#x6570;:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> shuffle-alert</span><br><span class="line">  [key watched old-state new-state]</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> [sph (<span class="name">shuffle-speed</span> new-state)]</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">&gt;</span></span> sph <span class="number">5000</span>)</span><br><span class="line">      (<span class="name"><span class="builtin-name">do</span></span></span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;Run, you fool!&quot;</span>)</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;The zombie&apos;s SPH is now &quot;</span> sph)</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;This message brought to your courtesy of &quot;</span> key))</span><br><span class="line">      (<span class="name"><span class="builtin-name">do</span></span></span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;All&apos;s well with &quot;</span> key)</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;Cuddle hunger: &quot;</span> (<span class="symbol">:cuddle-hunger-level</span> new-state))</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;Percent deteriorated: &quot;</span> (<span class="symbol">:percent-deteriorated</span> new-state))</span><br><span class="line">        (<span class="name">println</span> <span class="string">&quot;SPH: &quot;</span> sph)))))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Watch functions take four arguments: a key that you can use for reporting, the atom being watched, the state of the atom before its update, and the state of the atom after its update. This watch function calculates the shuffle speed of the new state and prints a warning message if it&#x2019;s too high and an all&#x2019;s-well message when the shuffle speed is safe, as mentioned above. In both sets of messages, the key is used to let you know the source of the message.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x76D1;&#x89C6;&#x51FD;&#x6570;&#x63A5;&#x53D7;&#x56DB;&#x4E2A;&#x53C2;&#x6570;&#xFF1A;&#x7528;&#x4E8E;&#x62A5;&#x544A;&#x7684;key&#xFF0C;&#x88AB;&#x76D1;&#x89C6;&#x7684;&#x539F;&#x5B50;&#xFF0C;&#x539F;&#x5B50;&#x66F4;&#x65B0;&#x524D;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x539F;&#x5B50;&#x66F4;&#x65B0;&#x540E;&#x7684;&#x72B6;&#x6001;&#x3002;&#x76D1;&#x89C6;&#x51FD;&#x6570;&#x7528;&#x65B0;&#x72B6;&#x6001;&#x8BA1;&#x7B97;&#x51FA;&#x50F5;&#x5C38;&#x7684;&#x79FB;&#x52A8;&#x901F;&#x5EA6;&#xFF0C;&#x5E76;&#x505A;&#x51FA;&#x76F8;&#x5E94;&#x62A5;&#x544A;&#x3002;&#x62A5;&#x544A;&#x91CC;&#x7684;key&#x4F7F;&#x4F60;&#x77E5;&#x9053;&#x4FE1;&#x606F;&#x6765;&#x6E90;&#x3002;</p>
<blockquote>
<p>You can attach this function to <code>fred</code> with <code>add-watch</code>. The general form of <code>add-watch</code> is <code>(add-watch ref key watch-fn)</code>. In this example, we&#x2019;re resetting <code>fred</code>&#x2019;s state, adding the <code>shuffle-alert</code> watch function, and then updating <code>fred</code>&#x2019;s state a couple of times to trigger <code>shuffle-alert</code>:</p>
</blockquote>
<p>&#x7528;<code>add-watch</code>&#x53EF;&#x4EE5;&#x628A;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x9644;&#x52A0;&#x5230;<code>fred</code>&#x4E0A;&#x3002;<code>add-watch</code>&#x7684;&#x901A;&#x7528;&#x5F62;&#x5F0F;&#x662F;<code>(add-watch ref key watch-fn)</code>&#x3002;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x91CD;&#x7F6E;&#x4E86;<code>fred</code>&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x52A0;&#x4E0A;&#x4E86;<code>shuffle-alert</code>&#x76D1;&#x89C6;&#x51FD;&#x6570;&#xFF0C;&#x7136;&#x540E;&#x66F4;&#x65B0;&#x4E86;&#x51E0;&#x6B21;<code>fred</code>&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x4EE5;&#x89E6;&#x53D1;<code>shuffle-alert</code>:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">reset!</span></span> fred {<span class="symbol">:cuddle-hunger-level</span> <span class="number">22</span></span><br><span class="line">              <span class="symbol">:percent-deteriorated</span> <span class="number">2</span>})</span><br><span class="line">(<span class="name"><span class="builtin-name">add-watch</span></span> fred <span class="symbol">:fred-shuffle-alert</span> shuffle-alert)</span><br><span class="line">(<span class="name"><span class="builtin-name">swap!</span></span> fred update-in [<span class="symbol">:percent-deteriorated</span>] + <span class="number">1</span>)</span><br><span class="line"><span class="comment">; =&gt; All&apos;s well with  :fred-shuffle-alert</span></span><br><span class="line"><span class="comment">; =&gt; Cuddle hunger:  22</span></span><br><span class="line"><span class="comment">; =&gt; Percent deteriorated:  3</span></span><br><span class="line"><span class="comment">; =&gt; SPH:  2134</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">swap!</span></span> fred update-in [<span class="symbol">:cuddle-hunger-level</span>] + <span class="number">30</span>)</span><br><span class="line"><span class="comment">; =&gt; Run, you fool!</span></span><br><span class="line"><span class="comment">; =&gt; The zombie&apos;s SPH is now 5044</span></span><br><span class="line"><span class="comment">; =&gt; This message brought to your courtesy of :fred-shuffle-alert</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>This example watch function didn&#x2019;t use <code>watched</code> or <code>old-state</code>, but they&#x2019;re there for you if the need arises. Now let&#x2019;s cover validators.</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x76D1;&#x89C6;&#x51FD;&#x6570;&#x4F8B;&#x5B50;&#x6CA1;&#x6709;&#x4F7F;&#x7528;<code>watched</code>&#x548C;<code>old-state</code>,&#x5982;&#x679C;&#x9700;&#x8981;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x3002;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x9A8C;&#x8BC1;&#x3002;</p>
<blockquote>
<p>Validators</p>
</blockquote>
<h3 id="&#x9A8C;&#x8BC1;"><a href="#&#x9A8C;&#x8BC1;" class="headerlink" title="&#x9A8C;&#x8BC1;"></a>&#x9A8C;&#x8BC1;</h3><blockquote>
<p><em>Validators</em> let you specify what states are allowable for a reference. For example, here&#x2019;s a validator that you could use to ensure that a zombie&#x2019;s <code>:percent-deteriorated</code> is between 0 and 100:</p>
</blockquote>
<p><em>&#x9A8C;&#x8BC1;</em> &#x7528;&#x6765;&#x6807;&#x660E;&#x5F15;&#x7528;&#x7684;&#x8BB8;&#x53EF;&#x7684;&#x72B6;&#x6001;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x8FD9;&#x4E2A;&#x9A8C;&#x8BC1;&#x7528;&#x6765;&#x786E;&#x4FDD;&#x50F5;&#x5C38;&#x7684;<code>:percent-deteriorated</code>&#x5728;0&#x548C;100&#x4E4B;&#x95F4;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> percent-deteriorated-validator</span><br><span class="line">  [{<span class="symbol">:keys</span> [percent-deteriorated]}]</span><br><span class="line">  (<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> percent-deteriorated <span class="number">0</span>)</span><br><span class="line">       (<span class="name"><span class="builtin-name">&lt;=</span></span> percent-deteriorated <span class="number">100</span>)))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>As you can see, the validator takes only one argument. When you add a validator to a reference, the reference is modified so that, whenever it&#x2019;s updated, it will call this validator with the value returned from the update function as its argument. If the validator fails by returning <code>false</code> or throwing an exception, the reference won&#x2019;t change to point to the new value.</p>
</blockquote>
<p>&#x6B63;&#x5982;&#x4F60;&#x770B;&#x5230;&#x7684;&#xFF0C;&#x9A8C;&#x8BC1;&#x53EA;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x3002;&#x628A;&#x9A8C;&#x8BC1;&#x6DFB;&#x52A0;&#x5230;&#x5F15;&#x7528;&#x65F6;&#xFF0C;&#x5F15;&#x7528;&#x88AB;&#x4FEE;&#x6539;&#x6210;&#xFF1A;&#x65E0;&#x8BBA;&#x4F55;&#x65F6;&#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#x88AB;&#x66F4;&#x65B0;&#xFF0C;&#x5B83;&#x90FD;&#x4F1A;&#x7528;&#x66F4;&#x65B0;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7684;&#x503C;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x9A8C;&#x8BC1;&#x51FD;&#x6570;&#x3002;&#x5982;&#x679C;&#x9A8C;&#x8BC1;&#x51FD;&#x6570;&#x5931;&#x8D25;&#xFF0C;&#x5373;&#x8FD4;&#x56DE;<code>false</code>&#x6216;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#xFF0C;&#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#x4E0D;&#x4F1A;&#x6539;&#x6210;&#x6307;&#x5411;&#x90A3;&#x4E2A;&#x65B0;&#x503C;&#x3002;</p>
<blockquote>
<p>You can attach a validator during atom creation:</p>
</blockquote>
<p>&#x539F;&#x5B50;&#x521B;&#x5EFA;&#x65F6;&#x53EF;&#x4EE5;&#x9644;&#x52A0;&#x9A8C;&#x8BC1;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> bobby</span><br><span class="line">  (<span class="name"><span class="builtin-name">atom</span></span></span><br><span class="line">   {<span class="symbol">:cuddle-hunger-level</span> <span class="number">0</span> <span class="symbol">:percent-deteriorated</span> <span class="number">0</span>}</span><br><span class="line">    <span class="symbol">:validator</span> percent-deteriorated-validator))</span><br><span class="line">(<span class="name"><span class="builtin-name">swap!</span></span> bobby update-in [<span class="symbol">:percent-deteriorated</span>] + <span class="number">200</span>)</span><br><span class="line"><span class="comment">; This throws &quot;Invalid reference state&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>In this example, <code>percent-deteriorated-validator</code> returned <code>false</code> and the atom update failed.</p>
</blockquote>
<p>&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;<code>percent-deteriorated-validator</code>&#x8FD4;&#x56DE;<code>false</code>,&#x5E76;&#x4E14;&#x8FD9;&#x4E2A;&#x539F;&#x5B50;&#x66F4;&#x65B0;&#x5931;&#x8D25;&#x3002;</p>
<blockquote>
<p>You can throw an exception to get a more descriptive error message:</p>
</blockquote>
<p>&#x4E3A;&#x4E86;&#x8BA9;&#x9519;&#x8BEF;&#x63CF;&#x8FF0;&#x66F4;&#x6E05;&#x695A;&#xFF0C;&#x53EF;&#x4EE5;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> percent-deteriorated-validator</span><br><span class="line">  [{<span class="symbol">:keys</span> [percent-deteriorated]}]</span><br><span class="line">  (<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">&gt;=</span></span> percent-deteriorated <span class="number">0</span>)</span><br><span class="line">           (<span class="name"><span class="builtin-name">&lt;=</span></span> percent-deteriorated <span class="number">100</span>))</span><br><span class="line">      (<span class="name"><span class="builtin-name">throw</span></span> (<span class="name">IllegalStateException.</span> <span class="string">&quot;That&apos;s not mathy!&quot;</span>))))</span><br><span class="line">(<span class="name"><span class="builtin-name">def</span></span> bobby</span><br><span class="line">  (<span class="name"><span class="builtin-name">atom</span></span></span><br><span class="line">   {<span class="symbol">:cuddle-hunger-level</span> <span class="number">0</span> <span class="symbol">:percent-deteriorated</span> <span class="number">0</span>}</span><br><span class="line">    <span class="symbol">:validator</span> percent-deteriorated-validator))</span><br><span class="line">(<span class="name"><span class="builtin-name">swap!</span></span> bobby update-in [<span class="symbol">:percent-deteriorated</span>] + <span class="number">200</span>)</span><br><span class="line"><span class="comment">; This throws &quot;IllegalStateException: That&apos;s not mathy!&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Pretty great! Now let&#x2019;s look at refs.</p>
</blockquote>
<p>&#x975E;&#x5E38;&#x68D2;&#xFF01;&#x73B0;&#x5728;&#x770B;&#x770B;&#x5F15;&#x7528;&#x3002;</p>
<blockquote>
<p>Atoms are ideal for managing the state of independent identities. Sometimes, though, we need to express that an event should update the state of more than one identity simultaneously. <em>Refs</em> are the perfect tool for this scenario.</p>
</blockquote>
<p>&#x7528;&#x539F;&#x5B50;&#x7BA1;&#x7406;&#x72EC;&#x7ACB;&#x7684;&#x8EAB;&#x4EFD;&#x5F88;&#x7406;&#x60F3;&#x3002;&#x4F46;&#x6709;&#x65F6;&#x9700;&#x8981;&#x540C;&#x65F6;&#x66F4;&#x65B0;&#x4E0D;&#x6B62;&#x4E00;&#x4E2A;&#x8EAB;&#x4EFD;&#x7684;&#x72B6;&#x6001;&#x3002;&#x8FD9;&#x4E2A;&#x573A;&#x5408;&#x4F7F;&#x7528;<em>&#x5F15;&#x7528;</em>&#x5F88;&#x5B8C;&#x7F8E;&#x3002;</p>
<blockquote>
<p>A classic example of this is recording sock gnome transactions. As we all know, sock gnomes take a single sock from every clothes dryer around the world. They use these socks to incubate their young. In return for this &#x201C;gift,&#x201D; sock gnomes protect your home from El Chupacabra. If you haven&#x2019;t been visited by El Chupacabra lately, you have sock gnomes to thank.</p>
</blockquote>
<p>&#x4E00;&#x4E2A;&#x7ECF;&#x5178;&#x4F8B;&#x5B50;&#x662F;&#x8BB0;&#x5F55;&#x889C;&#x5B50;&#x77EE;&#x4EBA;&#x4E8B;&#x52A1;&#x3002;&#x6211;&#x4EEC;&#x90FD;&#x77E5;&#x9053;&#xFF0C;&#x889C;&#x5B50;&#x77EE;&#x4EBA;&#x4ECE;&#x904D;&#x5E03;&#x4E16;&#x754C;&#x7684;&#x70D8;&#x5E72;&#x673A;&#x62FF;&#x8D70;&#x4E00;&#x53EA;&#x889C;&#x5B50;&#xFF0C;&#x7528;&#x6765;&#x517B;&#x80B2;&#x4ED6;&#x4EEC;&#x7684;&#x5C0F;&#x5B69;&#x3002;&#x4F5C;&#x4E3A;&#x56DE;&#x62A5;&#xFF0C;&#x4ED6;&#x4EEC;&#x4FDD;&#x62A4;&#x4F60;&#x7684;&#x5BB6;&#x5EAD;&#xFF0C;&#x514D;&#x53D7;&#x5438;&#x8840;&#x9B3C;&#x7684;&#x5165;&#x4FB5;&#x3002;&#x5982;&#x679C;&#x4F60;&#x8FD8;&#x6CA1;&#x6709;&#x88AB;&#x5438;&#x8840;&#x9B3C;&#x62DC;&#x8BBF;&#x8FC7;&#xFF0C;&#x4F60;&#x5E94;&#x8BE5;&#x611F;&#x8C22;&#x889C;&#x5B50;&#x77EE;&#x4EBA;&#x3002;</p>
<p><img src="/2016/07/22/clojure-metaphysics/sock-gnome.png" alt="sock-gnome"></p>
<blockquote>
<p>To model sock transfers, we need to express that a dryer has lost a sock and a gnome has gained a sock simultaneously. One moment the sock belongs to the dryer; the next it belongs to the gnome. The sock should never appear to belong to both the dryer and the gnome, nor should it appear to belong to neither.</p>
</blockquote>
<p>&#x4E3A;&#x4E86;&#x5BF9;&#x889C;&#x5B50;&#x8F6C;&#x6362;&#x5EFA;&#x6A21;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x540C;&#x65F6;&#x8868;&#x793A;&#x70D8;&#x5E72;&#x673A;&#x5C11;&#x4E86;&#x4E00;&#x53EA;&#x889C;&#x5B50;&#x548C;&#x77EE;&#x4EBA;&#x83B7;&#x5F97;&#x4E86;&#x4E00;&#x53EA;&#x889C;&#x5B50;&#x3002;&#x67D0;&#x4E2A;&#x65F6;&#x523B;&#x889C;&#x5B50;&#x5C5E;&#x4E8E;&#x70D8;&#x5E72;&#x673A;&#xFF0C;&#x4E0B;&#x4E00;&#x65F6;&#x523B;&#x5B83;&#x5C5E;&#x4E8E;&#x77EE;&#x4EBA;&#x3002;&#x889C;&#x5B50;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x540C;&#x65F6;&#x5C5E;&#x4E8E;&#x70D8;&#x5E72;&#x673A;&#x548C;&#x77EE;&#x4EBA;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x8C01;&#x90FD;&#x4E0D;&#x5C5E;&#x4E8E;&#x3002;</p>
<blockquote>
<p>Modeling Sock Transfers</p>
</blockquote>
<h3 id="&#x5EFA;&#x6A21;&#x889C;&#x5B50;&#x8F6C;&#x6362;"><a href="#&#x5EFA;&#x6A21;&#x889C;&#x5B50;&#x8F6C;&#x6362;" class="headerlink" title="&#x5EFA;&#x6A21;&#x889C;&#x5B50;&#x8F6C;&#x6362;"></a>&#x5EFA;&#x6A21;&#x889C;&#x5B50;&#x8F6C;&#x6362;</h3><blockquote>
<p>You can model this sock transfer with refs. Refs allow you to update the state of multiple identities using transaction semantics. These transactions have three features:</p>
</blockquote>
<p>&#x53EF;&#x4EE5;&#x7528;&#x5F15;&#x7528;&#x5EFA;&#x6A21;&#x889C;&#x5B50;&#x8F6C;&#x6362;&#x3002;&#x5F15;&#x7528;&#x53EF;&#x4EE5;&#x6309;&#x4E8B;&#x52A1;&#x8BED;&#x610F;&#x66F4;&#x65B0;&#x591A;&#x4E2A;&#x8EAB;&#x4EFD;&#x3002;&#x8FD9;&#x4E9B;&#x4E8B;&#x52A1;&#x6709;&#x4E09;&#x4E2A;&#x7279;&#x5F81;&#xFF1A;</p>
<blockquote>
<ul>
<li>They are atomic, meaning that all refs are updated or none of them are.</li>
<li>They are consistent, meaning that the refs always appear to have valid states. A sock will always belong to a dryer or a gnome, but never both or neither.</li>
<li>They are isolated, meaning that transactions behave as if they executed serially; if two threads are simultaneously running transactions that alter the same ref, one transaction will retry. This is similar to the compare-and-set semantics of atoms.</li>
</ul>
</blockquote>
<ul>
<li>&#x5B83;&#x4EEC;&#x662F;&#x539F;&#x5B50;&#x7684;&#xFF0C;&#x610F;&#x5473;&#x7740;&#x6240;&#x6709;&#x5F15;&#x7528;&#x6216;&#x8005;&#x5168;&#x66F4;&#x65B0;&#xFF0C;&#x6216;&#x8005;&#x5168;&#x4E0D;&#x66F4;&#x65B0;&#x3002;</li>
<li>&#x5B83;&#x4EEC;&#x662F;&#x4E00;&#x81F4;&#x7684;&#xFF0C;&#x610F;&#x5473;&#x7740;&#x8FD9;&#x4E9B;&#x5F15;&#x7528;&#x7684;&#x72B6;&#x6001;&#x603B;&#x662F;&#x6709;&#x6548;&#x7684;&#x3002;&#x4E00;&#x53EA;&#x889C;&#x5B50;&#x603B;&#x662F;&#x5C5E;&#x4E8E;&#x4E00;&#x4E2A;&#x70D8;&#x5E72;&#x673A;&#x6216;&#x4E00;&#x4E2A;&#x77EE;&#x4EBA;&#xFF0C;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x540C;&#x65F6;&#x5C5E;&#x4E8E;&#x6216;&#x90FD;&#x4E0D;&#x5C5E;&#x4E8E;&#x3002;</li>
<li>&#x5B83;&#x4EEC;&#x662F;&#x9694;&#x79BB;&#x7684;&#xFF0C;&#x610F;&#x5473;&#x7740;&#x6240;&#x6709;&#x4E8B;&#x52A1;&#x5C31;&#x50CF;&#x662F;&#x6309;&#x987A;&#x5E8F;&#x6267;&#x884C;&#x4E00;&#x6837;&#xFF1B;&#x5982;&#x679C;&#x4E24;&#x4E2A;&#x7EBF;&#x7A0B;&#x540C;&#x65F6;&#x8FD0;&#x884C;&#x66F4;&#x6539;&#x540C;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x7684;&#x4E8B;&#x52A1;&#xFF0C;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x5C06;&#x91CD;&#x8BD5;&#x3002;&#x8FD9;&#x4E0E;&#x539F;&#x5B50;&#x7684;&#x6BD4;&#x8F83;&#x5E76;&#x8BBE;&#x7F6E;&#x8BED;&#x610F;&#x7C7B;&#x4F3C;&#x3002;</li>
</ul>
<blockquote>
<p>You might recognize these as the A, C, and I in the ACID properties of database transactions. You can think of refs as giving you the same concurrency safety as database transactions, only with in-memory data.</p>
</blockquote>
<p>&#x4F60;&#x53EF;&#x80FD;&#x8BA4;&#x51FA;&#x8FD9;&#x662F;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;&#x7684;ACID&#x91CC;&#x7684;A,C,I&#x3002;&#x4F60;&#x53EF;&#x4EE5;&#x8BA4;&#x4E3A;&#x5F15;&#x7528;&#x4E0E;&#x6570;&#x636E;&#x5E93;&#x4E8B;&#x52A1;&#x7684;&#x5B89;&#x5168;&#x5E76;&#x53D1;&#x4E00;&#x6837;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x662F;&#x5BF9;&#x5185;&#x5B58;&#x6570;&#x636E;&#x64CD;&#x4F5C;&#x3002;</p>
<blockquote>
<p>Clojure uses <em>software transactional memory (STM)</em> to implement this behavior. STM is very cool, but when you&#x2019;re starting with Clojure, you don&#x2019;t need to know much about it; you just need to know how to use it, which is what this section shows you.</p>
</blockquote>
<p>Clojure&#x7528;<em>&#x8F6F;&#x4EF6;&#x4E8B;&#x52A1;&#x5185;&#x5B58;(STM)</em> &#x5B9E;&#x73B0;&#x8FD9;&#x4E2A;&#x884C;&#x4E3A;&#x3002;STM&#x975E;&#x5E38;&#x9177;&#xFF0C;&#x4F46;&#x521A;&#x5F00;&#x59CB;&#x5B66;&#x4E60;Clojure&#x65F6;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x5BF9;&#x5B83;&#x4E86;&#x89E3;&#x592A;&#x591A;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x77E5;&#x9053;&#x600E;&#x4E48;&#x7528;&#x5B83;&#xFF0C;&#x8FD9;&#x8282;&#x5C31;&#x4F1A;&#x6F14;&#x793A;&#x7ED9;&#x4F60;&#x3002;</p>
<blockquote>
<p>Let&#x2019;s start transferring some socks! First, you&#x2019;ll need to code up some sock- and gnome-creation technology. The following code defines some sock varieties, then defines a couple of helper functions: <code>sock-count</code> will be used to help keep track of how many of each kind of sock belongs to either a gnome or a dryer, and <code>generate-sock-gnome</code> creates a fresh, sockless gnome:</p>
</blockquote>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x5F00;&#x59CB;&#x8F6C;&#x6362;&#x889C;&#x5B50;&#xFF01;&#x9996;&#x5148;&#xFF0C;&#x9700;&#x8981;&#x4E00;&#x4E9B;&#x521B;&#x5EFA;&#x889C;&#x5B50;&#x548C;&#x77EE;&#x4EBA;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E9B;&#x889C;&#x5B50;&#x54C1;&#x79CD;&#xFF0C;&#x7136;&#x540E;&#x5B9A;&#x4E49;&#x4E86;&#x51E0;&#x4E2A;&#x8F85;&#x52A9;&#x51FD;&#x6570;&#xFF1A;<code>sock-count</code>&#x7528;&#x4E8E;&#x8BB0;&#x5F55;&#x70D8;&#x5E72;&#x673A;&#x548C;&#x77EE;&#x4EBA;&#x7684;&#x6BCF;&#x79CD;&#x889C;&#x5B50;&#x6709;&#x591A;&#x5C11;&#xFF0C;<code>generate-sock-gnome</code>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x889C;&#x5B50;&#x77EE;&#x4EBA;:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> sock-varieties</span><br><span class="line">  #{<span class="string">&quot;darned&quot;</span> <span class="string">&quot;argyle&quot;</span> <span class="string">&quot;wool&quot;</span> <span class="string">&quot;horsehair&quot;</span> <span class="string">&quot;mulleted&quot;</span></span><br><span class="line">    <span class="string">&quot;passive-aggressive&quot;</span> <span class="string">&quot;striped&quot;</span> <span class="string">&quot;polka-dotted&quot;</span></span><br><span class="line">    <span class="string">&quot;athletic&quot;</span> <span class="string">&quot;business&quot;</span> <span class="string">&quot;power&quot;</span> <span class="string">&quot;invisible&quot;</span> <span class="string">&quot;gollumed&quot;</span>})</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> sock-count</span><br><span class="line">  [sock-variety count]</span><br><span class="line">  {<span class="symbol">:variety</span> sock-variety</span><br><span class="line">   <span class="symbol">:count</span> count})</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> generate-sock-gnome</span><br><span class="line">  <span class="string">&quot;Create an initial sock gnome state with no socks&quot;</span></span><br><span class="line">  [name]</span><br><span class="line">  {<span class="symbol">:name</span> name</span><br><span class="line">   <span class="symbol">:socks</span> #{}})</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Now you can create your actual refs. The gnome will have 0 socks. The dryer, on the other hand, will have a set of sock pairs generated from the set of sock varieties. Here are our refs:</p>
</blockquote>
<p>&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x5F15;&#x7528;&#x4E86;&#x3002;&#x77EE;&#x4EBA;&#x6CA1;&#x6709;&#x889C;&#x5B50;&#x3002;&#x70D8;&#x5E72;&#x673A;&#x6709;&#x5F88;&#x591A;&#x53CC;&#x889C;&#x5B50;&#xFF0C;&#x6309;&#x889C;&#x5B50;&#x54C1;&#x724C;&#x96C6;&#x5408;&#x751F;&#x6210;&#x3002;&#x8FD9;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x5F15;&#x7528;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> sock-gnome (<span class="name"><span class="builtin-name">ref</span></span> (<span class="name">generate-sock-gnome</span> <span class="string">&quot;Barumpharumph&quot;</span>)))</span><br><span class="line">(<span class="name"><span class="builtin-name">def</span></span> dryer (<span class="name"><span class="builtin-name">ref</span></span> {<span class="symbol">:name</span> <span class="string">&quot;LG 1337&quot;</span></span><br><span class="line">                 <span class="symbol">:socks</span> (<span class="name">set</span> (<span class="name"><span class="builtin-name">map</span></span> #(<span class="name">sock-count</span> % <span class="number">2</span>) sock-varieties))}))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>You can dereference refs just like you can dereference atoms. In this example, the order of your socks will probably be different because we&#x2019;re using an unordered set:</p>
</blockquote>
<p>&#x540C;&#x539F;&#x5B50;&#x4E00;&#x6837;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5BF9;&#x5F15;&#x7528;&#x53D6;&#x503C;&#x3002;&#x4F8B;&#x5B50;&#x91CC;&#x889C;&#x5B50;&#x7684;&#x987A;&#x5E8F;&#x53EF;&#x80FD;&#x4E0E;&#x4F60;&#x7684;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x56E0;&#x4E3A;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x65E0;&#x5E8F;&#x96C6;&#x5408;&#xFF1A;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(:socks @dryer)</span><br><span class="line">; =&gt; #{{:variety &quot;passive-aggressive&quot;, :count 2} {:variety &quot;power&quot;, :count 2}</span><br><span class="line">       {:variety &quot;athletic&quot;, :count 2} {:variety &quot;business&quot;, :count 2}</span><br><span class="line">       {:variety &quot;argyle&quot;, :count 2} {:variety &quot;horsehair&quot;, :count 2}</span><br><span class="line">       {:variety &quot;gollumed&quot;, :count 2} {:variety &quot;darned&quot;, :count 2}</span><br><span class="line">       {:variety &quot;polka-dotted&quot;, :count 2} {:variety &quot;wool&quot;, :count 2}</span><br><span class="line">       {:variety &quot;mulleted&quot;, :count 2} {:variety &quot;striped&quot;, :count 2}</span><br><span class="line">       {:variety &quot;invisible&quot;, :count 2}}</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Now everything&#x2019;s in place to perform the transfer. We&#x2019;ll want to modify the <code>sock-gnome</code> ref to show that it has gained a sock and modify the <code>dryer</code> ref to show that it&#x2019;s lost a sock. You modify refs using <code>alter</code>, and you must use <code>alter</code> within a transaction. <code>dosync</code> initiates a transaction and defines its extent; you put all transaction operations in its body. Here we use these tools to define a <code>steal-sock</code> function, and then call it on our two refs:</p>
</blockquote>
<p>&#x73B0;&#x5728;&#x6267;&#x884C;&#x8F6C;&#x6362;&#x7684;&#x6240;&#x6709;&#x4E1C;&#x897F;&#x90FD;&#x5DF2;&#x5C31;&#x7EEA;&#x3002;&#x6211;&#x4EEC;&#x60F3;&#x4FEE;&#x6539;<code>sock-gnome</code>&#x5F15;&#x7528;&#xFF0C;&#x8868;&#x793A;&#x5B83;&#x5F97;&#x5230;&#x4E86;&#x4E00;&#x53EA;&#x889C;&#x5B50;&#xFF0C;&#x5E76;&#x4E14;&#x4FEE;&#x6539;<code>dryer</code>&#x5F15;&#x7528;&#xFF0C;&#x8868;&#x793A;&#x5B83;&#x5931;&#x53BB;&#x4E86;&#x4E00;&#x53EA;&#x889C;&#x5B50;&#x3002;&#x7528;<code>alter</code>&#x4FEE;&#x6539;&#x5F15;&#x7528;&#xFF0C;&#x800C;&#x4E14;<code>alter</code>&#x5FC5;&#x987B;&#x653E;&#x5728;&#x4E8B;&#x52A1;&#x5185;&#x3002;<code>dosync</code>&#x5F00;&#x59CB;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#xFF0C;&#x5E76;&#x5B9A;&#x4E49;&#x5176;&#x5185;&#x5BB9;&#xFF0C;&#x6240;&#x6709;&#x4E8B;&#x52A1;&#x64CD;&#x4F5C;&#x90FD;&#x653E;&#x5728;<code>dosync</code>&#x4E3B;&#x4F53;&#x5185;&#x3002;&#x6211;&#x4EEC;&#x7528;&#x8FD9;&#x4E9B;&#x5DE5;&#x5177;&#x5B9A;&#x4E49;<code>steal-sock</code>&#x51FD;&#x6570;&#xFF0C;&#x7136;&#x540E;&#x5BF9;&#x4E24;&#x4E2A;&#x5F15;&#x7528;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> steal-sock</span><br><span class="line">  [gnome dryer]</span><br><span class="line">  (<span class="name"><span class="builtin-name">dosync</span></span></span><br><span class="line">   (<span class="name"><span class="builtin-name">when-let</span></span> [pair (<span class="name">some</span> #(<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> (<span class="symbol">:count</span> %) <span class="number">2</span>) %) (<span class="symbol">:socks</span> @dryer))]</span><br><span class="line">     (<span class="name"><span class="builtin-name">let</span></span> [updated-count (<span class="name">sock-count</span> (<span class="symbol">:variety</span> pair) <span class="number">1</span>)]</span><br><span class="line">       (<span class="name"><span class="builtin-name">alter</span></span> gnome update-in [<span class="symbol">:socks</span>] conj updated-count)</span><br><span class="line">       (<span class="name"><span class="builtin-name">alter</span></span> dryer update-in [<span class="symbol">:socks</span>] disj pair)</span><br><span class="line">       (<span class="name"><span class="builtin-name">alter</span></span> dryer update-in [<span class="symbol">:socks</span>] conj updated-count)))))</span><br><span class="line">(<span class="name">steal-sock</span> sock-gnome dryer)</span><br><span class="line"></span><br><span class="line">(<span class="symbol">:socks</span> @sock-gnome)</span><br><span class="line"><span class="comment">; =&gt; #{{:variety &quot;passive-aggressive&quot;, :count 1}}</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Now the gnome has one <code>passive-aggressive</code> sock, and the dryer has one less (your gnome may have stolen a different sock because the socks are stored in an unordered set). Let&#x2019;s make sure all <code>passive-aggressive</code> socks are accounted for:</p>
</blockquote>
<p>&#x73B0;&#x5728;&#x77EE;&#x4EBA;&#x6709;&#x4E00;&#x53EA;<code>passive-aggressive</code>&#x889C;&#x5B50;&#xFF0C;&#x540C;&#x65F6;&#x70D8;&#x5E72;&#x673A;&#x5C11;&#x4E86;&#x4E00;&#x53EA;(&#x56E0;&#x4E3A;&#x889C;&#x5B50;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x65E0;&#x5E8F;&#x96C6;&#x5408;&#xFF0C;&#x4F60;&#x7684;&#x77EE;&#x4EBA;&#x53EF;&#x80FD;&#x5077;&#x7684;&#x662F;&#x4E0D;&#x540C;&#x7684;&#x889C;&#x5B50;)&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x786E;&#x8BA4;&#x4E00;&#x4E0B;&#x53CC;&#x65B9;&#x7684;<code>passive-aggressive</code>&#x889C;&#x5B50;&#x90FD;&#x6539;&#x53D8;&#x4E86;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> similar-socks</span><br><span class="line">  [target-sock sock-set]</span><br><span class="line">  (<span class="name"><span class="builtin-name">filter</span></span> #(<span class="name"><span class="builtin-name">=</span></span> (<span class="symbol">:variety</span> %) (<span class="symbol">:variety</span> target-sock)) sock-set))</span><br><span class="line"></span><br><span class="line">(<span class="name">similar-socks</span> (<span class="name"><span class="builtin-name">first</span></span> (<span class="symbol">:socks</span> @sock-gnome)) (<span class="symbol">:socks</span> @dryer))</span><br><span class="line"><span class="comment">; =&gt; ({:variety &quot;passive-aggressive&quot;, :count 1})</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>There are a couple of details to note here: when you <code>alter</code> a ref, the change isn&#x2019;t immediately visible outside of the current transaction. This is what lets you call <code>alter</code> on the <code>dryer</code> twice within a transaction without worry&#xAD;ing about whether <code>dryer</code> will be read in an inconsistent state. Similarly, if you <code>alter</code> a ref and then <code>deref</code> it within the same transaction, the <code>deref</code> will return the new state.</p>
</blockquote>
<p>&#x8FD9;&#x6709;&#x51E0;&#x4E2A;&#x7EC6;&#x8282;&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF1A;<code>alter</code>&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x65F6;&#xFF0C;&#x8FD9;&#x4E2A;&#x4FEE;&#x6539;&#x5BF9;&#x4E8E;&#x5F53;&#x524D;&#x4E8B;&#x52A1;&#x5916;&#x9762;&#x4E0D;&#x662F;&#x7ACB;&#x523B;&#x53EF;&#x89C1;&#x7684;&#x3002;&#x6B63;&#x662F;&#x8FD9;&#x70B9;&#x8BA9;&#x4F60;&#x80FD;&#x591F;&#x5728;&#x4E8B;&#x52A1;&#x5185;<code>alter</code>&#x4E24;&#x6B21;<code>dryer</code>&#xFF0C;&#x800C;&#x4E0D;&#x7528;&#x62C5;&#x5FC3;<code>dryer</code>&#x88AB;&#x4E0D;&#x4E00;&#x81F4;&#x5730;&#x8BFB;&#x53D6;&#x3002;&#x5982;&#x679C;&#x5728;&#x540C;&#x4E00;&#x4E8B;&#x52A1;&#x5185;<code>alter</code>&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#xFF0C;&#x7136;&#x540E;&#x518D;<code>deref</code>&#x8FD9;&#x4E2A;&#x5F15;&#x7528;&#xFF0C;<code>deref</code>&#x4F1A;&#x8FD4;&#x56DE;&#x65B0;&#x72B6;&#x6001;&#x3002;</p>
<blockquote>
<p>Here&#x2019;s an example to demonstrate this idea of in-transaction state:</p>
</blockquote>
<p>&#x4E8B;&#x52A1;&#x5185;&#x72B6;&#x6001;&#x4F8B;&#x5B50;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> counter (<span class="name"><span class="builtin-name">ref</span></span> <span class="number">0</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">future</span></span></span><br><span class="line">  (<span class="name"><span class="builtin-name">dosync</span></span></span><br><span class="line">   (<span class="name"><span class="builtin-name">alter</span></span> counter inc)</span><br><span class="line">   (<span class="name">println</span> @counter)</span><br><span class="line">   (<span class="name">Thread/sleep</span> <span class="number">500</span>)</span><br><span class="line">   (<span class="name"><span class="builtin-name">alter</span></span> counter inc)</span><br><span class="line">   (<span class="name">println</span> @counter)))</span><br><span class="line">(<span class="name">Thread/sleep</span> <span class="number">250</span>)</span><br><span class="line">(<span class="name">println</span> @counter)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This prints 1, 0 , and 2, in that order. First, you create a ref, <code>counter</code>, which holds the number 0. Then you use <code>future</code> to create a new thread to run a transaction on. On the transaction thread, you increment the counter and print it, and the number 1 gets printed. Meanwhile, the main thread waits 250 milliseconds and prints the counter&#x2019;s value, too. However, the value of counter on the main thread is still 0&#x2014;the main thread is outside of the transaction and doesn&#x2019;t have access to the transaction&#x2019;s state. It&#x2019;s like the transaction has its own private area for trying out changes to the state, and the rest of the world can&#x2019;t know about them until the transaction is done. This is further illustrated in the transaction code: after it prints the first time, it increments the counter again from 1 to 2 and prints the result, 2.</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x6309;1&#xFF0C;0&#xFF0C;2&#x7684;&#x987A;&#x5E8F;&#x6253;&#x5370;&#x3002;&#x9996;&#x5148;&#x521B;&#x5EFA;&#x5F15;&#x7528;<code>counter</code>,&#x503C;&#x662F;0&#x3002;&#x7136;&#x540E;&#x7528;<code>future</code>&#x521B;&#x5EFA;&#x65B0;&#x7EBF;&#x7A0B;&#x8FD0;&#x884C;&#x4E8B;&#x52A1;&#x3002;&#x4E8B;&#x52A1;&#x7EBF;&#x7A0B;&#x4E0A;&#x8BA1;&#x6570;&#x5668;&#x52A0;&#x4E00;&#x5E76;&#x6253;&#x5370;&#x3002;&#x540C;&#x65F6;&#x4E3B;&#x7EBF;&#x7A0B;&#x7B49;&#x5F85;250&#x6BEB;&#x79D2;&#x5E76;&#x6253;&#x5370;&#x8BA1;&#x6570;&#x5668;&#x7684;&#x503C;&#x3002;&#x4F46;&#x4E3B;&#x7EBF;&#x7A0B;&#x4E0A;&#x8BA1;&#x6570;&#x5668;&#x7684;&#x503C;&#x4ECD;&#x7136;&#x662F;0&#xFF0C;&#x4E3B;&#x7EBF;&#x7A0B;&#x5728;&#x4E8B;&#x52A1;&#x5916;&#x9762;&#xFF0C;&#x65E0;&#x6743;&#x8BBF;&#x95EE;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x3002;&#x5C31;&#x597D;&#x50CF;&#x4E8B;&#x52A1;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x79C1;&#x6709;&#x533A;&#x57DF;&#x7528;&#x4E8E;&#x5C1D;&#x8BD5;&#x4FEE;&#x6539;&#x72B6;&#x6001;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x533A;&#x57DF;&#x5916;&#x7684;&#x4E16;&#x754C;&#x76F4;&#x5230;&#x4E8B;&#x52A1;&#x5B8C;&#x6210;&#x624D;&#x4F1A;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x4FEE;&#x6539;&#x3002;&#x4E8B;&#x52A1;&#x4EE3;&#x7801;&#x8FDB;&#x4E00;&#x6B65;&#x6F14;&#x793A;&#x4E86;&#x8FD9;&#x70B9;&#xFF1A;&#x7B2C;&#x4E00;&#x6B21;&#x6253;&#x5370;&#x540E;&#xFF0C;&#x628A;&#x8BA1;&#x6570;&#x5668;&#x4ECE;1&#x589E;&#x52A0;&#x5230;2&#xFF0C;&#x5E76;&#x6253;&#x5370;&#x7ED3;&#x679C;&#xFF0C;2&#x3002;</p>
<blockquote>
<p>The transaction will try to commit its changes only when it ends. The commit works similarly to the compare-and-set semantics of atoms. Each ref is checked to see whether it&#x2019;s changed since you first tried to alter it. If any of the refs have changed, then none of the refs is updated and the transaction is retried. For example, if Transaction A and Transaction B are both attempted at the same time and events occur in the following order, Transaction A will be retried:</p>
</blockquote>
<p>&#x53EA;&#x6709;&#x5B8C;&#x6210;&#x65F6;&#xFF0C;&#x4E8B;&#x52A1;&#x624D;&#x5C1D;&#x8BD5;&#x63D0;&#x4EA4;&#x4FEE;&#x6539;&#x3002;&#x63D0;&#x4EA4;&#x7684;&#x5DE5;&#x4F5C;&#x65B9;&#x5F0F;&#x4E0E;&#x539F;&#x5B50;&#x7684;&#x6BD4;&#x8F83;&#x5E76;&#x8BBE;&#x7F6E;&#x8BED;&#x610F;&#x7C7B;&#x4F3C;&#x3002;&#x5982;&#x679C;&#x6709;&#x4EFB;&#x4F55;&#x5F15;&#x7528;&#x88AB;&#x4FEE;&#x6539;&#x4E86;&#xFF0C;&#x90A3;&#x4E48;&#x6240;&#x6709;&#x5F15;&#x7528;&#x90FD;&#x4E0D;&#x4F1A;&#x66F4;&#x65B0;&#xFF0C;&#x540C;&#x65F6;&#x4E8B;&#x52A1;&#x5C06;&#x91CD;&#x8BD5;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x4E8B;&#x52A1;A&#x548C;&#x4E8B;&#x52A1;B&#x5728;&#x540C;&#x4E00;&#x65F6;&#x95F4;&#x53D1;&#x751F;&#xFF0C;&#x5E76;&#x4E14;&#x4E8B;&#x4EF6;&#x6309;&#x4E0B;&#x5217;&#x987A;&#x5E8F;&#x53D1;&#x751F;&#xFF0C;&#x4E8B;&#x52A1;A&#x4F1A;&#x91CD;&#x8BD5;&#xFF1A;</p>
<blockquote>
<ol>
<li>Transaction A: alter gnome</li>
<li>Transaction B: alter gnome</li>
<li>Transaction B: alter dryer</li>
<li>Transaction B: alter dryer</li>
<li>Transaction B: commit&#x2014;successfully updates gnome and dryer</li>
<li>Transaction A: alter dryer</li>
<li>Transaction A: alter dryer</li>
<li>Transaction A: commit&#x2014;fails because dryer and gnome have changed; retries.</li>
</ol>
</blockquote>
<ol>
<li>&#x4E8B;&#x52A1;A: &#x4FEE;&#x6539;&#x77EE;&#x4EBA;</li>
<li>&#x4E8B;&#x52A1;B: &#x4FEE;&#x6539;&#x77EE;&#x4EBA;</li>
<li>&#x4E8B;&#x52A1;B: &#x4FEE;&#x6539;&#x70D8;&#x5E72;&#x673A;</li>
<li>&#x4E8B;&#x52A1;B: &#x4FEE;&#x6539;&#x70D8;&#x5E72;&#x673A;</li>
<li>&#x4E8B;&#x52A1;B: &#x63D0;&#x4EA4;&#x6210;&#x529F;&#xFF0C;&#x66F4;&#x65B0;&#x77EE;&#x4EBA;&#x548C;&#x70D8;&#x5E72;&#x673A;</li>
<li>&#x4E8B;&#x52A1;A: &#x4FEE;&#x6539;&#x70D8;&#x5E72;&#x673A;</li>
<li>&#x4E8B;&#x52A1;A: &#x4FEE;&#x6539;&#x70D8;&#x5E72;&#x673A;</li>
<li>&#x4E8B;&#x52A1;A: &#x63D0;&#x4EA4;&#x5931;&#x8D25;&#xFF0C;&#x56E0;&#x4E3A;&#x77EE;&#x4EBA;&#x548C;&#x70D8;&#x5E72;&#x673A;&#x5DF2;&#x7ECF;&#x6539;&#x53D8;&#xFF1B;&#x91CD;&#x8BD5;</li>
</ol>
<blockquote>
<p>And there you have it! Safe, easy, concurrent coordination of state changes. But that&#x2019;s not all! Refs have one more trick up their suspiciously long sleeve: <code>commute</code>.</p>
</blockquote>
<p>&#x7ED9;&#x4F60;&#xFF01;&#x8FD9;&#x8FD9;&#x4E2A;&#x5B89;&#x5168;&#xFF0C;&#x5BB9;&#x6613;&#xFF0C;&#x5E76;&#x53D1;&#x7684;&#x72B6;&#x6001;&#x6539;&#x53D8;&#x534F;&#x8C03;&#x5DE5;&#x5177;&#xFF01;&#x4F46;&#x8FD9;&#x8FD8;&#x4E0D;&#x662F;&#x5168;&#x90E8;&#xFF01;&#x5728;&#x51FA;&#x5947;&#x7684;&#x957F;&#x8896;&#x91CC;&#xFF0C;&#x5F15;&#x7528;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x628A;&#x620F;&#xFF1A;<code>commute</code>&#x3002;</p>
<blockquote>
<p>commute</p>
</blockquote>
<h3 id="&#x4EA4;&#x6362;"><a href="#&#x4EA4;&#x6362;" class="headerlink" title="&#x4EA4;&#x6362;"></a>&#x4EA4;&#x6362;</h3><blockquote>
<p><code>commute</code> allows you to update a ref&#x2019;s state within a transaction, just like <code>alter</code>. However, its behavior at commit time is completely different. Here&#x2019;s how <code>alter</code> behaves:</p>
</blockquote>
<p>&#x50CF;<code>alter</code>&#x4E00;&#x6837;&#xFF0C;&#x7528;<code>commute</code>&#x53EF;&#x4EE5;&#x5728;&#x4E8B;&#x52A1;&#x5185;&#x66F4;&#x65B0;&#x5F15;&#x7528;&#x7684;&#x72B6;&#x6001;&#x3002;&#x4F46;&#x5B83;&#x63D0;&#x4EA4;&#x65F6;&#x5019;&#x7684;&#x884C;&#x4E3A;&#x5B8C;&#x5168;&#x4E0D;&#x540C;&#x3002;<code>alter</code>&#x7684;&#x884C;&#x4E3A;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p>
<blockquote>
<ol>
<li>Reach outside the transaction and read the ref&#x2019;s current state.</li>
<li>Compare the current state to the state the ref started with within the transaction.</li>
<li>If the two differ, make the transaction retry.</li>
<li>Otherwise, commit the altered ref state.</li>
</ol>
</blockquote>
<ol>
<li>&#x53BB;&#x4E8B;&#x52A1;&#x5916;&#x9762;&#x8BFB;&#x53D6;&#x5F15;&#x7528;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x3002;</li>
<li>&#x628A;&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x4E0E;&#x4E8B;&#x52A1;&#x5185;&#x5F15;&#x7528;&#x5F00;&#x59CB;&#x65F6;&#x5019;&#x7684;&#x72B6;&#x6001;&#x6BD4;&#x8F83;&#x3002;</li>
<li>&#x5982;&#x679C;&#x4E0D;&#x540C;&#xFF0C;&#x91CD;&#x8BD5;&#x8FD9;&#x4E2A;&#x4E8B;&#x52A1;&#x3002;</li>
<li>&#x5426;&#x5219;&#x63D0;&#x4EA4;&#x4FEE;&#x6539;&#x540E;&#x7684;&#x72B6;&#x6001;&#x3002;</li>
</ol>
<blockquote>
<p><code>commute</code>, on the other hand, behaves like this at commit time:</p>
</blockquote>
<p><code>commute</code>&#x63D0;&#x4EA4;&#x65F6;&#x5019;&#x7684;&#x7684;&#x884C;&#x4E3A;&#xFF1A;</p>
<blockquote>
<ol>
<li>Reach outside the transaction and read the ref&#x2019;s current state.</li>
<li>Run the commute function again using the current state.</li>
<li>Commit the result.</li>
</ol>
</blockquote>
<ol>
<li>&#x53BB;&#x4E8B;&#x52A1;&#x5916;&#x9762;&#x8BFB;&#x53D6;&#x5F15;&#x7528;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x3002;</li>
<li>&#x7528;&#x8FD9;&#x4E2A;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x518D;&#x6B21;&#x8FD0;&#x884C;&#x4EA4;&#x6362;&#x51FD;&#x6570;&#x3002;</li>
<li>&#x63D0;&#x4EA4;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#x3002;</li>
</ol>
<blockquote>
<p>As you can see, <code>commute</code> doesn&#x2019;t ever force a transaction retry. This can help improve performance, but it&#x2019;s important that you only use <code>commute</code> when you&#x2019;re sure that it&#x2019;s not possible for your refs to end up in an invalid state. Let&#x2019;s look at examples of safe and unsafe uses of <code>commute</code>.</p>
</blockquote>
<p>&#x5982;&#x4F60;&#x6240;&#x89C1;&#xFF0C;<code>commute</code>&#x4E0D;&#x4F1A;&#x5F3A;&#x5236;&#x4E8B;&#x52A1;&#x91CD;&#x8BD5;&#x3002;&#x8FD9;&#x6709;&#x52A9;&#x4E8E;&#x63D0;&#x5347;&#x6027;&#x80FD;&#xFF0C;&#x4F46;&#x53EA;&#x6709;&#x5F53;&#x4F60;&#x786E;&#x8BA4;&#x5F15;&#x7528;&#x7684;&#x6700;&#x7EC8;&#x72B6;&#x6001;&#x662F;&#x6709;&#x6548;&#x7684;&#xFF0C;&#x4F60;&#x624D;&#x80FD;&#x4F7F;&#x7528;<code>commute</code>&#x3002;&#x8FD9;&#x70B9;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x3002;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x5B89;&#x5168;&#x548C;&#x4E0D;&#x5B89;&#x5168;&#x4F7F;&#x7528;<code>commute</code>&#x7684;&#x4F8B;&#x5B50;&#x3002;</p>
<blockquote>
<p>Here&#x2019;s an example of a safe use. The <code>sleep-print-update</code> function returns the updated state but also sleeps the specified number of milliseconds so we can force transaction overlap. It prints the state that it&#x2019;s attempting to update so we can gain insight into what&#x2019;s going on:</p>
</blockquote>
<p>&#x8FD9;&#x662F;&#x4E2A;&#x5B89;&#x5168;&#x4F7F;&#x7528;&#x7684;&#x4F8B;&#x5B50;&#x3002;<code>sleep-print-update</code>&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x66F4;&#x65B0;&#x540E;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x4E3A;&#x4E86;&#x5F3A;&#x5236;&#x4E8B;&#x52A1;&#x91CD;&#x53E0;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7761;&#x7720;&#x6307;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x4E3A;&#x4E86;&#x6211;&#x4EEC;&#x7406;&#x89E3;&#x5185;&#x90E8;&#x53D1;&#x751F;&#x4E86;&#x4EC0;&#x4E48;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E5F;&#x6253;&#x5370;&#x4E86;&#x5B83;&#x6B63;&#x5728;&#x4FEE;&#x6539;&#x7684;&#x72B6;&#x6001;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> sleep-print-update</span><br><span class="line">  [sleep-time thread-name update-fn]</span><br><span class="line">  (<span class="name"><span class="builtin-name">fn</span></span> [state]</span><br><span class="line">    (<span class="name">Thread/sleep</span> sleep-time)</span><br><span class="line">    (<span class="name">println</span> (<span class="name"><span class="builtin-name">str</span></span> thread-name <span class="string">&quot;: &quot;</span> state))</span><br><span class="line">    (<span class="name">update-fn</span> state)))</span><br><span class="line">(<span class="name"><span class="builtin-name">def</span></span> counter (<span class="name"><span class="builtin-name">ref</span></span> <span class="number">0</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">future</span></span> (<span class="name"><span class="builtin-name">dosync</span></span> (<span class="name"><span class="builtin-name">commute</span></span> counter (<span class="name">sleep-print-update</span> <span class="number">100</span> <span class="string">&quot;Thread A&quot;</span> inc))))</span><br><span class="line">(<span class="name"><span class="builtin-name">future</span></span> (<span class="name"><span class="builtin-name">dosync</span></span> (<span class="name"><span class="builtin-name">commute</span></span> counter (<span class="name">sleep-print-update</span> <span class="number">150</span> <span class="string">&quot;Thread B&quot;</span> inc))))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Here&#x2019;s a timeline of what prints:</p>
</blockquote>
<p>&#x8FD9;&#x662F;&#x4EE3;&#x7801;&#x6253;&#x5370;&#x7684;&#x65F6;&#x95F4;&#x7EBF;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thread A: 0 | 100ms</span><br><span class="line">Thread B: 0 | 150ms</span><br><span class="line">Thread A: 0 | 200ms</span><br><span class="line">Thread B: 1 | 300ms</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notice that the last printed line reads <code>Thread B: 1</code>. That means that <code>sleep-print-update</code> receives <code>1</code> as the argument for state the second time it runs. That makes sense, because Thread A has committed its result by that point. If you dereference <code>counter</code> after the transactions run, you&#x2019;ll see that the value is <code>2</code>.</p>
</blockquote>
<p>&#x6CE8;&#x610F;&#x6700;&#x540E;&#x4E00;&#x884C;&#x6253;&#x5370;&#x7684;&#x662F;<code>Thread B: 1</code>&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;<code>sleep-print-update</code>&#x7B2C;&#x4E8C;&#x6B21;&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x63A5;&#x53D7;&#x7684;&#x72B6;&#x6001;&#x53C2;&#x6570;&#x662F;<code>1</code>&#x3002;&#x8FD9;&#x662F;&#x5BF9;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x65F6;&#x5019;&#x7EBF;&#x7A0B;A&#x5DF2;&#x7ECF;&#x63D0;&#x4EA4;&#x4E86;&#x7ED3;&#x679C;&#x3002;&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x4E8B;&#x52A1;&#x7ED3;&#x675F;&#x540E;&#x4F60;&#x5BF9;<code>counter</code>&#x53D6;&#x503C;&#xFF0C;&#x4F60;&#x4F1A;&#x770B;&#x5230;&#x503C;&#x662F;<code>2</code>&#x3002;</p>
<p>[&#x8BD1;&#x8005;&#x589E;&#x52A0;]</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@counter</span><br><span class="line">; =&gt; 2</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Now, here&#x2019;s an example of unsafe commuting:</p>
</blockquote>
<p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4E0D;&#x5B89;&#x5168;&#x7684;&#x4EA4;&#x6362;&#xFF1A;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(def receiver-a (ref #{}))</span><br><span class="line">(def receiver-b (ref #{}))</span><br><span class="line">(def giver (ref #{1}))</span><br><span class="line">(do (future (dosync (let [gift (first @giver)]</span><br><span class="line">                      (Thread/sleep 10)</span><br><span class="line">                      (commute receiver-a conj gift)</span><br><span class="line">                      (commute giver disj gift))))</span><br><span class="line">    (future (dosync (let [gift (first @giver)]</span><br><span class="line">                      (Thread/sleep 50)</span><br><span class="line">                      (commute receiver-b conj gift)</span><br><span class="line">                      (commute giver disj gift)))))</span><br><span class="line"></span><br><span class="line">@receiver-a</span><br><span class="line">; =&gt; #{1}</span><br><span class="line"></span><br><span class="line">@receiver-b</span><br><span class="line">; =&gt; #{1}</span><br><span class="line"></span><br><span class="line">@giver</span><br><span class="line">; =&gt; #{}</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The <code>1</code> was given to both <code>receiver-a</code> and <code>receiver-b</code>, and you&#x2019;ve ended up with two instances of <code>1</code>, which isn&#x2019;t valid for your program. What&#x2019;s different about this example is that the functions that are applied, essentially <code>#(conj % gift)</code> and <code>#(disj % gift)</code>, are derived from the state of <code>giver</code>. Once <code>giver</code> changes, the derived functions produce an invalid state, but <code>commute</code> doesn&#x2019;t care that the resulting state is invalid and commits the result anyway. The lesson here is that although <code>commute</code> can help speed up your programs, you have to be judicious about when to use it.</p>
</blockquote>
<p><code>1</code>&#x540C;&#x65F6;&#x7ED9;&#x4E86;<code>receiver-a</code>&#x548C;<code>receiver-b</code>,&#x6700;&#x540E;&#x6709;&#x4E24;&#x4E2A;<code>1</code>,&#x5BF9;&#x4E8E;&#x7A0B;&#x5E8F;&#x8FD9;&#x662F;&#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x3002;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x7684;&#x5DEE;&#x522B;&#x5728;&#x4E8E;&#x5E94;&#x7528;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x672C;&#x8D28;&#x4E0A;&#x8BF4;&#xFF0C;<code>#(conj % gift)</code> &#x548C; <code>#(disj % gift)</code> &#x662F;&#x4ECE;<code>giver</code>&#x7684;&#x72B6;&#x6001;&#x5F97;&#x5230;&#x7684;&#x3002;&#x4E00;&#x65E6;<code>giver</code>&#x6539;&#x53D8;&#xFF0C;&#x5F97;&#x5230;&#x7684;&#x51FD;&#x6570;&#x5C31;&#x4F1A;&#x4EA7;&#x751F;&#x4E0D;&#x5408;&#x6CD5;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x4F46;<code>commute</code>&#x4E0D;&#x5173;&#x5FC3;&#x8FD9;&#x4E2A;&#x5E76;&#x63D0;&#x4EA4;&#x4E86;&#x7ED3;&#x679C;&#x3002;&#x6559;&#x8BAD;&#x662F;&#x867D;&#x7136;<code>commute</code>&#x6709;&#x52A9;&#x4E8E;&#x52A0;&#x5FEB;&#x7A0B;&#x5E8F;&#x901F;&#x5EA6;&#xFF0C;&#x4F46;&#x5FC5;&#x987B;&#x8003;&#x8651;&#x597D;&#x518D;&#x4F7F;&#x7528;&#x3002;</p>
<p>[&#x8BD1;&#x8005;&#x589E;&#x52A0;&#xFF0C;&#x5BF9;&#x6BD4;&#x4F7F;&#x7528;<code>alter</code>&#x7684;&#x7ED3;&#x679C;]</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(def receiver-a (ref #{}))</span><br><span class="line">(def receiver-b (ref #{}))</span><br><span class="line">(def giver (ref #{1}))</span><br><span class="line">(do (future (dosync (let [gift (first @giver)]</span><br><span class="line">                      (Thread/sleep 10)</span><br><span class="line">                      (alter receiver-a conj gift)</span><br><span class="line">                      (alter giver disj gift))))</span><br><span class="line">    (future (dosync (let [gift (first @giver)]</span><br><span class="line">                      (Thread/sleep 50)</span><br><span class="line">                      (alter receiver-b conj gift)</span><br><span class="line">                      (alter giver disj gift)))))</span><br><span class="line"></span><br><span class="line">@receiver-a</span><br><span class="line">; =&gt; #{1}</span><br><span class="line"></span><br><span class="line">@receiver-b</span><br><span class="line">; =&gt; #{nil}</span><br><span class="line"></span><br><span class="line">@giver</span><br><span class="line">; =&gt; #{}</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Now you&#x2019;re ready to start using refs safely and sanely. Refs have a few more nuances that I won&#x2019;t cover here, but if you&#x2019;re curious about them, you can research the <code>ensure</code> function and the phenomenon <em>write skew</em>.</p>
</blockquote>
<p>&#x73B0;&#x5728;&#x4F60;&#x5DF2;&#x7ECF;&#x51C6;&#x5907;&#x597D;&#x5B89;&#x5168;&#x5E76;&#x660E;&#x667A;&#x5730;&#x4F7F;&#x7528;&#x5F15;&#x7528;&#x4E86;&#x3002;&#x5F15;&#x7528;&#x8FD8;&#x6709;&#x51E0;&#x4E2A;&#x6211;&#x6CA1;&#x6709;&#x8BB2;&#x5230;&#x7684;&#x7EC6;&#x8282;&#xFF0C;&#x5982;&#x679C;&#x611F;&#x5174;&#x8DA3;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x7814;&#x7A76;<code>ensure</code>&#x51FD;&#x6570;&#x548C;<em>write skew</em>&#x73B0;&#x8C61;&#x3002;</p>
<blockquote>
<p>On to the final reference type that this book covers: <em>vars</em>.</p>
</blockquote>
<p>&#x672C;&#x4E66;&#x6700;&#x540E;&#x8BB2;&#x89E3;&#x7684;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x662F;<em>&#x53D8;&#x91CF;</em>&#x3002;</p>
<blockquote>
<p>Vars</p>
</blockquote>
<h2 id="&#x53D8;&#x91CF;"><a href="#&#x53D8;&#x91CF;" class="headerlink" title="&#x53D8;&#x91CF;"></a>&#x53D8;&#x91CF;</h2><blockquote>
<p>You&#x2019;ve already learned a bit about vars in Chapter 6. To recap briefly, vars are associations between symbols and objects. You create new vars with <code>def</code>.</p>
</blockquote>
<p>&#x7B2C;&#x516D;&#x7AE0;&#x4F60;&#x5BF9;&#x53D8;&#x91CF;&#x5DF2;&#x7ECF;&#x6709;&#x4E86;&#x4E00;&#x4E9B;&#x4E86;&#x89E3;&#x3002;&#x7B80;&#x8981;&#x6982;&#x62EC;&#x4E00;&#x4E0B;&#xFF0C;&#x53D8;&#x91CF;&#x662F;&#x7B26;&#x53F7;&#x4E0E;&#x5BF9;&#x8C61;&#x4E4B;&#x95F4;&#x7684;&#x5173;&#x8054;&#x3002;&#x7528;<code>def</code>&#x521B;&#x5EFA;&#x65B0;&#x53D8;&#x91CF;&#x3002;</p>
<blockquote>
<p>Although vars aren&#x2019;t used to manage state in the same way as atoms and refs, they do have a couple of concurrency tricks: you can dynamically bind them, and you can alter their roots. Let&#x2019;s look at dynamic binding first.</p>
</blockquote>
<p>&#x867D;&#x7136;&#x53D8;&#x91CF;&#x4E0D;&#x50CF;&#x539F;&#x5B50;&#x548C;&#x5F15;&#x7528;&#x90A3;&#x6837;&#x7528;&#x4E8E;&#x7BA1;&#x7406;&#x72B6;&#x6001;&#xFF0C;&#x4F46;&#x5B83;&#x786E;&#x5B9E;&#x6709;&#x51E0;&#x4E2A;&#x5E76;&#x53D1;&#x82B1;&#x62DB;&#xFF1A;&#x4F60;&#x53EF;&#x4EE5;&#x52A8;&#x6001;&#x7ED1;&#x5B9A;&#x53D8;&#x91CF;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;&#x53D8;&#x91CF;&#x7684;&#x6839;&#x3002;&#x5148;&#x770B;&#x770B;&#x52A8;&#x6001;&#x7ED1;&#x5B9A;&#x3002;</p>
<blockquote>
<p>Dynamic Binding</p>
</blockquote>
<h3 id="&#x52A8;&#x6001;&#x7ED1;&#x5B9A;"><a href="#&#x52A8;&#x6001;&#x7ED1;&#x5B9A;" class="headerlink" title="&#x52A8;&#x6001;&#x7ED1;&#x5B9A;"></a>&#x52A8;&#x6001;&#x7ED1;&#x5B9A;</h3><blockquote>
<p>When I first introduced <code>def</code>, I implored you to treat it as if it&#x2019;s defining a constant. It turns out that vars are a bit more flexible than that: you can create a dynamic var whose binding can be changed. Dynamic vars can be useful for creating a global name that should refer to different values in different contexts.</p>
</blockquote>
<p>&#x7B2C;&#x4E00;&#x6B21;&#x4ECB;&#x7ECD;<code>def</code>,&#x6211;&#x8BF7;&#x6C42;&#x4F60;&#x5C31;&#x5F53;&#x5B83;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x5E38;&#x4EAE;&#x3002;&#x5B9E;&#x9645;&#x4E0A;&#x53D8;&#x91CF;&#x66F4;&#x7075;&#x6D3B;&#xFF1A;&#x4F60;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x80FD;&#x6539;&#x53D8;&#x7ED1;&#x5B9A;&#x7684;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x3002;&#x9700;&#x8981;&#x4E0D;&#x540C;&#x60C5;&#x51B5;&#x6307;&#x5411;&#x4E0D;&#x540C;&#x503C;&#x7684;&#x5168;&#x5C40;&#x540D;&#x5B57;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x3002;</p>
<blockquote>
<p>Creating and Binding Dynamic Vars</p>
</blockquote>
<h4 id="&#x521B;&#x5EFA;&#x548C;&#x7ED1;&#x5B9A;&#x52A8;&#x6001;&#x53D8;&#x91CF;"><a href="#&#x521B;&#x5EFA;&#x548C;&#x7ED1;&#x5B9A;&#x52A8;&#x6001;&#x53D8;&#x91CF;" class="headerlink" title="&#x521B;&#x5EFA;&#x548C;&#x7ED1;&#x5B9A;&#x52A8;&#x6001;&#x53D8;&#x91CF;"></a>&#x521B;&#x5EFA;&#x548C;&#x7ED1;&#x5B9A;&#x52A8;&#x6001;&#x53D8;&#x91CF;</h4><blockquote>
<p>First, create a dynamic var:</p>
</blockquote>
<p>&#x9996;&#x5148;&#x521B;&#x5EFA;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> ^<span class="symbol">:dynamic</span> *notification-address* <span class="string">&quot;dobby@elf.org&quot;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notice two important details here. First, you use <code>^:dynamic</code> to signal to Clojure that a var is dynamic. Second, the var&#x2019;s name is enclosed by asterisks. Lispers call these <em>earmuffs</em>, which is adorable. Clojure requires you to enclose the names of dynamic vars in earmuffs. This helps signal the var&#x2019;s <em>dynamicaltude</em> to other programmers.</p>
</blockquote>
<p>&#x6CE8;&#x610F;&#x4E24;&#x4E2A;&#x8981;&#x70B9;&#x3002;&#x9996;&#x5148;&#xFF0C;&#x7528;<code>^:dynamic</code>&#x544A;&#x8BC9;Clojure&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x662F;&#x52A8;&#x6001;&#x7684;&#x3002;&#x7136;&#x540E;&#xFF0C;&#x53D8;&#x91CF;&#x540D;&#x7528;&#x661F;&#x53F7;&#x5305;&#x56F4;&#x3002;Lisp&#x7A0B;&#x5E8F;&#x5458;&#x7BA1;&#x8FD9;&#x4E2A;&#x53EB;<em>&#x8033;&#x5957;</em>&#xFF0C;Clojure&#x8981;&#x6C42;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x540D;&#x5B57;&#x5305;&#x542B;&#x5728;&#x8033;&#x5957;&#x91CC;&#x3002;&#x8FD9;&#x6709;&#x52A9;&#x4E8E;&#x544A;&#x8BC9;&#x5176;&#x4ED6;&#x7A0B;&#x5E8F;&#x5458;&#xFF0C;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x662F;&#x52A8;&#x6001;&#x7684;&#x3002;</p>
<blockquote>
<p>Unlike regular vars, you can temporarily change the value of dynamic vars by using <code>binding</code>:</p>
</blockquote>
<p>&#x4E0E;&#x666E;&#x901A;&#x53D8;&#x91CF;&#x4E0D;&#x540C;&#xFF0C;&#x7528;<code>binding</code>&#x53EF;&#x4EE5;&#x4E34;&#x65F6;&#x6539;&#x53D8;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x7684;&#x503C;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">binding</span> [*notification-address* <span class="string">&quot;test@elf.org&quot;</span>]</span><br><span class="line">  *notification-address*)</span><br><span class="line"><span class="comment">; =&gt; &quot;test@elf.org&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>You can also stack bindings ( just like you can with <code>let</code>):</p>
</blockquote>
<p>&#x4E5F;&#x53EF;&#x4EE5;&#x5D4C;&#x5957;&#x7ED1;&#x5B9A;(&#x50CF;<code>let</code>&#x4E00;&#x6837;):</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">binding</span> [*notification-address* <span class="string">&quot;tester-1@elf.org&quot;</span>]</span><br><span class="line">  (<span class="name">println</span> *notification-address*)</span><br><span class="line">  (<span class="name">binding</span> [*notification-address* <span class="string">&quot;tester-2@elf.org&quot;</span>]</span><br><span class="line">    (<span class="name">println</span> *notification-address*))</span><br><span class="line">  (<span class="name">println</span> *notification-address*))</span><br><span class="line"><span class="comment">; =&gt; tester-1@elf.org</span></span><br><span class="line"><span class="comment">; =&gt; tester-2@elf.org</span></span><br><span class="line"><span class="comment">; =&gt; tester-1@elf.org</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Now that you know how to dynamically bind a var, let&#x2019;s look at a real-world application.</p>
</blockquote>
<p>&#x77E5;&#x9053;&#x4E86;&#x5982;&#x4F55;&#x52A8;&#x6001;&#x7ED1;&#x5B9A;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#xFF0C;&#x6765;&#x770B;&#x4E00;&#x4E2A;&#x771F;&#x5B9E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<blockquote>
<p>Dynamic Var Uses</p>
</blockquote>
<h4 id="&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x4F7F;&#x7528;"><a href="#&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x4F7F;&#x7528;" class="headerlink" title="&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x4F7F;&#x7528;"></a>&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x4F7F;&#x7528;</h4><blockquote>
<p>Let&#x2019;s say you have a function that sends a notification email. In this example, we&#x2019;ll just return a string but pretend that the function actually sends the email:</p>
</blockquote>
<p>&#x5047;&#x8BBE;&#x6709;&#x4E2A;&#x53D1;&#x9001;&#x901A;&#x77E5;&#x90AE;&#x4EF6;&#x7684;&#x51FD;&#x6570;&#x3002;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x53EA;&#x8FD4;&#x56DE;&#x4E86;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x8868;&#x793A;&#x53D1;&#x9001;&#x4E86;&#x90AE;&#x4EF6;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> notify</span><br><span class="line">  [message]</span><br><span class="line">  (<span class="name"><span class="builtin-name">str</span></span> <span class="string">&quot;TO: &quot;</span> *notification-address* <span class="string">&quot;\n&quot;</span></span><br><span class="line">       <span class="string">&quot;MESSAGE: &quot;</span> message))</span><br><span class="line">(<span class="name">notify</span> <span class="string">&quot;I fell.&quot;</span>)</span><br><span class="line"><span class="comment">; =&gt; &quot;TO: dobby@elf.org\nMESSAGE: I fell.&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>What if you want to test this function without spamming Dobby every time your specs run? Here comes <code>binding</code> to the rescue:</p>
</blockquote>
<p>&#x5982;&#x679C;&#x4E0D;&#x60F3;&#x6BCF;&#x6B21;&#x6D4B;&#x8BD5;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x65F6;&#x5019;&#x90FD;&#x53D1;&#x90AE;&#x4EF6;&#x7ED9;Dobby&#xFF0C;&#x8BE5;&#x600E;&#x4E48;&#x529E;&#x5462;&#xFF1F;&#x8FD9;&#x65F6;&#x5019;<code>binding</code>&#x5C31;&#x6709;&#x7528;&#x4E86;:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">binding</span> [*notification-address* <span class="string">&quot;test@elf.org&quot;</span>]</span><br><span class="line">  (<span class="name">notify</span> <span class="string">&quot;test!&quot;</span>))</span><br><span class="line"><span class="comment">; =&gt; &quot;TO: test@elf.org\nMESSAGE: test!&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Of course, you could have just defined <code>notify</code> to take an email address as an argument. In fact, that&#x2019;s often the right choice. Why would you want to use dynamic vars instead?</p>
</blockquote>
<p>&#x5F53;&#x7136;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;<code>notify</code>,&#x8BA9;&#x5B83;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x90AE;&#x4EF6;&#x5730;&#x5740;&#x53C2;&#x6570;&#x3002;&#x5B9E;&#x9645;&#x4E0A;&#x8FD9;&#x7ECF;&#x5E38;&#x662F;&#x6B63;&#x786E;&#x7684;&#x9009;&#x62E9;&#x3002;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x5230;&#x5E95;&#x4E3A;&#x4EC0;&#x4E48;&#x4F7F;&#x7528;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x5462;&#xFF1F;</p>
<blockquote>
<p>Dynamic vars are most often used to name a resource that one or more functions target. In this example, you can view the email address as a resource that you write to. In fact, Clojure comes with a ton of built-in dynamic vars for this purpose. <code>*out*</code>, for example, represents the standard output for print operations. In your program, you could re-bind <code>*out*</code> so that print statements write to a file, like so:</p>
</blockquote>
<p>&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x6700;&#x7ECF;&#x5E38;&#x7684;&#x7528;&#x5904;&#x662F;&#xFF1A;&#x547D;&#x540D;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x76EE;&#x6807;&#x8D44;&#x6E90;&#x3002;&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x628A;&#x90AE;&#x4EF6;&#x5730;&#x5740;&#x770B;&#x6210;&#x5199;&#x5165;&#x7684;&#x8D44;&#x6E90;&#x3002;&#x4E8B;&#x5B9E;&#x4E0A;&#xFF0C;Clojure&#x6709;&#x5927;&#x91CF;&#x7528;&#x4E8E;&#x8FD9;&#x4E2A;&#x76EE;&#x7684;&#x7684;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x3002;&#x6BD4;&#x5982;<code>*out*</code>&#x8868;&#x793A;&#x6253;&#x5370;&#x64CD;&#x4F5C;&#x7684;&#x6807;&#x51C6;&#x8F93;&#x51FA;&#x3002;&#x4F60;&#x53EF;&#x4EE5;&#x91CD;&#x65B0;&#x7ED1;&#x5B9A;<code>*out*</code>&#xFF0C;&#x8BA9;&#x6253;&#x5370;&#x76EE;&#x6807;&#x53D8;&#x6210;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C;&#x50CF;&#x8FD9;&#x6837;:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(binding [*out* (clojure.java.io/writer &quot;print-output&quot;)]</span><br><span class="line">  (println &quot;A man who carries a cat by the tail learns</span><br><span class="line">something he can learn in no other way.</span><br><span class="line">-- Mark Twain&quot;))</span><br><span class="line">(slurp &quot;print-output&quot;)</span><br><span class="line">; =&gt; A man who carries a cat by the tail learns</span><br><span class="line">     something he can learn in no other way.</span><br><span class="line">     -- Mark Twain</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This is much less burdensome than passing an output destination to every invocation of <code>println</code>. Dynamic vars are a great way to specify a common resource while retaining the flexibility to change it on an ad hoc basis.</p>
</blockquote>
<p>&#x8FD9;&#x6BD4;&#x6BCF;&#x6B21;&#x8C03;&#x7528;<code>println</code>&#x65F6;&#x5019;&#x90FD;&#x4F20;&#x7ED9;&#x5B83;&#x8F93;&#x51FA;&#x76EE;&#x7701;&#x4E8B;&#x591A;&#x4E86;&#x3002;&#x60F3;&#x8981;&#x6307;&#x5B9A;&#x901A;&#x7528;&#x8D44;&#x6E90;&#xFF0C;&#x53C8;&#x80FD;&#x5728;&#x7279;&#x5B9A;&#x60C5;&#x51B5;&#x6539;&#x53D8;&#x8FD9;&#x4E2A;&#x8D44;&#x6E90;&#xFF0C;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x662F;&#x4E2A;&#x5F88;&#x68D2;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<blockquote>
<p>Dynamic vars are also used for configuration. For example, the built-in var <code>*print-length*</code> allows you to specify how many items in a collection Clojure should print:</p>
</blockquote>
<p>&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x4E5F;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;&#x914D;&#x7F6E;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x52A8;&#x6001;&#x53D8;&#x91CF;<code>*print-length*</code>&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x6253;&#x5370;&#x591A;&#x5C11;&#x96C6;&#x5408;&#x91CC;&#x7684;&#x6210;&#x5458;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">println</span> [<span class="string">&quot;Print&quot;</span> <span class="string">&quot;all&quot;</span> <span class="string">&quot;the&quot;</span> <span class="string">&quot;things!&quot;</span>])</span><br><span class="line"><span class="comment">; =&gt; [Print all the things!]</span></span><br><span class="line"></span><br><span class="line">(<span class="name">binding</span> [*print-length* <span class="number">1</span>]</span><br><span class="line">  (<span class="name">println</span> [<span class="string">&quot;Print&quot;</span> <span class="string">&quot;just&quot;</span> <span class="string">&quot;one!&quot;</span>]))</span><br><span class="line"><span class="comment">; =&gt; [Print ...]</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Finally, it&#x2019;s possible to <code>set!</code> dynamic vars that have been bound. Whereas the examples you&#x2019;ve seen so far allow you to convey information in to a function without having to pass in the information as an argument, <code>set!</code> allows you convey information out of a function without having to return it as an argument.</p>
</blockquote>
<p>&#x6700;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;<code>set!</code>&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x5DF2;&#x7ECF;&#x7ED1;&#x5B9A;&#x7684;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x3002;&#x5C31;&#x50CF;&#x4E0A;&#x9762;&#x770B;&#x5230;&#x7684;&#x4F8B;&#x5B50;&#x8BA9;&#x4F60;&#x65E0;&#x9700;&#x7ED9;&#x51FD;&#x6570;&#x4F20;&#x53C2;&#xFF0C;&#x5C31;&#x80FD;&#x628A;&#x4FE1;&#x606F;&#x4F20;&#x8FDB;&#x51FD;&#x6570;&#xFF0C;<code>set!</code>&#x4F7F;&#x51FD;&#x6570;&#x65E0;&#x9700;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#xFF0C;&#x5C31;&#x80FD;&#x628A;&#x4FE1;&#x606F;&#x4F20;&#x5230;&#x51FD;&#x6570;&#x5916;&#x9762;&#x3002;</p>
<blockquote>
<p>For example, let&#x2019;s say you&#x2019;re a telepath, but your mind-reading powers are a bit delayed. You can read people&#x2019;s thoughts only after the moment when it would have been useful for you to know them. Don&#x2019;t feel too bad, though; you&#x2019;re still a telepath, which is awesome. Anyway, say you&#x2019;re trying to cross a bridge guarded by a troll who will eat you if you don&#x2019;t answer his riddle. His riddle is &#x201C;What number between 1 and 2 am I thinking of?&#x201D; In the event that the troll devours you, you can at least die knowing what the troll was actually thinking.</p>
</blockquote>
<p>&#x4F8B;&#x5982;&#xFF0C;&#x5047;&#x8BBE;&#x4F60;&#x662F;&#x4E2A;&#x5FC3;&#x7075;&#x611F;&#x5E94;&#x8005;&#xFF0C;&#x4F46;&#x4F60;&#x7684;&#x8BFB;&#x5FC3;&#x672F;&#x6709;&#x70B9;&#x6162;&#x3002;&#x4F60;&#x53EA;&#x80FD;&#x5728;&#x67D0;&#x4E00;&#x65F6;&#x523B;&#x8BFB;&#x5230;&#x5BF9;&#x65B9;&#x7684;&#x60F3;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x523B;&#x5C31;&#x662F;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x60F3;&#x6CD5;&#x65F6;&#x5BF9;&#x4F60;&#x5DF2;&#x7ECF;&#x6CA1;&#x7528;&#x4E86;&#x3002;&#x4E0D;&#x8981;&#x89C9;&#x5F97;&#x592A;&#x7CDF;&#x7CD5;&#xFF0C;&#x4F60;&#x4ECD;&#x7136;&#x662F;&#x5FC3;&#x7075;&#x611F;&#x5E94;&#x8005;&#xFF0C;&#x8FD9;&#x5F88;&#x4E86;&#x4E0D;&#x8D77;&#x3002;&#x6BD4;&#x5982;&#x8BF4;&#x4F60;&#x6B63;&#x8981;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x98DF;&#x4EBA;&#x9B54;&#x628A;&#x5B88;&#x7684;&#x6865;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x6CA1;&#x6709;&#x89E3;&#x5F00;&#x98DF;&#x4EBA;&#x9B54;&#x7684;&#x8FF7;&#x9898;&#xFF0C;&#x5B83;&#x5C31;&#x4F1A;&#x5403;&#x4E86;&#x4F60;&#x3002;&#x5B83;&#x7684;&#x8C1C;&#x9898;&#x662F;&#x201D;&#x6211;&#x73B0;&#x5728;&#x60F3;&#x7684;&#x6570;&#x5B57;&#x662F;1&#x8FD8;&#x662F;2&#xFF1F;&#x201D;&#x3002;&#x5F53;&#x98DF;&#x4EBA;&#x9B54;&#x5403;&#x4F60;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F60;&#x81F3;&#x5C11;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x5B83;&#x5B9E;&#x9645;&#x60F3;&#x7684;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</p>
<p><img src="/2016/07/22/clojure-metaphysics/troll.png" alt="troll"></p>
<blockquote>
<p>In this example, you create the dynamic var <code>*troll-thought*</code> to convey the troll&#x2019;s thought out of the <code>troll-riddle</code> function:</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x5728;&#x51FD;&#x6570;<code>troll-riddle</code>&#x5916;&#x9762;&#x521B;&#x5EFA;&#x52A8;&#x6001;&#x53D8;&#x91CF;<code>*troll-thought*</code>&#xFF0C;&#x4F20;&#x8FBE;&#x98DF;&#x4EBA;&#x9B54;&#x7684;&#x60F3;&#x6CD5;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> ^<span class="symbol">:dynamic</span> *troll-thought* <span class="literal">nil</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> troll-riddle</span><br><span class="line">  [your-answer]</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> [number <span class="string">&quot;man meat&quot;</span>]</span><br><span class="line">&#x278A;     (<span class="name"><span class="builtin-name">when</span></span> (<span class="name">thread-bound?</span> #&apos;*troll-thought*)</span><br><span class="line">&#x278B;       (<span class="name"><span class="builtin-name">set!</span></span> *troll-thought* number))</span><br><span class="line">    (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> number your-answer)</span><br><span class="line">      <span class="string">&quot;TROLL: You can cross the bridge!&quot;</span></span><br><span class="line">      <span class="string">&quot;TROLL: Time to eat you, succulent human!&quot;</span>)))</span><br><span class="line"></span><br><span class="line">(<span class="name">binding</span> [*troll-thought* <span class="literal">nil</span>]</span><br><span class="line">  (<span class="name">println</span> (<span class="name">troll-riddle</span> <span class="number">2</span>))</span><br><span class="line">  (<span class="name">println</span> <span class="string">&quot;SUCCULENT HUMAN: Oooooh! The answer was&quot;</span> *troll-thought*))</span><br><span class="line"></span><br><span class="line"><span class="comment">; =&gt; TROLL: Time to eat you, succulent human!</span></span><br><span class="line"><span class="comment">; =&gt; SUCCULENT HUMAN: Oooooh! The answer was man meat</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>You use the <code>thread-bound?</code> function at &#x278A; to check that the var has been bound, and if it has, you <code>set! *troll-thought*</code> to the troll&#x2019;s thought at &#x278B;.</p>
</blockquote>
<p>&#x278A;&#x5904;&#x4F7F;&#x7528;<code>thread-bound</code>&#x51FD;&#x6570;&#xFF0C;&#x68C0;&#x67E5;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x7ED1;&#x5B9A;&#xFF0C;&#x5982;&#x679C;&#x662F;&#xFF0C;&#x5728;&#x278B;&#x5904;&#x8BBE;&#x7F6E;&#x5DE8;&#x9B54;&#x7684;&#x60F3;&#x6CD5;<code>set! *troll-thought*</code>&#x3002;</p>
<blockquote>
<p>The var returns to its original value outside of binding:</p>
</blockquote>
<p>&#x7ED1;&#x5B9A;&#x5916;&#x9762;&#xFF0C;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x8FD4;&#x56DE;&#x5B83;&#x7684;&#x521D;&#x59CB;&#x503C;:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*troll-thought*</span><br><span class="line">; =&gt; nil</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notice that you have to pass <code>#&apos;*troll-thought*</code> (including <code>#&apos;</code>), not <code>*troll-thought*</code>, to the function <code>thread-bound?</code>. This is because <code>thread-bound?</code> takes the var itself as an argument, not the value it refers to.</p>
</blockquote>
<p>&#x6CE8;&#x610F;&#xFF0C;&#x4F20;&#x7ED9;&#x51FD;&#x6570;<code>thread-bound?</code>&#x7684;&#x5FC5;&#x987B;&#x662F;<code>#&apos;*troll-thought*</code>(&#x5305;&#x542B;<code>#&apos;</code>),&#x800C;&#x4E0D;&#x80FD;&#x662F;<code>*troll-thought*</code>&#x3002;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;<code>thread-bound?</code>&#x63A5;&#x53D7;&#x7684;&#x53C2;&#x6570;&#x662F;&#x53D8;&#x91CF;&#x672C;&#x8EAB;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x5B83;&#x5F15;&#x7528;&#x7684;&#x503C;&#x3002;</p>
<p>[&#x8BD1;&#x8005;&#x6CE8;]<br><code>#&apos;*troll-thought*</code> &#x7B49;&#x4E8E;<code>(var *troll-thought*)</code>,&#x800C;&#x540E;&#x8005;&#x5C31;&#x662F;&#x83B7;&#x53D6;&#x8FD9;&#x4E2A;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x5BF9;&#x8C61;&#x672C;&#x8EAB;,<a href="http://clojuredocs.org/clojure.core/var" target="_blank" rel="external">&#x53C2;&#x8003;&#x8FD9;&#x91CC;</a>&#x3002;&#x524D;&#x8005;&#x662F;&#x8BFB;&#x5165;&#x7A0B;&#x5E8F;&#x5B8F;&#x7684;&#x4E00;&#x79CD;&#x5F62;&#x5F0F;&#xFF0C;&#x53EF;&#x53C2;&#x8003;&#x7B2C;&#x516D;&#x7AE0;,Clojure&#x70BC;&#x91D1;&#x672F;:&#x8BFB;&#x53D6;&#xFF0C;&#x6C42;&#x503C;&#xFF0C;&#x5B8F;&#x7684;<a href="https://morrxy.github.io/2016/05/11/braveclojure-read-and-eval/#&#x8BFB;&#x5165;&#x7A0B;&#x5E8F;&#x5B8F;" target="_blank" rel="external">&#x76F8;&#x5E94;&#x90E8;&#x5206;</a></p>
<blockquote>
<p>Per-Thread Binding</p>
</blockquote>
<h4 id="&#x6BCF;&#x7EBF;&#x7A0B;&#x7ED1;&#x5B9A;"><a href="#&#x6BCF;&#x7EBF;&#x7A0B;&#x7ED1;&#x5B9A;" class="headerlink" title="&#x6BCF;&#x7EBF;&#x7A0B;&#x7ED1;&#x5B9A;"></a>&#x6BCF;&#x7EBF;&#x7A0B;&#x7ED1;&#x5B9A;</h4><blockquote>
<p>One final point to note about binding: if you access a dynamically bound var from within a manually created thread, the var will evaluate to the original value. If you&#x2019;re new to Clojure (and Java), this feature won&#x2019;t be immediately relevant; you can probably skip this section and come back to it later.</p>
</blockquote>
<p>&#x5173;&#x4E8E;&#x7ED1;&#x5B9A;&#xFF0C;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF1A;&#x5982;&#x679C;&#x4F60;&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x5E76;&#x4ECE;&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;&#x91CC;&#x8BBF;&#x95EE;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x7ED1;&#x5B9A;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x4F1A;&#x6C42;&#x503C;&#x4E3A;&#x5B83;&#x7684;&#x6700;&#x521D;&#x503C;&#x3002;&#x5982;&#x679C;&#x4F60;&#x521A;&#x63A5;&#x89E6;Clojure(&#x548C;Java)&#xFF0C;&#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x4E0D;&#x4F1A;&#x9A6C;&#x4E0A;&#x5BF9;&#x4F60;&#x4EA7;&#x751F;&#x610F;&#x4E49;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x8DF3;&#x8FC7;&#x8FD9;&#x8282;&#xFF0C;&#x4EE5;&#x540E;&#x518D;&#x770B;&#x3002;</p>
<blockquote>
<p>Ironically, this binding behavior prevents us from easily creating a fun demonstration in the REPL, because the REPL binds <code>*out*</code>. It&#x2019;s as if all the code you run in the REPL is implicitly wrapped in something like <code>(binding [*out* repl-printer] your-code</code>. If you create a new thread, <code>*out*</code> won&#x2019;t be bound to the REPL printer.</p>
</blockquote>
<p>&#x8BBD;&#x523A;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x4E2A;&#x7ED1;&#x5B9A;&#x884C;&#x4E3A;&#x4F7F;&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x5728;REPL&#x91CC;&#x521B;&#x9020;&#x4E00;&#x4E2A;&#x597D;&#x73A9;&#x7684;&#x6F14;&#x793A;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;REPL&#x7ED1;&#x5B9A;&#x4E86;<code>*out*</code>&#x3002;&#x5C31;&#x597D;&#x50CF;&#x6240;&#x6709;&#x8FD0;&#x884C;&#x5728;REPL&#x91CC;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x90FD;&#x9690;&#x542B;&#x5730;&#x88AB;&#x5305;&#x5728;&#x8FD9;&#x6837;&#x7684;&#x4E1C;&#x897F;&#x91CC;&#xFF0C;<code>(binding [*out* repl-printer] your-code)</code>&#x3002;&#x5982;&#x679C;&#x4F60;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;<code>*out*</code>&#x5C06;&#x4E0D;&#x88AB;&#x7ED1;&#x5B9A;&#x5230;&#x65B0;&#x7EBF;&#x7A0B;&#x7684;REPL&#x6253;&#x5370;&#x673A;&#x3002;</p>
<blockquote>
<p>The following example uses some basic Java interop. Even if it looks unfamiliar, the gist of the following code should be clear, and you&#x2019;ll learn exactly what&#x2019;s going on in Chapter 12.</p>
</blockquote>
<p>&#x4E0B;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x4E9B;&#x57FA;&#x672C;&#x7684;Java&#x4E92;&#x64CD;&#x4F5C;&#x3002;&#x867D;&#x7136;&#x770B;&#x8D77;&#x6765;&#x4E0D;&#x592A;&#x719F;&#x6089;&#xFF0C;&#x4F46;&#x5927;&#x610F;&#x5E94;&#x8BE5;&#x662F;&#x6E05;&#x695A;&#x7684;&#xFF0C;&#x5728;12&#x7AE0;&#x5C06;&#x4F1A;&#x4E86;&#x89E3;&#x5177;&#x4F53;&#x90FD;&#x662F;&#x4EC0;&#x4E48;&#x3002;</p>
<blockquote>
<p>This code prints output to the REPL:</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x5411;REPL&#x6253;&#x5370;&#x8F93;&#x51FA;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">.write</span> *out* <span class="string">&quot;prints to repl&quot;</span>)</span><br><span class="line"><span class="comment">; =&gt; prints to repl</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>The following code doesn&#x2019;t print output to the REPL, because <code>*out*</code> is not bound to the REPL printer:</p>
</blockquote>
<p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4E0D;&#x4F1A;&#x5411;REPL&#x6253;&#x5370;&#x8F93;&#x51FA;&#xFF0C;&#x56E0;&#x4E3A;<code>*out*</code>&#x6CA1;&#x7ED1;&#x5B9A;&#x5230;REPL&#x6253;&#x5370;&#x673A;:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">.start</span> (<span class="name">Thread.</span> #(<span class="name">.write</span> *out* <span class="string">&quot;prints to standard out&quot;</span>)))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>You can work around this by using this goofy code:</p>
</blockquote>
<p>&#x4F7F;&#x7528;&#x8FD9;&#x6BB5;&#x602A;&#x5F02;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x53EF;&#x4EE5;&#x907F;&#x5F00;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [out *out*]</span><br><span class="line">  (<span class="name">.start</span></span><br><span class="line">   (<span class="name">Thread.</span> #(<span class="name">binding</span> [*out* out]</span><br><span class="line">               (<span class="name">.write</span> *out* <span class="string">&quot;prints to repl from thread&quot;</span>)))))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Or you can use <code>bound-fn</code>, which carries all the current bindings to the new thread:</p>
</blockquote>
<p>&#x4F7F;&#x7528;<code>bound-fn</code>&#x4E5F;&#x53EF;&#x4EE5;&#xFF0C;&#x5B83;&#x628A;&#x5F53;&#x524D;&#x6240;&#x6709;&#x7ED1;&#x5B9A;&#x90FD;&#x4F20;&#x9012;&#x7ED9;&#x65B0;&#x7EBF;&#x7A0B;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">.start</span> (<span class="name">Thread.</span> (<span class="name">bound-fn</span> [] (<span class="name">.write</span> *out* <span class="string">&quot;prints to repl from thread&quot;</span>))))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The <code>let</code> binding captures <code>*out*</code> so we can then rebind it in the child thread, which is goofy as hell. The point is that bindings don&#x2019;t get passed on to manually created threads. They do, however, get passed on to futures. This is called binding conveyance. Throughout this chapter, we&#x2019;ve been printing from futures without any problem, for example.</p>
</blockquote>
<p>&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x7684;<code>let</code>&#x7ED1;&#x5B9A;&#x91CC;&#x6355;&#x83B7;&#x4E86;<code>*out*</code>&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x5728;&#x5B50;&#x7EBF;&#x7A0B;&#x91CC;&#x91CD;&#x65B0;&#x7ED1;&#x5B9A;&#x5B83;&#xFF0C;&#x975E;&#x5E38;&#x602A;&#x5F02;&#x3002;&#x91CD;&#x70B9;&#x662F;&#x7ED1;&#x5B9A;&#x4E0D;&#x4F1A;&#x4F20;&#x9012;&#x7ED9;&#x624B;&#x52A8;&#x521B;&#x5EFA;&#x7684;&#x7EBF;&#x7A0B;&#x3002;&#x4F46;&#x786E;&#x5B9E;&#x80FD;&#x4F20;&#x9012;&#x7ED9;&#x672A;&#x6765;&#x3002;&#x8FD9;&#x53EB;&#x7ED1;&#x5B9A;&#x8F93;&#x9001;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x8FD9;&#x7AE0;&#x91CC;&#x6211;&#x4EEC;&#x4E00;&#x76F4;&#x5728;&#x672A;&#x6765;&#x91CC;&#x6253;&#x5370;&#xFF0C;&#x800C;&#x6CA1;&#x53D1;&#x751F;&#x4EFB;&#x4F55;&#x95EE;&#x9898;&#x3002;</p>
<blockquote>
<p>That&#x2019;s it for dynamic binding. Let&#x2019;s turn our attention to the last var topic: altering var <em>roots</em>.</p>
</blockquote>
<p>&#x52A8;&#x6001;&#x7ED1;&#x5B9A;&#x5C31;&#x8BA8;&#x8BBA;&#x8FD9;&#x4E9B;&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x628A;&#x6CE8;&#x610F;&#x8F6C;&#x5230;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x4E3B;&#x9898;&#xFF1A;&#x4FEE;&#x6539;<em>&#x6839;</em>&#x53D8;&#x91CF;&#x3002;</p>
<blockquote>
<p>Altering the Var Root</p>
</blockquote>
<h3 id="&#x4FEE;&#x6539;&#x6839;&#x53D8;&#x91CF;"><a href="#&#x4FEE;&#x6539;&#x6839;&#x53D8;&#x91CF;" class="headerlink" title="&#x4FEE;&#x6539;&#x6839;&#x53D8;&#x91CF;"></a>&#x4FEE;&#x6539;&#x6839;&#x53D8;&#x91CF;</h3><blockquote>
<p>When you create a new var, the initial value that you supply is its <em>root</em>:</p>
</blockquote>
<p>&#x521B;&#x5EFA;&#x65B0;&#x53D8;&#x91CF;&#x65F6;&#xFF0C;&#x4F60;&#x63D0;&#x4F9B;&#x7684;&#x521D;&#x59CB;&#x503C;&#x662F;&#x8FD9;&#x4E2A;&#x53D8;&#x91CF;&#x7684;<em>&#x6839;</em>&#x503C;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> power-source <span class="string">&quot;hair&quot;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In this example, <code>&quot;hair&quot;</code> is the root value of <code>power-source</code>. Clojure lets you permanently change this root value with the function <code>alter-var-root</code>:</p>
</blockquote>
<p>&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;<code>&quot;hair&quot;</code>&#x662F;<code>power-source</code>&#x7684;&#x6839;&#x503C;&#x3002;Clojure&#x5141;&#x8BB8;&#x4F60;&#x7528;<code>alter-var-root</code>&#x6C38;&#x4E45;&#x6539;&#x53D8;&#x8FD9;&#x4E2A;&#x6839;&#x503C;:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(alter-var-root #&apos;power-source (fn [_] &quot;7-eleven parking lot&quot;))</span><br><span class="line">power-source</span><br><span class="line">; =&gt; &quot;7-eleven parking lot&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Just like when using <code>swap!</code> to update an atom or <code>alter!</code> to update a ref, you use <code>alter-var-root</code> along with a function to update the state of a var. In this case, the function is just returning a new string that bears no relation to the previous value, unlike the <code>alter!</code> examples where we used <code>inc</code> to derive a new number from the current number.</p>
</blockquote>
<p>&#x5C31;&#x50CF;&#x7528;<code>swap!</code>&#x66F4;&#x65B0;&#x539F;&#x5B50;&#xFF0C;&#x6216;&#x7528;<code>alter!</code>&#x66F4;&#x65B0;&#x5F15;&#x7528;&#xFF0C;&#x4F7F;&#x7528;<code>alter-var-root</code>&#x52A0;&#x4E0A;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x66F4;&#x65B0;&#x53D8;&#x91CF;&#x7684;&#x72B6;&#x6001;&#x3002;&#x524D;&#x9762;&#x7684;<code>alter!</code>&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x6211;&#x4EEC;&#x7528;<code>inc</code>&#x4ECE;&#x5F53;&#x524D;&#x6570;&#x5F97;&#x51FA;&#x4E00;&#x4E2A;&#x65B0;&#x6570;&#xFF0C;&#x4E0E;&#x6B64;&#x4E0D;&#x540C;&#x7684;&#x662F;&#xFF0C;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E0E;&#x4E4B;&#x524D;&#x7684;&#x503C;&#x6CA1;&#x6709;&#x5173;&#x7CFB;&#xFF0C;&#x53EA;&#x662F;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x65B0;&#x5B57;&#x7B26;&#x4E32;&#x3002;</p>
<blockquote>
<p>You&#x2019;ll hardly ever want to do this. You especially don&#x2019;t want to do this to perform simple variable assignment. If you did, you&#x2019;d be going out of your way to create the binding as a mutable variable, which goes against Clojure&#x2019;s philosophy; it&#x2019;s best to use the functional programming techniques you learned in Chapter 5.</p>
</blockquote>
<p>&#x4F60;&#x51E0;&#x4E4E;&#x4E0D;&#x4F1A;&#x8FD9;&#x4E48;&#x505A;&#x3002;&#x5BF9;&#x4E8E;&#x7B80;&#x5355;&#x7684;&#x53D8;&#x91CF;&#x8D4B;&#x503C;&#xFF0C;&#x4F60;&#x66F4;&#x4E0D;&#x60F3;&#x8FD9;&#x4E48;&#x505A;&#x3002;&#x8FD9;&#x4E48;&#x505A;&#x662F;&#x628A;&#x7ED1;&#x5B9A;&#x5F53;&#x6210;&#x53EF;&#x53D8;&#x53D8;&#x91CF;&#xFF0C;&#x8FD9;&#x4E0E;Clojure&#x539F;&#x5219;&#x76F8;&#x80CC;&#xFF0C;&#x6700;&#x597D;&#x7684;&#x65B9;&#x5F0F;&#x662F;&#x7528;&#x7B2C;5&#x7AE0;&#x5B66;&#x5230;&#x7684;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#x6280;&#x5DE7;&#x3002;</p>
<blockquote>
<p>You can also temporarily alter a var&#x2019;s root with <code>with-redefs</code>. This works similarly to <code>binding</code> except the alteration will appear in child threads. Here&#x2019;s an example:</p>
</blockquote>
<p>&#x4E5F;&#x53EF;&#x4EE5;&#x7528;<code>with-redefs</code>&#x4E34;&#x65F6;&#x66F4;&#x6539;&#x4E00;&#x4E2A;&#x53D8;&#x91CF;&#x7684;&#x6839;&#x503C;&#x3002;&#x8FD9;&#x4E0E;<code>binding</code>&#x7C7B;&#x4F3C;&#xFF0C;&#x9664;&#x4E86;&#x66F4;&#x6539;&#x5C06;&#x51FA;&#x73B0;&#x5728;&#x5B50;&#x7EBF;&#x7A0B;&#x91CC;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x4F8B;&#x5B50;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">with-redefs</span> [*out* *out*]</span><br><span class="line">        (<span class="name"><span class="builtin-name">doto</span></span> (<span class="name">Thread.</span> #(<span class="name">println</span> <span class="string">&quot;with redefs allows me to show up in the REPL&quot;</span>))</span><br><span class="line">          .start</span><br><span class="line">          .join))</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>with-redefs</code> can be used with any var, not just dynamic ones. Because it has has such far-reaching effects, you should only use it during testing. For example, you could use it to redefine a function that returns data from a network call, so that the function returns mock data without having to actually make a network request.</p>
</blockquote>
<p><code>with-redefs</code>&#x53EF;&#x4EE5;&#x7528;&#x4E8E;&#x4EFB;&#x4F55;&#x53D8;&#x91CF;&#xFF0C;&#x4E0D;&#x53EA;&#x662F;&#x52A8;&#x6001;&#x53D8;&#x91CF;&#x3002;&#x56E0;&#x6B64;&#x4F60;&#x5E94;&#x8BE5;&#x628A;&#x5B83;&#x53EA;&#x7528;&#x4E8E;&#x6D4B;&#x8BD5;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x5B83;&#x91CD;&#x65B0;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x4ECE;&#x7F51;&#x7EDC;&#x8C03;&#x7528;&#x8FD4;&#x56DE;&#x6570;&#x636E;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x8BA9;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x6A21;&#x62DF;&#x6570;&#x636E;&#xFF0C;&#x800C;&#x65E0;&#x9700;&#x8FDB;&#x884C;&#x771F;&#x5B9E;&#x7684;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x3002;</p>
<blockquote>
<p>Now you know all about vars! Try not to hurt yourself or anyone you know with them.</p>
</blockquote>
<p>&#x53D8;&#x91CF;&#x7684;&#x4E00;&#x5207;&#x4F60;&#x90FD;&#x77E5;&#x9053;&#x4E86;&#xFF01;&#x4E0D;&#x8981;&#x7528;&#x5B83;&#x4F24;&#x5BB3;&#x4F60;&#x81EA;&#x5DF1;&#x6216;&#x4EFB;&#x4F55;&#x4EBA;&#x3002;</p>
<blockquote>
<p>Stateless Concurrency and Parallelism with pmap</p>
</blockquote>
<h2 id="&#x65E0;&#x72B6;&#x6001;&#x5E76;&#x53D1;&#x4E0E;&#x7528;pmap&#x5E76;&#x884C;"><a href="#&#x65E0;&#x72B6;&#x6001;&#x5E76;&#x53D1;&#x4E0E;&#x7528;pmap&#x5E76;&#x884C;" class="headerlink" title="&#x65E0;&#x72B6;&#x6001;&#x5E76;&#x53D1;&#x4E0E;&#x7528;pmap&#x5E76;&#x884C;"></a>&#x65E0;&#x72B6;&#x6001;&#x5E76;&#x53D1;&#x4E0E;&#x7528;pmap&#x5E76;&#x884C;</h2><blockquote>
<p>So far, this chapter has focused on tools that are designed to mitigate the risks inherent in concurrent programming. You&#x2019;ve learned about the dangers born of shared access to mutable state and how Clojure implements a reconceptualization of state that helps you write concurrent programs safely.</p>
</blockquote>
<p>&#x5230;&#x73B0;&#x5728;&#x4E3A;&#x6B62;&#x672C;&#x7AE0;&#x7684;&#x7126;&#x70B9;&#x90FD;&#x662F;&#xFF1A;&#x4E3A;&#x51CF;&#x5C11;&#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x5929;&#x751F;&#x5E26;&#x6709;&#x7684;&#x98CE;&#x9669;&#x800C;&#x8BBE;&#x8BA1;&#x51FA;&#x7684;&#x5DE5;&#x5177;&#x3002;&#x4F60;&#x5DF2;&#x7ECF;&#x4E86;&#x89E3;&#x4E86;&#x5171;&#x4EAB;&#x53EF;&#x53D8;&#x72B6;&#x6001;&#x8BBF;&#x95EE;&#x6743;&#x5E26;&#x6765;&#x7684;&#x5371;&#x9669;&#xFF0C;&#x4E5F;&#x4E86;&#x89E3;&#x4E86;Clojure&#x91CD;&#x65B0;&#x5B9E;&#x73B0;&#x7684;&#x72B6;&#x6001;&#x6982;&#x5FF5;&#xFF0C;&#x7528;&#x4E8E;&#x5B89;&#x5168;&#x5730;&#x5199;&#x5E76;&#x53D1;&#x7A0B;&#x5E8F;&#x3002;</p>
<blockquote>
<p>Often, though, you&#x2019;ll want to concurrent-ify tasks that are completely independent of each other. There is no shared access to a mutable state; therefore, there are no risks to running the tasks concurrently and you don&#x2019;t have to bother with using any of the tools I&#x2019;ve just been blabbing on about.</p>
</blockquote>
<p>&#x4F46;&#x4F60;&#x7ECF;&#x5E38;&#x60F3;&#x8981;&#x628A;&#x4E92;&#x76F8;&#x72EC;&#x7ACB;&#x7684;&#x4EFB;&#x52A1;&#x5E76;&#x53D1;&#x5316;&#x3002;&#x7531;&#x4E8E;&#x4E0D;&#x5B58;&#x5728;&#x5BF9;&#x53EF;&#x53D8;&#x72B6;&#x6001;&#x7684;&#x5171;&#x4EAB;&#x8BBF;&#x95EE;&#xFF0C;&#x6240;&#x4EE5;&#x5E76;&#x53D1;&#x8FD0;&#x884C;&#x8FD9;&#x4E9B;&#x4EFB;&#x52A1;&#x6CA1;&#x6709;&#x98CE;&#x9669;&#xFF0C;&#x4E0D;&#x5FC5;&#x8D39;&#x5FC3;&#x4F7F;&#x7528;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;&#x5DE5;&#x5177;&#x3002;</p>
<blockquote>
<p>As it turns out, Clojure makes it easy for you to write code for achieving stateless concurrency. In this section, you&#x2019;ll learn about <code>pmap</code>, which gives you concurrency performance benefits virtually for free.</p>
</blockquote>
<p>&#x4E8B;&#x5B9E;&#x8BC1;&#x660E;&#xFF0C;&#x7528;Clojure&#x5199;&#x65E0;&#x72B6;&#x6001;&#x5E76;&#x53D1;&#x4EE3;&#x7801;&#x5F88;&#x5BB9;&#x6613;&#x3002;&#x8FD9;&#x8282;&#x5C06;&#x4E86;&#x89E3;<code>pmap</code>,&#x5B83;&#x4E3A;&#x4F60;&#x514D;&#x8D39;&#x63D0;&#x4F9B;&#x4E86;&#x5E76;&#x53D1;&#x6027;&#x80FD;&#x6536;&#x76CA;&#x3002;</p>
<blockquote>
<p><code>map</code> is a perfect candidate for parallelization: when you use it, all you&#x2019;re doing is deriving a new collection from an existing collection by applying a function to each element of the existing collection. There&#x2019;s no need to maintain state; each function application is completely independent. Clojure makes it easy to perform a parallel map with <code>pmap</code>. With <code>pmap</code>, Clojure handles the running of each application of the mapping function on a separate thread.</p>
</blockquote>
<p>&#x5BF9;&#x4E8E;&#x5E76;&#x884C;&#x5316;&#xFF0C;<code>map</code>&#x662F;&#x4E2A;&#x5B8C;&#x7F8E;&#x7684;&#x5019;&#x9009;&#x4EBA;&#xFF1A;&#x4F7F;&#x7528;&#x5B83;&#x65F6;&#x5019;&#xFF0C;&#x5168;&#x90E8;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#x7684;&#x6BCF;&#x4E2A;&#x6210;&#x5458;&#x5E94;&#x7528;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x5F97;&#x51FA;&#x4E00;&#x4E2A;&#x65B0;&#x96C6;&#x5408;&#x3002;&#x6CA1;&#x6709;&#x7EF4;&#x62A4;&#x72B6;&#x6001;&#x7684;&#x9700;&#x8981;&#xFF0C;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x90FD;&#x662F;&#x5B8C;&#x5168;&#x72EC;&#x7ACB;&#x7684;&#x3002;&#x4F7F;&#x7528;<code>pmap</code>&#x53EF;&#x4EE5;&#x5F88;&#x5BB9;&#x6613;&#x5730;&#x8FDB;&#x884C;&#x6267;&#x884C;&#x4E00;&#x4E2A;&#x5E76;&#x884C;map&#x3002;<code>pmap</code>&#x7684;&#x6BCF;&#x4E2A;&#x6620;&#x5C04;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x90FD;&#x5728;&#x4E00;&#x4E2A;&#x72EC;&#x7ACB;&#x7EBF;&#x7A0B;&#x4E0A;&#x8FDB;&#x884C;&#x3002;</p>
<blockquote>
<p>To compare <code>map</code> and <code>pmap</code>, we need a lot of example data, and to generate this data, we&#x2019;ll use the <code>repeatedly</code> function. This function takes another function as an argument and returns a lazy sequence. The elements of the lazy sequence are generated by calling the passed function, like this:</p>
</blockquote>
<p>&#x4E3A;&#x4E86;&#x6BD4;&#x8F83;<code>map</code>&#x548C;<code>pmap</code>,&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5F88;&#x591A;&#x6837;&#x672C;&#x6570;&#x636E;&#xFF0C;&#x4F7F;&#x7528;<code>repeatedly</code>&#x51FD;&#x6570;&#x4EA7;&#x751F;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x3002;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x60F0;&#x6027;&#x5E8F;&#x5217;&#x3002;&#x8FD9;&#x4E2A;&#x60F0;&#x6027;&#x5E8F;&#x5217;&#x7684;&#x6210;&#x5458;&#x7684;&#x4EA7;&#x751F;&#x65B9;&#x6CD5;&#x662F;&#xFF1A;&#x8C03;&#x7528;&#x90A3;&#x4E2A;&#x4F20;&#x7ED9;<code>repeatedly</code>&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x50CF;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> always-1</span><br><span class="line">  []</span><br><span class="line">  <span class="number">1</span>)</span><br><span class="line">(<span class="name"><span class="builtin-name">take</span></span> <span class="number">5</span> (<span class="name">repeatedly</span> always-1))</span><br><span class="line"><span class="comment">; =&gt; (1 1 1 1 1)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Here&#x2019;s how you&#x2019;d create a lazy seq of random numbers between 0 and 9:</p>
</blockquote>
<p>&#x4E0B;&#x9762;&#x662F;&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;0&#x5230;9&#x4E4B;&#x95F4;&#x7684;&#x60F0;&#x6027;&#x5E8F;&#x5217;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">take</span></span> <span class="number">5</span> (<span class="name">repeatedly</span> (<span class="name"><span class="builtin-name">partial</span></span> rand-int <span class="number">10</span>)))</span><br><span class="line"><span class="comment">; =&gt; (1 5 0 3 4)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Let&#x2019;s use <code>repeatedly</code> to create example data that consists of a sequence of 3,000 random strings, each 7,000 characters long. We&#x2019;ll compare <code>map</code> and <code>pmap</code> by using them to run <code>clojure.string/lowercase</code> on the <code>orc-names</code> sequence created here:</p>
</blockquote>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x4F7F;&#x7528;<code>repeatedly</code>&#x521B;&#x5EFA;&#x6837;&#x672C;&#x6570;&#x636E;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x5305;&#x542B;3000&#x4E2A;&#x968F;&#x673A;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x5E8F;&#x5217;&#xFF0C;&#x6BCF;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x6709;7000&#x4E2A;&#x5B57;&#x7B26;&#x3002;&#x4F7F;&#x7528;<code>map</code>&#x548C;<code>pmap</code>&#x5728;&#x8FD9;&#x4E2A;&#x53EB;&#x505A;<code>orc-names</code>&#x7684;&#x5E8F;&#x5217;&#x4E0A;&#x8FD0;&#x884C;<code>clojure.string/lowercase</code>&#xFF0C;&#x4ECE;&#x800C;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> alphabet-length <span class="number">26</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">;; Vector of chars, A-Z</span></span><br><span class="line">(<span class="name"><span class="builtin-name">def</span></span> letters (<span class="name"><span class="builtin-name">mapv</span></span> (<span class="name"><span class="builtin-name">comp</span></span> str char (<span class="name"><span class="builtin-name">partial</span></span> + <span class="number">65</span>)) (<span class="name"><span class="builtin-name">range</span></span> alphabet-length)))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> random-string</span><br><span class="line">  <span class="string">&quot;Returns a random string of specified length&quot;</span></span><br><span class="line">  [length]</span><br><span class="line">  (<span class="name"><span class="builtin-name">apply</span></span> str (<span class="name"><span class="builtin-name">take</span></span> length (<span class="name">repeatedly</span> #(<span class="name">rand-nth</span> letters)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> random-string-list</span><br><span class="line">  [list-length string-length]</span><br><span class="line">  (<span class="name"><span class="builtin-name">doall</span></span> (<span class="name"><span class="builtin-name">take</span></span> list-length (<span class="name">repeatedly</span> (<span class="name"><span class="builtin-name">partial</span></span> random-string string-length)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">def</span></span> orc-names (<span class="name">random-string-list</span> <span class="number">3000</span> <span class="number">7000</span>))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Because <code>map</code> and <code>pmap</code> are lazy, we have to force them to be realized. We don&#x2019;t want the result to be printed to the REPL, though, because that would take forever. The <code>dorun</code> function does just what we need: it realizes the sequence but returns <code>nil</code>:</p>
</blockquote>
<p><code>map</code>&#x548C;<code>pmap</code>&#x662F;&#x60F0;&#x6027;&#x7684;&#xFF0C;&#x5FC5;&#x987B;&#x5F3A;&#x5236;&#x5B83;&#x4EEC;&#x88AB;&#x5B9E;&#x4F8B;&#x5316;&#x3002;&#x4F46;&#x6211;&#x4EEC;&#x4E0D;&#x60F3;&#x8BA9;&#x7ED3;&#x679C;&#x6253;&#x5370;&#x5230;REPL&#xFF0C;&#x56E0;&#x4E3A;&#x82B1;&#x7684;&#x65F6;&#x95F4;&#x592A;&#x957F;&#x4E86;&#x3002;<code>dorun</code>&#x51FD;&#x6570;&#x6B63;&#x597D;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#xFF1A;&#x5B83;&#x5B9E;&#x4F8B;&#x5316;&#x8FD9;&#x4E2A;&#x5E8F;&#x5217;&#xFF0C;&#x4F46;&#x8FD4;&#x56DE;<code>nil</code>:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">time</span></span> (<span class="name"><span class="builtin-name">dorun</span></span> (<span class="name"><span class="builtin-name">map</span></span> clojure.string/lower-case orc-names)))</span><br><span class="line"><span class="comment">; =&gt; &quot;Elapsed time: 270.182 msecs&quot;</span></span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">time</span></span> (<span class="name"><span class="builtin-name">dorun</span></span> (<span class="name">pmap</span> clojure.string/lower-case orc-names)))</span><br><span class="line"><span class="comment">; =&gt; &quot;Elapsed time: 147.562 msecs&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>The serial execution with <code>map</code> took about 1.8 times longer than <code>pmap</code>, and all you had to do was add one extra letter! Your performance may be even better, depending on the number of cores your computer has; this code was run on a dual-core machine.</p>
</blockquote>
<p>&#x4E32;&#x884C;&#x6267;&#x884C;&#x7684;<code>map</code>&#x7528;&#x65F6;&#x5927;&#x7EA6;&#x6BD4;<code>pmap</code>&#x957F;1.8&#x500D;&#xFF0C;&#x800C;&#x4F60;&#x8981;&#x505A;&#x7684;&#x6240;&#x6709;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#x591A;&#x52A0;&#x4E00;&#x4E2A;&#x5B57;&#x6BCD;&#xFF01;&#x4F60;&#x7684;&#x6027;&#x80FD;&#x53EF;&#x80FD;&#x66F4;&#x597D;&#xFF0C;&#x53D6;&#x51B3;&#x4E8E;&#x4F60;&#x8BA1;&#x7B97;&#x673A;&#x7684;&#x5904;&#x7406;&#x5668;&#x4E2A;&#x6570;&#xFF0C;&#x4E0A;&#x9762;&#x662F;&#x53CC;&#x6838;&#x673A;&#x5668;&#x7684;&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x3002;</p>
<blockquote>
<p>You might be wondering why the parallel version didn&#x2019;t take exactly half as long as the serial version. After all, it should take two cores only half as much time as a single core, shouldn&#x2019;t it? The reason is that there&#x2019;s always some overhead involved with creating and coordinating threads. Sometimes, in fact, the time taken by this overhead can dwarf the time of each function application, and <code>pmap</code> can actually take longer than <code>map</code>. Figure 10-3 shows how you can visualize this.</p>
</blockquote>
<p>&#x4F60;&#x53EF;&#x80FD;&#x5947;&#x602A;&#x4E3A;&#x4EC0;&#x4E48;&#x5E76;&#x884C;&#x8FD0;&#x884C;&#x7684;&#x65F6;&#x95F4;&#x4E0D;&#x662F;&#x4E32;&#x884C;&#x7684;&#x6B63;&#x597D;&#x4E00;&#x534A;&#x3002;&#x53CC;&#x6838;&#x53EA;&#x9700;&#x82B1;&#x8D39;&#x5355;&#x6838;&#x4E00;&#x534A;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#xFF0C;&#x5BF9;&#x5417;&#xFF1F;&#x539F;&#x56E0;&#x662F;&#x521B;&#x5EFA;&#x548C;&#x534F;&#x8C03;&#x7EBF;&#x7A0B;&#x603B;&#x4F1A;&#x635F;&#x8017;&#x4E00;&#x4E9B;&#x65F6;&#x95F4;&#x3002;&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;&#x6709;&#x65F6;&#x5019;&#x635F;&#x8017;&#x65F6;&#x95F4;&#x53EF;&#x80FD;&#x6BD4;&#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x95F4;&#x8FD8;&#x957F;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;<code>pmap</code>&#x53EF;&#x80FD;&#x6BD4;<code>map</code>&#x7528;&#x65F6;&#x957F;&#x3002;&#x56FE;10-3&#x5C55;&#x793A;&#x4E86;&#x8FD9;&#x4E2A;&#x60C5;&#x51B5;&#x3002;</p>
<blockquote>
<p>Figure 10-3: Parallelization overhead can dwarf task time, resulting in a performance decrease.</p>
</blockquote>
<p>&#x56FE;10-3: &#x5E76;&#x884C;&#x5316;&#x635F;&#x8017;&#x65F6;&#x95F4;&#x53EF;&#x80FD;&#x8D85;&#x8FC7;&#x4EFB;&#x52A1;&#x65F6;&#x95F4;&#xFF0C;&#x5F15;&#x8D77;&#x6027;&#x80FD;&#x4E0B;&#x964D;&#x3002;</p>
<p><img src="/2016/07/22/clojure-metaphysics/pmap-small-grain.png" alt="pmap"></p>
<blockquote>
<p>We can see this effect at work if we run a function on 20,000 abbreviated orc names, each 300 characters long:</p>
</blockquote>
<p>&#x4E3A;&#x4E86;&#x770B;&#x5230;&#x8FD9;&#x4E2A;&#x6548;&#x5E94;&#xFF0C;&#x6211;&#x4EEC;&#x628A;&#x5E8F;&#x5217;&#x4E2A;&#x6570;&#x6539;&#x6210;&#x4E24;&#x4E07;&#x4E2A;&#xFF0C;&#x6BCF;&#x4E2A;&#x540D;&#x5B57;&#x7684;&#x957F;&#x5EA6;&#x6539;&#x6210;300:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> orc-name-abbrevs (<span class="name">random-string-list</span> <span class="number">20000</span> <span class="number">300</span>))</span><br><span class="line">(<span class="name"><span class="builtin-name">time</span></span> (<span class="name"><span class="builtin-name">dorun</span></span> (<span class="name"><span class="builtin-name">map</span></span> clojure.string/lower-case orc-name-abbrevs)))</span><br><span class="line"><span class="comment">; =&gt; &quot;Elapsed time: 78.23 msecs&quot;</span></span><br><span class="line">(<span class="name"><span class="builtin-name">time</span></span> (<span class="name"><span class="builtin-name">dorun</span></span> (<span class="name">pmap</span> clojure.string/lower-case orc-name-abbrevs)))</span><br><span class="line"><span class="comment">; =&gt; &quot;Elapsed time: 124.727 msecs&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Now <code>pmap</code> actually takes 1.6 times <em>longer</em>.</p>
</blockquote>
<p>&#x73B0;&#x5728;<code>pmap</code>&#x7684;&#x7528;&#x65F6;&#x662F;<code>map</code>&#x7684;1.6&#x500D;&#x3002;</p>
<blockquote>
<p>The solution to this problem is to increase the grain size, or the amount of work done by each parallelized task. In this case, the task is to apply the mapping function to one element of the collection. Grain size isn&#x2019;t measured in any standard unit, but you&#x2019;d say that the grain size of <code>pmap</code> is one by default. Increasing the grain size to two would mean that you&#x2019;re applying the mapping function to two elements instead of one, so the thread that the task is on is doing more work. Figure 10-4 shows how an increased grain size can improve performance.</p>
</blockquote>
<p>&#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#x662F;&#x52A0;&#x5927;&#x9897;&#x7C92;&#x5EA6;&#xFF0C;&#x5373;&#x6BCF;&#x6B21;&#x5E76;&#x884C;&#x6267;&#x884C;&#x7684;&#x4EFB;&#x52A1;&#x6570;&#x3002;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x91CC;&#xFF0C;&#x6BCF;&#x6B21;&#x5E76;&#x884C;&#x6267;&#x884C;&#x7684;&#x4EFB;&#x52A1;&#x662F;&#x5BF9;&#x96C6;&#x5408;&#x7684;&#x4E00;&#x4E2A;&#x6210;&#x5458;&#x8C03;&#x7528;&#x6620;&#x5C04;&#x51FD;&#x6570;&#x3002;&#x9ED8;&#x8BA4;&#x7684;&#x9897;&#x7C92;&#x5EA6;&#x662F;1&#xFF0C;&#x5982;&#x679C;&#x589E;&#x52A0;&#x5230;2&#xFF0C;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x91CC;&#x5C31;&#x4F1A;&#x5BF9;&#x4E24;&#x4E2A;&#x6210;&#x5458;&#x6267;&#x884C;&#x6620;&#x5C04;&#x51FD;&#x6570;&#x3002;&#x56FE;10-4&#x6F14;&#x793A;&#x4E86;&#x589E;&#x52A0;&#x9897;&#x7C92;&#x5EA6;&#x80FD;&#x63D0;&#x5347;&#x6027;&#x80FD;&#x3002;</p>
<blockquote>
<p>Figure 10-4: Visualizing grain size in relation to parallelization overhead</p>
</blockquote>
<p>&#x56FE;10-4: &#x9897;&#x7C92;&#x5EA6;&#x4E0E;&#x5E76;&#x884C;&#x635F;&#x8017;&#x7684;&#x5173;&#x7CFB;</p>
<p><img src="/2016/07/22/clojure-metaphysics/ppmap.png" alt="ppmap"></p>
<blockquote>
<p>To actually accomplish this in Clojure, you can increase the grain size by making each thread apply <code>clojure.string/lower-case</code> to multiple elements instead of just one, using <code>partition-all</code>. <code>partition-all</code> takes a seq and divides it into seqs of the specified length:</p>
</blockquote>
<p>&#x53EF;&#x4EE5;&#x7528;<code>partition-all</code>&#x628A;&#x5E8F;&#x5217;&#x5206;&#x6210;&#x591A;&#x4E2A;&#x6307;&#x5B9A;&#x957F;&#x5EA6;&#x7684;&#x5E8F;&#x5217;&#xFF0C;&#x7528;&#x6765;&#x589E;&#x52A0;&#x9897;&#x7C92;&#x5EA6;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> numbers [<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span>])</span><br><span class="line">(<span class="name">partition-all</span> <span class="number">3</span> numbers)</span><br><span class="line"><span class="comment">; =&gt; ((1 2 3) (4 5 6) (7 8 9) (10))</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Now suppose you started out with code that looked like this:</p>
</blockquote>
<p>&#x5047;&#x8BBE;&#x5F00;&#x59CB;&#x4EE3;&#x7801;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">pmap</span> inc numbers)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In this case, the grain size is one because each thread applies <code>inc</code> to an element.</p>
</blockquote>
<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x9897;&#x7C92;&#x5EA6;&#x662F;1&#xFF0C;&#x56E0;&#x4E3A;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x5BF9;&#x4E00;&#x4E2A;&#x6210;&#x5458;&#x8C03;&#x7528;<code>inc</code>&#x3002;</p>
<blockquote>
<p>Now suppose you changed the code to this:</p>
</blockquote>
<p>&#x73B0;&#x5728;&#x628A;&#x4EE3;&#x7801;&#x6539;&#x6210;&#x8FD9;&#x6837;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">pmap</span> (<span class="name"><span class="builtin-name">fn</span></span> [number-group] (<span class="name"><span class="builtin-name">doall</span></span> (<span class="name"><span class="builtin-name">map</span></span> inc number-group)))</span><br><span class="line">      (<span class="name">partition-all</span> <span class="number">3</span> numbers))</span><br><span class="line"><span class="comment">; =&gt; ((2 3 4) (5 6 7) (8 9 10) (11))</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>There are a few things going on here. First, you&#x2019;ve now increased the grain size to three because each thread now executes three applications of the <code>inc</code> function instead of one. Second, notice that you have to call <code>doall</code> within the mapping function. This forces the lazy sequence returned by <code>(map inc number-group)</code> to be realized within the thread. Third, we need to ungroup the result. Here&#x2019;s how we can do that:</p>
</blockquote>
<p>&#x8FD9;&#x91CC;&#x53D1;&#x751F;&#x4E86;&#x51E0;&#x4EF6;&#x4E8B;&#x3002;&#x9996;&#x5148;&#xFF0C;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x6267;&#x884C;3&#x6B21;<code>inc</code>&#x8C03;&#x7528;&#xFF0C;&#x56E0;&#x800C;&#x9897;&#x7C92;&#x5EA6;&#x589E;&#x52A0;&#x5230;3&#xFF0C;&#x7136;&#x540E;&#xFF0C;&#x5FC5;&#x987B;&#x8C03;&#x7528;<code>doall</code>,&#x8FD9;&#x5F3A;&#x5236;&#x8FDB;&#x7A0B;&#x5185;<code>(map inc number-group)</code>&#x8FD4;&#x56DE;&#x7684;&#x60F0;&#x6027;&#x5E8F;&#x5217;&#x5B9E;&#x4F8B;&#x5316;&#x3002;&#x7B2C;&#x4E09;&#xFF0C;&#x9700;&#x8981;&#x5408;&#x5E76;&#x7ED3;&#x679C;&#x3002;&#x53EF;&#x4EE5;&#x8FD9;&#x4E48;&#x505A;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">apply</span></span> concat</span><br><span class="line">       (<span class="name">pmap</span> (<span class="name"><span class="builtin-name">fn</span></span> [number-group] (<span class="name"><span class="builtin-name">doall</span></span> (<span class="name"><span class="builtin-name">map</span></span> inc number-group)))</span><br><span class="line">             (<span class="name">partition-all</span> <span class="number">3</span> numbers)))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Using this technique, we can increase the grain size of the orc name lowercase-ification so each thread runs <code>clojure.string/lower-case</code> on 1,000 names instead of just one:</p>
</blockquote>
<p>&#x7528;&#x8FD9;&#x4E2A;&#x6280;&#x5DE7;&#xFF0C;&#x628A;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x9897;&#x7C92;&#x5EA6;&#x589E;&#x52A0;&#x5230;1000&#xFF0C;&#x800C;&#x4E0D;&#x662F;1:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">time</span></span></span><br><span class="line"> (<span class="name"><span class="builtin-name">dorun</span></span></span><br><span class="line">  (<span class="name"><span class="builtin-name">apply</span></span> concat</span><br><span class="line">         (<span class="name">pmap</span> (<span class="name"><span class="builtin-name">fn</span></span> [name] (<span class="name"><span class="builtin-name">doall</span></span> (<span class="name"><span class="builtin-name">map</span></span> clojure.string/lower-case name)))</span><br><span class="line">               (<span class="name">partition-all</span> <span class="number">1000</span> orc-name-abbrevs)))))</span><br><span class="line"><span class="comment">; =&gt; &quot;Elapsed time: 44.677 msecs&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Once again the parallel version takes nearly half the time. Just for fun, we can generalize this technique into a function called <code>ppmap</code>, for <em>partitioned pmap</em>. It can receive more than one collection, just like <code>map</code>:</p>
</blockquote>
<p>&#x5E76;&#x884C;&#x7684;&#x7248;&#x672C;&#x53C8;&#x4E00;&#x6B21;&#x53EA;&#x82B1;&#x4E86;&#x51E0;&#x4E4E;&#x4E00;&#x534A;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x53EF;&#x4EE5;&#x628A;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x901A;&#x7528;&#x5316;&#x6210;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x53EB;<code>ppmap</code>,&#x4EE3;&#x8868;<em>partitioned pmap</em>&#x3002;&#x5B83;&#x80FD;&#x63A5;&#x53D7;&#x4E0D;&#x6B62;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#xFF0C;&#x50CF;<code>map</code>&#x4E00;&#x6837;&#xFF1A;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> ppmap</span><br><span class="line">  <span class="string">&quot;Partitioned pmap, for grouping map ops together to make parallel</span><br><span class="line">  overhead worthwhile&quot;</span></span><br><span class="line">  [grain-size f &amp; colls]</span><br><span class="line">  (<span class="name"><span class="builtin-name">apply</span></span> concat</span><br><span class="line">   (<span class="name"><span class="builtin-name">apply</span></span> pmap</span><br><span class="line">          (<span class="name"><span class="builtin-name">fn</span></span> [&amp; pgroups] (<span class="name"><span class="builtin-name">doall</span></span> (<span class="name"><span class="builtin-name">apply</span></span> map f pgroups)))</span><br><span class="line">          (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">partial</span></span> partition-all grain-size) colls))))</span><br><span class="line">(<span class="name"><span class="builtin-name">time</span></span> (<span class="name"><span class="builtin-name">dorun</span></span> (<span class="name">ppmap</span> <span class="number">1000</span> clojure.string/lower-case orc-name-abbrevs)))</span><br><span class="line"><span class="comment">; =&gt; &quot;Elapsed time: 44.902 msecs&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>I don&#x2019;t know about you, but I think this stuff is just fun. For even more fun, check out the clojure.core.reducers library (<a href="http://clojure.org/reference/reducers" target="_blank" rel="external">http://clojure.org/reference/reducers</a>). This library provides alternative implementations of seq functions like <code>map</code> and <code>reduce</code> that are usually speedier than their cousins in <code>clojure.core</code>. The trade-off is that they&#x2019;re not lazy. Overall, the clojure.core.reducers library offers a more refined and composable way of creating and using functions like <code>ppmap</code>.</p>
</blockquote>
<p>&#x6211;&#x8BA4;&#x4E3A;&#x8FD9;&#x5F88;&#x6709;&#x8DA3;&#x3002;&#x8FD8;&#x6709;&#x66F4;&#x6709;&#x8DA3;&#x7684;&#xFF0C;&#x53BB;&#x770B;&#x770B;<a href="http://clojure.org/reference/reducers" target="_blank" rel="external">clojure.core.reducers</a>&#x5E93;&#x3002;&#x8FD9;&#x4E2A;&#x5E93;&#x63D0;&#x4F9B;&#x4E86;&#x5E8F;&#x5217;&#x51FD;&#x6570;&#xFF0C;&#x5982;<code>map</code>,<code>reduce</code>&#x7684;&#x53E6;&#x4E00;&#x79CD;&#x5B9E;&#x73B0;&#xFF0C;&#x901A;&#x5E38;&#x6BD4;<code>clojure.core</code>&#x91CC;&#x7684;&#x51FD;&#x6570;&#x901F;&#x5EA6;&#x66F4;&#x5FEB;&#x3002;&#x4EE3;&#x4EF7;&#x5C31;&#x662F;&#x5B83;&#x4EEC;&#x4E0D;&#x662F;&#x60F0;&#x6027;&#x7684;&#x3002;&#x603B;&#x4F53;&#x4E0A;&#x8BF4;&#xFF0C;clojure.core.reducers&#x5E93;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#xFF0C;&#x7528;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x50CF;<code>ppmap</code>&#x90A3;&#x6837;&#x521B;&#x5EFA;&#x548C;&#x4F7F;&#x7528;&#x51FD;&#x6570;&#xFF0C;&#x4F46;&#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x66F4;&#x52A0;&#x7CBE;&#x81F4;&#x5E76;&#x4E14;&#x53EF;&#x7EC4;&#x5408;&#x3002;</p>
<blockquote>
<p>Summary</p>
</blockquote>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><blockquote>
<p>In this chapter, you learned more than most people know about safely handling concurrent tasks. You learned about the metaphysics that underlies Clojure&#x2019;s reference types. In Clojure metaphysics, state is the value of an identity at a point in time, and identity is a handy way to refer to a succession of values produced by some process. Values are atomic in the same way numbers are atomic. They&#x2019;re immutable, and this makes them safe to work with concurrently; you don&#x2019;t have to worry about other threads changing them while you&#x2019;re using them.</p>
</blockquote>
<p>&#x8FD9;&#x7AE0;&#x4F60;&#x5B66;&#x4E60;&#x4E86;&#x5F88;&#x591A;&#x5B89;&#x5168;&#x5904;&#x7406;&#x5E76;&#x53D1;&#x4EFB;&#x52A1;&#x7684;&#x77E5;&#x8BC6;&#x3002;&#x4E86;&#x89E3;&#x4E86;Clojure&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x540E;&#x9762;&#x7684;&#x54F2;&#x5B66;&#x4F53;&#x7CFB;&#x3002;Clojure&#x54F2;&#x5B66;&#x4F53;&#x7CFB;&#x91CC;&#xFF0C;&#x72B6;&#x6001;&#x662F;&#x8EAB;&#x4EFD;&#x67D0;&#x4E00;&#x65F6;&#x95F4;&#x70B9;&#x7684;&#x503C;&#xFF0C;&#x8EAB;&#x4EFD;&#x6307;&#x67D0;&#x4E2A;&#x8FC7;&#x7A0B;&#x4EA7;&#x751F;&#x7684;&#x8FDE;&#x7EED;&#x503C;&#x3002;&#x503C;&#x540C;&#x6570;&#x5B57;&#x4E00;&#x6837;&#x662F;&#x4E0D;&#x53EF;&#x5206;&#x7684;&#x3002;&#x503C;&#x662F;&#x4E0D;&#x53EF;&#x53D8;&#x7684;&#xFF0C;&#x8FD9;&#x4F7F;&#x5E76;&#x53D1;&#x4F7F;&#x7528;&#x5B83;&#x4EEC;&#x662F;&#x5B89;&#x5168;&#x7684;&#xFF0C;&#x4F7F;&#x7528;&#x65F6;&#x4E0D;&#x7528;&#x62C5;&#x5FC3;&#x5B83;&#x4EEC;&#x88AB;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x6539;&#x53D8;&#x3002;</p>
<blockquote>
<p>The atom reference type allows you to create an identity that you can safely update to refer to new values using <code>swap!</code> and <code>reset!</code>. The ref reference type is handy when you want to update more than one identity using transaction semantics, and you update it with <code>alter</code> and <code>commute</code>.</p>
</blockquote>
<p>&#x7528;&#x539F;&#x5B50;&#x5F15;&#x7528;&#x7C7B;&#x578B;&#x53EF;&#x4EE5;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x8EAB;&#x4EFD;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;<code>swap!</code>&#x548C;<code>reset!</code>&#x53EF;&#x4EE5;&#x5B89;&#x5168;&#x5730;&#x66F4;&#x65B0;&#x539F;&#x5B50;&#xFF0C;&#x4F7F;&#x5B83;&#x6307;&#x5411;&#x65B0;&#x503C;&#x3002;&#x5F53;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x4E8B;&#x52A1;&#x8BED;&#x610F;&#x66F4;&#x65B0;&#x8D85;&#x8FC7;&#x4E00;&#x4E2A;&#x8EAB;&#x4EFD;&#x65F6;&#xFF0C;&#x4F7F;&#x7528;&#x5F15;&#x7528;&#x975E;&#x5E38;&#x65B9;&#x4FBF;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;<code>alter</code>&#x548C;<code>commute</code>&#x66F4;&#x65B0;&#x5F15;&#x7528;&#x3002;</p>
<blockquote>
<p>Additionally, you learned how to increase performance by performing stateless data transformations with <code>pmap</code> and the core.reducers library. Woohoo!</p>
</blockquote>
<p>&#x53E6;&#x5916;&#xFF0C;&#x8FD8;&#x5B66;&#x4E60;&#x4E86;&#x7528;<code>pmap</code>&#x548C;core.reducers&#x5E93;&#x6267;&#x884C;&#x65E0;&#x72B6;&#x6001;&#x7684;&#x6570;&#x636E;&#x8F6C;&#x6362;&#x4EE5;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#x3002;&#x54C7;&#xFF01;</p>
<blockquote>
<p>Exercises</p>
</blockquote>
<h2 id="&#x7EC3;&#x4E60;"><a href="#&#x7EC3;&#x4E60;" class="headerlink" title="&#x7EC3;&#x4E60;"></a>&#x7EC3;&#x4E60;</h2><blockquote>
<ol>
<li><p>Create an atom with the initial value 0, use swap! to increment it a couple of times, and then dereference it.</p>
</li>
<li><p>Create a function that uses futures to parallelize the task of downloading random quotes from <a href="http://www.braveclojure.com/random-quote" target="_blank" rel="external">http://www.braveclojure.com/random-quote</a> using (slurp &#x201C;<a href="http://www.braveclojure.com/random-quote" target="_blank" rel="external">http://www.braveclojure.com/random-quote</a>&#x201C;). The futures should update an atom that refers to a total word count for all quotes. The function will take the number of quotes to download as an argument and return the atom&#x2019;s final value. Keep in mind that you&#x2019;ll need to ensure that all futures have finished before returning the atom&#x2019;s final value. Here&#x2019;s how you would call it and an example result:</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">quote-word-count</span> <span class="number">5</span>)</span><br><span class="line"><span class="comment">; =&gt; {&quot;ochre&quot; 8, &quot;smoothie&quot; 2}</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Create representations of two characters in a game. The first character has 15 hit points out of a total of 40. The second character has a healing potion in his inventory. Use refs and transactions to model the consumption of the healing potion and the first character healing.</p>
</li>
</ol>
</blockquote>
<hr>
<p>&#x8BD1;&#x6587;&#x7ED3;&#x675F;&#x3002;</p>

      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Clojure/" rel="tag">#Clojure</a>
          
            <a href="/tags/Clojure-For-The-Branve-And-True/" rel="tag">#Clojure For The Branve And True</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/15/braveclojure-concurrency/" rel="next" title="【译】第九章:并发与并行编程">
                <i class="fa fa-chevron-left"></i> 【译】第九章:并发与并行编程
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/29/brave-clojure-organization/" rel="prev" title="【译】第六章:组织项目:图书管理员传奇">
                【译】第六章:组织项目:图书管理员传奇 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://s.gravatar.com/avatar/954a8b1f4c32dbb5a11399ae5e236a5f?s=80"
               alt="胡军" />
          <p class="site-author-name" itemprop="name">胡军</p>
          <p class="site-description motion-element" itemprop="description">immutable values from past</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">21</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>
          
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/morrxy" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#面向对象哲学体系"><span class="nav-number">1.</span> <span class="nav-text">面向对象哲学体系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Clojure哲学体系"><span class="nav-number">2.</span> <span class="nav-text">Clojure哲学体系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原子"><span class="nav-number">3.</span> <span class="nav-text">原子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#监视与校验"><span class="nav-number">4.</span> <span class="nav-text">监视与校验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#监视"><span class="nav-number">4.1.</span> <span class="nav-text">监视</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证"><span class="nav-number">4.2.</span> <span class="nav-text">验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建模袜子转换"><span class="nav-number">4.3.</span> <span class="nav-text">建模袜子转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#交换"><span class="nav-number">4.4.</span> <span class="nav-text">交换</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#变量"><span class="nav-number">5.</span> <span class="nav-text">变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#动态绑定"><span class="nav-number">5.1.</span> <span class="nav-text">动态绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建和绑定动态变量"><span class="nav-number">5.1.1.</span> <span class="nav-text">创建和绑定动态变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动态变量使用"><span class="nav-number">5.1.2.</span> <span class="nav-text">动态变量使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#每线程绑定"><span class="nav-number">5.1.3.</span> <span class="nav-text">每线程绑定</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改根变量"><span class="nav-number">5.2.</span> <span class="nav-text">修改根变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#无状态并发与用pmap并行"><span class="nav-number">6.</span> <span class="nav-text">无状态并发与用pmap并行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#练习"><span class="nav-number">8.</span> <span class="nav-text">练习</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">胡军</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.scheme !== 'Pisces' && (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always')) {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'morrxy';
      var disqus_identifier = '2016/07/22/clojure-metaphysics/';
      var disqus_title = '【译】第十章:Clojure哲学体系:Atom, Refs, Vars与抱抱僵尸';
      var disqus_url = 'http://yoursite.com/2016/07/22/clojure-metaphysics/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  

  


</body>
</html>
